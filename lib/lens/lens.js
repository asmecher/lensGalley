!function o(i,r,s){function a(e,t){if(!r[e]){if(!i[e]){var n="function"==typeof require&&require;if(!t&&n)return n(e,!0);if(c)return c(e,!0);throw(n=new Error("Cannot find module '"+e+"'")).code="MODULE_NOT_FOUND",n}n=r[e]={exports:{}},i[e][0].call(n.exports,function(t){return a(i[e][1][t]||t)},n,n.exports,o,i,r,s)}return r[e].exports}for(var c="function"==typeof require&&require,t=0;t<s.length;t++)a(s[t]);return a}({1:[function(t,e,n){window.Lens=t("./lens")},{"./lens":2}],2:[function(t,e,n){"use strict";var o=t("lens/reader"),i=o.getDefaultPanels(),r=t("lens/converter"),s=t("lens/converter/elife_converter"),t=function(t){o.call(this,t)};(t.Prototype=function(){this.getConverters=function(t){return[new s(t),new r(t)]},this.getPanels=function(){return i.slice(0)}}).prototype=o.prototype,(t.prototype=new t.Prototype).constructor=t,e.exports=t},{"lens/converter":129,"lens/converter/elife_converter":128,"lens/reader":133}],3:[function(t,e,n){},{}],4:[function(t,e,n){"use strict";var a=t("underscore"),o=t("../substance/util"),i=t("../substance/document"),c=function(t){t=c.prepareOptions(t),i.call(this,t),this.bySourceId=this.addIndex("by_source_id",{property:"source_id"}),this.nodeTypes=t.nodeTypes,void 0===t.seed&&(this.create({id:"document",type:"document",guid:t.id,creator:t.creator,created_at:t.created_at,views:c.views,title:"",abstract:"",authors:[]}),a.each(c.views,function(t){this.create({id:t,type:"view",nodes:[]})},this))};c.Prototype=function(){this.fromSnapshot=function(t,e){return c.fromSnapshot(t,e)},this.getNodeBySourceId=function(t){t=this.bySourceId.get(t);return t[Object.keys(t)[0]]},this.getHeadings=function(){return a.filter(this.get("content").getNodes(),function(t){return"heading"===t.type})},this.getTocNodes=function(){return a.filter(this.get("content").getNodes(),function(t){return t.includeInToc()})}},c.prepareOptions=function(t){return(t=t||{}).nodeTypes=a.extend(c.nodeTypes,t.nodeTypes),t.schema=c.getSchema(t.nodeTypes),t},c.getSchema=function(t){var n=o.deepclone(i.schema);return n.id="lens-article",n.version="2.0.0",a.each(t,function(t,e){n.types[e]=t.Model.type}),n},c.fromSnapshot=function(t,e){return(e=e||{}).seed=t,new c(e)},c.views=["content","figures","citations","definitions","info"],c.nodeTypes=t("./nodes"),c.ViewFactory=t("./view_factory"),c.ResourceView=t("./resource_view");var u={id:"lens_article",nodes:{document:{type:"document",id:"document",views:["content"],title:"The Anatomy of a Lens Article",authors:["contributor_1","contributor_2","contributor_3"],guid:"lens_article"},content:{type:"view",id:"content",nodes:["cover"]},cover:{id:"cover",type:"cover"},contributor_1:{id:"contributor_1",type:"contributor",name:"Michael Aufreiter"},contributor_2:{id:"contributor_2",type:"contributor",name:"Ivan Grubisic"},contributor_3:{id:"contributor_3",type:"contributor",name:"Rebecca Close"}}};c.describe=function(){var r=new c({seed:u}),s=0;return a.each(c.nodeTypes,function(t){var e="heading_"+(t=t.Model).type.id;r.create({id:e,type:"heading",content:t.description.name,level:1});var n=t.description.remarks.join(" "),o="text_"+t.type.id+"_intro";r.create({id:o,type:"text",content:n}),r.show("content",[e,o],-1),r.create({id:e+"_properties",type:"text",content:t.description.name+" uses the following properties:"}),r.show("content",[e+"_properties"],-1);var i=[];a.each(t.description.properties,function(t,e){var n="text_"+ ++s;r.create({id:n,type:"text",content:e+": "+t}),r.create({id:s+"_annotation",type:"code",path:[n,"content"],range:[0,e.length]}),i.push(n)}),r.create({id:e+"_property_list",type:"list",items:i,ordered:!1}),r.show("content",[e+"_property_list"],-1),r.create({id:e+"_example",type:"text",content:"Here's an example:"}),r.create({id:e+"_example_codeblock",type:"codeblock",content:JSON.stringify(t.example,null,"  ")}),r.show("content",[e+"_example",e+"_example_codeblock"],-1)}),r},c.Prototype.prototype=i.prototype,c.prototype=new c.Prototype,c.prototype.constructor=c,Object.defineProperties(c.prototype,{id:{get:function(){return this.get("document").guid},set:function(t){this.get("document").guid=t}},creator:{get:function(){return this.get("document").creator},set:function(t){this.get("document").creator=t}},created_at:{get:function(){return this.get("document").created_at},set:function(t){this.get("document").created_at=t}},title:{get:function(){return this.get("document").title},set:function(t){this.get("document").title=t}},abstract:{get:function(){return this.get("document").abstract},set:function(t){this.get("document").abstract=t}},on_behalf_of:{get:function(){return this.get("document").on_behalf_of},set:function(t){this.get("document").on_behalf_of=t}},authors:{get:function(){var t=this.get("document");return t.authors?a.map(t.authors,function(t){return this.get(t)},this):""},set:function(t){this.get("document").authors=a.clone(t)}},views:{get:function(){return this.get("document").views.slice(0)}}}),e.exports=c},{"../substance/document":173,"../substance/util":182,"./nodes":79,"./resource_view":126,"./view_factory":127,underscore:185}],5:[function(t,e,n){var o={1:"January",2:"February",3:"March",4:"April",5:"May",6:"June",7:"July",8:"August",9:"September",10:"October",11:"November",12:"December"},i={formatDate:function(t){var e=t.split("-");if(3<=e.length)return new Date(e[0],e[1]-1,e[2]).toDateString().slice(4,16).replace(/\b0+/g,"");if(2!==e.length)return n;var t=e[1].replace(/^0/,""),n=e[0];return o[t]+" "+n}};e.exports=i},{}],6:[function(t,e,n){"use strict";t=t("./article");e.exports=t},{"./article":4}],7:[function(t,e,n){"use strict";var o=t("../../../substance/document"),t=function(t,e){o.Node.call(this,t,e)};t.type={id:"affiliation",parent:"content",properties:{source_id:"string",city:"string",country:"string",department:"string",institution:"string",label:"string",specific_use:"string"}},t.description={name:"Affiliation",description:"Person affiliation",remarks:["Name of a institution or organization, such as a university or corporation, that is the affiliation for a contributor such as an author or an editor."],properties:{institution:"Name of institution",department:"Department name",country:"Country where institution is located",city:"City of institution",label:"Affilation label. Usually a number counting up"}},t.example={id:"affiliation_1",source_id:"aff1",city:"Jena",country:"Germany",department:"Department of Molecular Ecology",institution:"Max Planck Institute for Chemical Ecology",label:"1",type:"affiliation"},(t.Prototype=function(){}).prototype=o.Node.prototype,(t.prototype=new t.Prototype).constructor=t,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173}],8:[function(t,e,n){"use strict";e.exports={Model:t("./affiliation")}},{"./affiliation":7}],9:[function(t,e,n){var o=t("../../../substance/document"),t=function(t,e){o.Node.call(this,t,e)};t.type={id:"annotation",properties:{path:["array","string"],range:["array","number"]}},(t.Prototype=function(){this.getLevel=function(){return this.constructor.fragmentation}}).prototype=o.Node.prototype,((t.prototype=new t.Prototype).constructor=t).NEVER=1,t.OK=2,t.fragmentation=t.DONT_CARE=3,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173}],10:[function(t,e,n){"use strict";function o(t,e){this.node=t,this.viewFactory=e,this.el=this.createElement(),this.el.dataset.id=t.id,this.$el=$(this.el),this.setClasses()}o.Prototype=function(){this.createElement=function(){return document.createElement("span")},this.setClasses=function(){this.$el.addClass("annotation").addClass(this.node.type)},this.render=function(){return this}},o.prototype=new o.Prototype,e.exports=o},{}],11:[function(t,e,n){e.exports={Model:t("./annotation.js"),View:t("./annotation_view.js")}},{"./annotation.js":9,"./annotation_view.js":10}],12:[function(t,e,n){var o=t("../../../substance/document"),i=t("../annotation/annotation"),t=function(t,e){i.call(this,t,e)};t.type={id:"emphasis",parent:"annotation",properties:{style:"string"}},(t.Prototype=function(){}).prototype=i.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=i.DONT_CARE,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,"../annotation/annotation":9}],13:[function(t,e,n){var o=t("../annotation").View,t=function(t){o.call(this,t)};(t.Prototype=function(){this.setClasses=function(){o.prototype.setClasses.call(this),this.$el.addClass(this.node.style)}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../annotation":11}],14:[function(t,e,n){e.exports={Model:t("./author_callout.js"),View:t("./author_callout_view.js")}},{"./author_callout.js":12,"./author_callout_view.js":13}],15:[function(t,e,n){"use strict";var o=t("../../../substance/document"),i=o.Composite,t=function(t,e){i.call(this,t,e)};t.type={id:"box",parent:"content",properties:{source_id:"string",label:"string",children:["array","paragraph"]}},t.description={name:"Box",remarks:["A box type."],properties:{label:"string",children:"0..n Paragraph nodes"}},t.example={id:"box_1",type:"box",label:"Box 1",children:["paragraph_1","paragraph_2"]},(t.Prototype=function(){this.getChildrenIds=function(){return this.properties.children}}).prototype=i.prototype,(t.prototype=new t.Prototype).constructor=t,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173}],16:[function(t,e,n){"use strict";var o=t("../node").View,i=t("../composite").View,r=t("../../../substance/application").$$,t=function(t,e){i.call(this,t,e)};(t.Prototype=function(){this.render=function(){var t;return o.prototype.render.call(this),this.node.label&&(t=r(".label",{text:this.node.label}),this.content.appendChild(t)),this.renderChildren(),this.el.appendChild(this.content),this}}).prototype=i.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../../substance/application":160,"../composite":32,"../node":91}],17:[function(t,e,n){"use strict";e.exports={Model:t("./box"),View:t("./box_view")}},{"./box":15,"./box_view":16}],18:[function(t,e,n){"use strict";var o=t("../../../substance/document"),t=function(t,e){o.Composite.call(this,t,e)};t.type={id:"caption",parent:"content",properties:{source_id:"string",title:"paragraph",children:["array","paragraph"]}},t.description={name:"Caption",remarks:["Container element for the textual description that is associated with a Figure, Table, Video node etc.","This is the title for the figure or the description of the figure that prints or displays with the figure."],properties:{title:"Caption title (optional)",children:"0..n Paragraph nodes"}},t.example={id:"caption_1",children:["paragraph_1","paragraph_2"]},(t.Prototype=function(){this.getChildrenIds=function(){return this.properties.children||[]},this.hasTitle=function(){return!!this.properties.title},this.getTitle=function(){if(this.properties.title)return this.document.get(this.properties.title)}}).prototype=o.Composite.prototype,(t.prototype=new t.Prototype).constructor=t,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173}],19:[function(t,e,n){"use strict";var o=t("../composite").View,i=t("../../../substance/application").$$,t=function(t,e){o.call(this,t,e)};(t.Prototype=function(){this.render=function(){var t;return this.content=i("div.content"),this.node.getTitle()&&((t=this.createChildView(this.node.title).render().el).classList.add("caption-title"),this.content.appendChild(t)),this.renderChildren(),this.el.appendChild(this.content),this}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../../substance/application":160,"../composite":32}],20:[function(t,e,n){"use strict";e.exports={Model:t("./caption"),View:t("./caption_view")}},{"./caption":18,"./caption_view":19}],21:[function(t,e,n){var o=t("underscore"),i=t("../../../substance/document"),t=function(t,e){i.Node.call(this,t,e)};t.type={id:"article_citation",parent:"content",properties:{source_id:"string",title:"string",label:"string",authors:["array","string"],doi:"string",source:"string",volume:"string",citation_type:"string",publisher_name:"string",publisher_location:"string",fpage:"string",lpage:"string",year:"string",comment:"string",citation_urls:["array","object"],source_formats:["array","object"]}},t.description={name:"Citation",remarks:["A journal citation.","This element can be used to describe all kinds of citations."],properties:{title:"The article's title",label:"Optional label (could be a number for instance)",doi:"DOI reference",source:"Usually the journal name",volume:"Issue number",citation_type:"Citation Type",publisher_name:"Publisher Name",publisher_location:"Publisher Location",fpage:"First page",lpage:"Last page",year:"The year of publication",comment:"Author comment.",citation_urls:"A list of links for accessing the article on the web"}},t.example={id:"article_nature08160",type:"article_citation",label:"5",title:"The genome of the blood fluke Schistosoma mansoni",authors:["M Berriman","BJ Haas","PT LoVerde"],citation_type:"Journal Article",doi:"http://dx.doi.org/10.1038/nature08160",source:"Nature",volume:"460",fpage:"352",lpage:"8",year:"1984",comment:"This is a comment.",citation_urls:[{name:"PubMed",url:"https://www.ncbi.nlm.nih.gov/pubmed/19606141"}]},(t.Prototype=function(){this.urls=function(){return 0<this.properties.citation_urls.length?this.properties.citation_urls:[this.properties.doi]},this.getHeader=function(){return o.compact([this.properties.label,this.properties.citation_type||"Reference"]).join(" - ")}}).prototype=i.Node.prototype,(t.prototype=new t.Prototype).constructor=t,i.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,underscore:185}],22:[function(t,e,n){"use strict";var c=t("underscore"),u=t("../../../substance/application").$$,o=t("../node").View,i=t("../../resource_view"),t=function(t,e,n){o.apply(this,arguments),i.call(this,n)};(t.Prototype=function(){c.extend(this,i.prototype),this.renderBody=function(){var t=document.createDocumentFragment(),e=this.node,n=this.createTextPropertyView([e.id,"title"],{classes:"title"});t.appendChild(n.render().el),t.appendChild(u(".authors",{html:e.authors.join(", ")}));var o="",i="",r="",s="";e.source&&""===e.volume?i=e.source:e.source&&e.volume&&(i=[e.source,e.volume].join(", ")),e.fpage&&e.lpage&&(r=[e.fpage,e.lpage].join("-"));var a,n=[];e.publisher_name&&e.publisher_location&&(n.push(e.publisher_name),n.push(e.publisher_location)),e.year&&n.push(e.year),s=n.join(", "),(o=i)&&(r||s)&&(o+=": "),r&&s?o+=[r,s].join(", "):(o+=r,o+=s),t.appendChild(u(".source",{html:o})),e.comment&&(o=this.createTextView({path:[e.id,"comment"],classes:"comment"}),t.appendChild(o.render().el)),e.doi&&t.appendChild(u(".doi",{children:[u("b",{text:"DOI: "}),u("a",{href:e.doi,target:"_new",text:e.doi})]})),0<e.citation_urls.length&&(a=u(".citation-urls"),c.each(e.citation_urls,function(t){a.appendChild(u("a.url",{href:t.url,text:t.name,target:"_blank"}))}),t.appendChild(a)),this.content.appendChild(t)}}).prototype=o.prototype,(t.prototype=new t.Prototype).constructor=t,e.exports=t},{"../../../substance/application":160,"../../resource_view":126,"../node":91,underscore:185}],23:[function(t,e,n){"use strict";e.exports={Model:t("./citation"),View:t("./citation_view")}},{"./citation":21,"./citation_view":22}],24:[function(t,e,n){var o=t("../../../substance/document"),i=t("../annotation/annotation"),r=t("../resource_reference/resource_reference"),t=function(t,e){r.call(this,t,e)};t.type={id:"citation_reference",parent:"resource_reference",properties:{target:"citation"}},(t.Prototype=function(){}).prototype=r.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=i.NEVER,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,"../annotation/annotation":9,"../resource_reference/resource_reference":104}],25:[function(t,e,n){e.exports={Model:t("./citation_reference.js"),View:t("../resource_reference/resource_reference_view.js")}},{"../resource_reference/resource_reference_view.js":105,"./citation_reference.js":24}],26:[function(t,e,n){var o=t("../annotation/annotation"),t=function(t,e){o.call(this,t,e)};t.type={id:"underline",parent:"annotation",properties:{}},(t.Prototype=function(){}).prototype=o.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=o.DONT_CARE,e.exports=t},{"../annotation/annotation":9}],27:[function(t,e,n){e.exports={Model:t("./code.js"),View:t("../annotation/annotation_view.js")}},{"../annotation/annotation_view.js":10,"./code.js":26}],28:[function(t,e,n){"use strict";var o=t("../text").Model,t=function(t,e){o.call(this,t,e)};t.type={id:"codeblock",parent:"content",properties:{source_id:"string",content:"string"}},t.config={zoomable:!0},t.description={name:"Codeblock",remarks:["Text in a codeblock is displayed in a fixed-width font, and it preserves both spaces and line breaks"],properties:{content:"Content"}},t.example={type:"codeblock",id:"codeblock_1",content:'var text = "Sun";\nvar op1 = null;\ntext = op2.apply(op1.apply(text));\nconsole.log(text);'},(t.Prototype=function(){}).prototype=o.prototype,(t.prototype=new t.Prototype).constructor=t,e.exports=t},{"../text":115}],29:[function(t,e,n){"use strict";var o=t("../text/text_view"),t=function(t){o.call(this,t)};(t.Prototype=function(){}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../text/text_view":118}],30:[function(t,e,n){"use strict";e.exports={Model:t("./codeblock"),View:t("./codeblock_view")}},{"./codeblock":28,"./codeblock_view":29}],31:[function(t,e,n){"use strict";var o=t("../node").View,t=function(t,e){o.call(this,t,e),this.childrenViews=[]};(t.Prototype=function(){this.render=function(){return o.prototype.render.call(this),this.renderChildren(),this},this.renderChildren=function(){for(var t=this.node.getChildrenIds(),e=0;e<t.length;e++){var n=this.createChildView(t[e]).render().el;this.content.appendChild(n)}},this.dispose=function(){o.prototype.dispose.call(this);for(var t=0;t<this.childrenViews.length;t++)this.childrenViews[t].dispose()},this.delete=function(){},this.getCharPosition=function(){return 0},this.getDOMPosition=function(){var t=this.$(".content")[0],e=document.createRange();return e.setStartBefore(t.childNodes[0]),e},this.createChildView=function(t){t=this.createView(t);return this.childrenViews.push(t),t}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../node":91}],32:[function(t,e,n){"use strict";var o=t("../../../substance/document");e.exports={Model:o.Composite,View:t("./composite_view")}},{"../../../substance/document":173,"./composite_view":31}],33:[function(t,e,n){var o=t("underscore"),i=t("../../../substance/document"),t=function(t,e){i.Node.call(this,t,e)};t.type={id:"contributor",parent:"content",properties:{source_id:"string",name:"string",role:"string",contributor_type:"string",affiliations:["array","affiliation"],present_address:["string"],fundings:["array","string"],image:"string",emails:["array","string"],contribution:"string",bio:["array","paragraph"],deceased:"boolean",members:["array","string"],orcid:"string",equal_contrib:["array","string"],competing_interests:["array","string"]}},t.description={name:"Contributor",remarks:["A contributor entity."],properties:{name:"Full name",affiliations:"A list of affiliation ids",present_address:"Present address of the contributor",role:"Role of contributor (e.g. Author, Editor)",fundings:"A list of funding descriptions",deceased:!1,emails:"A list of emails",orcid:"ORCID",contribution:"Description of contribution",equal_contrib:"A list of people who contributed equally",competing_interests:"A list of conflicts",members:"a list of group members"}},t.example={id:"person_1",type:"contributor",name:"John Doe",affiliations:["affiliation_1","affiliation_2"],role:"Author",fundings:["Funding Organisation 1"],emails:["a@b.com"],contribution:"Revising the article, data cleanup",equal_contrib:["John Doe","Jane Doe"]},(t.Prototype=function(){this.getAffiliations=function(){return o.map(this.properties.affiliations,function(t){return this.document.get(t)},this)},this.getHeader=function(){return this.properties.contributor_type||"Author"}}).prototype=i.Node.prototype,(t.prototype=new t.Prototype).constructor=t,i.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,underscore:185}],34:[function(t,e,n){"use strict";var o=t("underscore"),i=t("../node").View,r=t("../../../substance/application").$$,s=t("../../resource_view"),t=function(t,e,n){i.call(this,t,e),s.call(this,n)};(t.Prototype=function(){o.extend(this,s.prototype),this.renderBody=function(){var e,t;this.content.appendChild(r(".contributor-name",{text:this.node.name})),this.node.role&&this.content.appendChild(r(".role",{text:this.node.role})),this.content.appendChild(r(".affiliations",{children:o.map(this.node.getAffiliations(),function(t){t=o.compact([t.department,t.institution,t.city,t.country]).join(", ");return r(".affiliation",{text:t})})})),this.node.present_address&&this.content.appendChild(r(".present-address.contrib-data",{children:[r("span.contrib-label",{text:"Present address: "}),r("span",{text:this.node.present_address})]})),this.node.contribution&&this.content.appendChild(r(".contribution.contrib-data",{children:[r("span.contrib-label",{text:"Contribution: "}),r("span",{text:this.node.contribution})]})),this.node.equal_contrib&&0<this.node.equal_contrib.length&&this.content.appendChild(r(".equal-contribution.contrib-data",{children:[r("span.contrib-label",{text:"Contributed equally with: "}),r("span",{text:this.node.equal_contrib.join(", ")})]})),0<this.node.emails.length&&this.content.appendChild(r(".emails.contrib-data",{children:[r("span.contrib-label",{text:"For correspondence: "}),r("span",{children:o.map(this.node.emails,function(t){return r("a",{href:"mailto:"+t,text:t+" "})})})]})),0<this.node.fundings.length&&this.content.appendChild(r(".fundings.contrib-data",{children:[r("span.contrib-label",{text:"Funding: "}),r("span",{text:this.node.fundings.join("; ")})]})),this.node.competing_interests.length&&this.content.appendChild(r(".competing-interests.contrib-data",{children:[r("span.contrib-label",{text:"Competing Interests: "}),r("span",{text:this.node.competing_interests.join(", ")})]})),this.node.orcid&&this.content.appendChild(r(".contrib-data",{children:[r("span.contrib-label",{text:"ORCID: "}),r("a.orcid",{href:this.node.orcid,text:this.node.orcid})]})),0<this.node.members.length&&this.content.appendChild(r(".group-members.contrib-data",{children:[r("span.contrib-label",{text:"Group Members: "}),r("span",{text:this.node.members.join(", ")})]})),(this.node.image||this.node.bio&&0<this.node.bio.length)&&(e=r(".bio"),t=[r("img",{src:this.node.image}),e],o.each(this.node.bio,function(t){e.appendChild(this.createView(t).render().el)},this),this.content.appendChild(r(".contributor-bio.container",{children:t}))),this.node.deceased&&this.content.appendChild(r(".label",{text:"* Deceased"}))}}).prototype=i.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../../substance/application":160,"../../resource_view":126,"../node":91,underscore:185}],35:[function(t,e,n){"use strict";e.exports={Model:t("./contributor"),View:t("./contributor_view")}},{"./contributor":33,"./contributor_view":34}],36:[function(t,e,n){var o=t("../../../substance/document"),i=t("../annotation/annotation"),r=t("../resource_reference/resource_reference"),t=function(t,e){r.call(this,t,e)};t.type={id:"contributor_reference",parent:"resource_reference",properties:{target:"contributor"}},(t.Prototype=function(){}).prototype=r.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=i.NEVER,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,"../annotation/annotation":9,"../resource_reference/resource_reference":104}],37:[function(t,e,n){e.exports={Model:t("./contributor_reference.js"),View:t("../resource_reference/resource_reference_view.js")}},{"../resource_reference/resource_reference_view.js":105,"./contributor_reference.js":36}],38:[function(t,e,n){var o=t("underscore"),i=t("../../../substance/document"),t=function(t,e){i.Node.call(this,t,e)};t.type={id:"cover",parent:"content",properties:{source_id:"string",authors:["array","paragraph"],breadcrumbs:"object"}},t.description={name:"Cover",remarks:["Virtual view on the title and authors of the paper."],properties:{authors:"A paragraph that has the authors names plus references to the person cards"}},t.example={id:"cover",type:"cover"},(t.Prototype=function(){this.getAuthors=function(){return o.map(this.properties.authors,function(t){return this.document.get(t)},this)},this.getTitle=function(){return this.document.title}}).prototype=i.Node.prototype,(t.prototype=new t.Prototype).constructor=t,i.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,underscore:185}],39:[function(t,e,n){"use strict";var r=t("underscore"),s=t("../node").View,a=t("../../../substance/application").$$,c=t("../../article_util"),t=function(t,e){s.call(this,t,e)};(t.Prototype=function(){this.render=function(){s.prototype.render.call(this);var t=this.node,e=this.node.document.get("publication_info");!e||(n=e.subjects)&&(i=e.subject_link?a(".subjects",{children:r.map(e.getSubjectLinks(),function(t){return a("a",{href:t.url,text:t.name})})}):a(".subjects",{html:n.join(" ")}),this.content.appendChild(i));var n=this.createTextPropertyView(["document","title"],{classes:"title",elementType:"div"});this.content.appendChild(n.render().el);var o,i=a(".authors",{children:r.map(t.getAuthors(),function(t){t=this.viewFactory.createView(t).render().el;return this.content.appendChild(t),t},this)});return i.appendChild(a(".content-node.text.plain",{children:[a(".content",{text:this.node.document.on_behalf_of})]})),this.content.appendChild(i),e&&(n=e.published_on,t=e.article_type,n&&(i=[c.formatDate(n)],t&&(e.article_type_link?(n=e.getArticleTypeLink(),i.unshift('<a href="'+n.url+'">'+n.name+"</a>")):i.unshift(t)),this.content.appendChild(a(".published-on",{html:i.join(" ")})))),e&&0<e.links.length&&(o=a(".links"),r.each(e.links,function(t){var e;"json"===t.type&&""===t.url?(e=JSON.stringify(this.node.document.toJSON(),null,"  "),e=new Blob([e],{type:"application/json"}),o.appendChild(a("a.json",{href:window.URL?window.URL.createObjectURL(e):"#",html:'<i class="fa fa-external-link-square"></i> '+t.name,target:"_blank"}))):o.appendChild(a("a."+t.type,{href:t.url,html:'<i class="fa fa-external-link-square"></i> '+t.name,target:"_blank"}))},this),this.content.appendChild(o)),!e||(e=e.doi)&&this.content.appendChild(a(".doi",{html:'DOI: <a href="http://dx.doi.org/'+e+'">'+e+"</a>"})),this}}).prototype=s.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../../substance/application":160,"../../article_util":5,"../node":91,underscore:185}],40:[function(t,e,n){"use strict";e.exports={Model:t("./cover"),View:t("./cover_view")}},{"./cover":38,"./cover_view":39}],41:[function(t,e,n){var o=t("../../../substance/document"),i=t("../annotation/annotation"),t=function(t,e){i.call(this,t,e)};t.type={id:"cross_reference",parent:"annotation",properties:{target:"node"}},(t.Prototype=function(){}).prototype=i.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=i.NEVER,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,"../annotation/annotation":9}],42:[function(t,e,n){"use strict";var o=t("../annotation/annotation_view"),t=function(t,e){o.call(this,t,e),this.$el.addClass("cross-reference")};(t.Prototype=function(){this.createElement=function(){var t=document.createElement("a");return t.setAttribute("href",""),t}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../annotation/annotation_view":10}],43:[function(t,e,n){e.exports={Model:t("./cross_reference.js"),View:t("./cross_reference_view.js")}},{"./cross_reference.js":41,"./cross_reference_view.js":42}],44:[function(t,e,n){var o=t("../../../substance/document"),i=t("../annotation/annotation"),t=function(t,e){i.call(this,t,e)};t.type={id:"custom_annotation",parent:"annotation",properties:{name:"string"}},(t.Prototype=function(){}).prototype=i.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=i.DONT_CARE,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,"../annotation/annotation":9}],45:[function(t,e,n){var o=t("../annotation").View,t=function(t){o.call(this,t)};(t.Prototype=function(){this.setClasses=function(){o.prototype.setClasses.call(this),this.$el.removeClass("custom_annotation").addClass(this.node.name)}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../annotation":11}],46:[function(t,e,n){e.exports={Model:t("./custom_annotation.js"),View:t("./custom_annotation_view.js")}},{"./custom_annotation.js":44,"./custom_annotation_view.js":45}],47:[function(t,e,n){var o=t("../../../substance/document"),t=function(t){o.Node.call(this,t)};t.type={id:"definition",parent:"content",properties:{source_id:"string",title:"string",description:"string"}},t.description={name:"Definition",remarks:["A journal citation.","This element can be used to describe all kinds of citations."],properties:{title:"The article's title",description:"Definition description"}},t.example={id:"definition_def1",type:"Definition",title:"IAP",description:"Integrated Analysis Platform"},(t.Prototype=function(){this.urls=function(){return 0<this.properties.citation_urls.length?this.properties.citation_urls:[this.properties.doi]},this.getHeader=function(){return this.properties.label?[this.properties.label,this.properties.title].join(". "):this.properties.title}}).prototype=o.Node.prototype,(t.prototype=new t.Prototype).constructor=t,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173}],48:[function(t,e,n){"use strict";var o=t("underscore"),i=t("../node").View,r=t("../../../substance/application").$$,s=t("../../resource_view"),t=function(t,e,n){i.call(this,t,e),s.call(this,n)};(t.Prototype=function(){o.extend(this,s.prototype),this.renderBody=function(){this.content.appendChild(r(".description",{text:this.node.description}))}}).prototype=i.prototype,(t.prototype=new t.Prototype).constructor=t,e.exports=t},{"../../../substance/application":160,"../../resource_view":126,"../node":91,underscore:185}],49:[function(t,e,n){"use strict";e.exports={Model:t("./definition"),View:t("./definition_view")}},{"./definition":47,"./definition_view":48}],50:[function(t,e,n){var o=t("../../../substance/document"),i=t("../annotation/annotation"),r=t("../resource_reference/resource_reference"),t=function(t,e){r.call(this,t,e)};t.type={id:"definition_reference",parent:"resource_reference",properties:{target:"definition"}},(t.Prototype=function(){}).prototype=r.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=i.NEVER,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,"../annotation/annotation":9,"../resource_reference/resource_reference":104}],51:[function(t,e,n){e.exports={Model:t("./definition_reference.js"),View:t("../resource_reference/resource_reference_view.js")}},{"../resource_reference/resource_reference_view.js":105,"./definition_reference.js":50}],52:[function(t,e,n){"use strict";var o=t("../../../substance/document"),t=function(t,e){o.Node.call(this,t,e)};t.type={id:"document",parent:"content",properties:{views:["array","view"],guid:"string",creator:"string",title:"string",authors:["array","contributor"],on_behalf_of:"string",abstract:"string"}},(t.Prototype=function(){}).prototype=o.Node.prototype,(t.prototype=new t.Prototype).constructor=t,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173}],53:[function(t,e,n){"use strict";e.exports={Model:t("./document_node")}},{"./document_node":52}],54:[function(t,e,n){var o=t("../annotation/annotation"),t=function(t,e){o.call(this,t,e)};t.type={id:"emphasis",parent:"annotation",properties:{}},(t.Prototype=function(){}).prototype=o.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=o.DONT_CARE,e.exports=t},{"../annotation/annotation":9}],55:[function(t,e,n){e.exports={Model:t("./emphasis.js"),View:t("../annotation/annotation_view.js")}},{"../annotation/annotation_view.js":10,"./emphasis.js":54}],56:[function(t,e,n){"use strict";var o=t("../../../substance/document"),t=function(t,e){o.Composite.call(this,t,e)};t.type={parent:"content",properties:{source_id:"string",label:"string",url:"string",caption:"caption",position:"string",attrib:"string"}},t.config={zoomable:!0},t.description={name:"Figure",remarks:["A figure is a figure is figure."],properties:{label:"Label used as header for the figure cards",url:"Image url",caption:"A reference to a caption node that describes the figure",attrib:"Figure attribution"}},t.example={id:"figure_1",label:"Figure 1",url:"http://example.com/fig1.png",caption:"caption_1"},(t.Prototype=function(){this.hasCaption=function(){return!!this.properties.caption},this.getChildrenIds=function(){var t=[];return this.properties.caption&&t.push(this.properties.caption),t},this.getCaption=function(){if(this.properties.caption)return this.document.get(this.properties.caption)},this.getHeader=function(){return this.properties.label}}).prototype=o.Composite.prototype,(t.prototype=new t.Prototype).constructor=t,o.Node.defineProperties(t.prototype,Object.keys(t.type.properties)),e.exports=t},{"../../../substance/document":173}],57:[function(t,e,n){"use strict";var o=t("underscore"),i=t("../composite").View,r=t("../../../substance/application").$$,s=t("../../resource_view"),t=function(t,e,n){i.call(this,t,e),s.call(this,n)};(t.Prototype=function(){o.extend(this,s.prototype),this.isZoomable=!0,this.renderBody=function(){var t;this.content.appendChild(r(".label",{text:this.node.label})),this.node.url&&(t=r(".image-wrapper",{children:[r("a",{href:this.node.url,target:"_blank",children:[r("img",{src:this.node.url})]})]}),this.content.appendChild(t)),this.renderChildren(),this.node.attrib&&this.content.appendChild(r(".figure-attribution",{text:this.node.attrib}))},this.renderLabel=function(){var t=r(".name",{href:"#"});return this.renderAnnotatedText([this.node.id,"label"],t),t}}).prototype=i.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../../substance/application":160,"../../resource_view":126,"../composite":32,underscore:185}],58:[function(t,e,n){"use strict";e.exports={Model:t("./figure"),View:t("./figure_view")}},{"./figure":56,"./figure_view":57}],59:[function(t,e,n){var o=t("../../../substance/document"),i=t("../annotation/annotation"),r=t("../resource_reference/resource_reference"),t=function(t,e){r.call(this,t,e)};t.type={id:"figure_reference",parent:"resource_reference",properties:{target:"figure"}},(t.Prototype=function(){}).prototype=r.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=i.NEVER,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,"../annotation/annotation":9,"../resource_reference/resource_reference":104}],60:[function(t,e,n){e.exports={Model:t("./figure_reference.js"),View:t("../resource_reference/resource_reference_view.js")}},{"../resource_reference/resource_reference_view.js":105,"./figure_reference.js":59}],61:[function(t,e,n){"use strict";var o=t("../../../substance/document"),i=o.Node,t=t("../paragraph").Model,r=o.Composite,o=function(t,e){r.call(this,t,e)};o.type={id:"footnote",parent:"paragraph",properties:{footnoteType:"string",specificUse:"string",label:"string",children:["array","string"]}},o.example={type:"footnote",id:"footnote_1",label:"a","children ":["text_1","image_1","text_2"]},(o.Prototype=function(){}).prototype=t.prototype,(o.prototype=new o.Prototype).constructor=o,i.defineProperties(o.prototype,["children","label","footnoteType","specificUse"]),e.exports=o},{"../../../substance/document":173,"../paragraph":94}],62:[function(t,e,n){"use strict";var o=t("../composite/composite_view"),t=function(t,e){o.call(this,t,e)};(t.Prototype=function(){}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../composite/composite_view":31}],63:[function(t,e,n){"use strict";e.exports={Model:t("./footnote"),View:t("./footnote_view")}},{"./footnote":61,"./footnote_view":62}],64:[function(t,e,n){var o=t("../../../substance/document"),i=t("../annotation/annotation"),r=t("../resource_reference/resource_reference"),t=function(t,e){r.call(this,t,e)};t.type={id:"footnote_reference",parent:"resource_reference",properties:{target:"footnote"}},(t.Prototype=function(){}).prototype=r.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=i.NEVER,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,"../annotation/annotation":9,"../resource_reference/resource_reference":104}],65:[function(t,e,n){"use strict";var o=t("../annotation/annotation_view"),i=t("../../../substance/application").$$,t=function(t,e){o.call(this,t,e),this.$el.addClass("footnote-reference"),this._expanded=!1};(t.Prototype=function(){this.render=function(){var t=this._getFootnote();this.el.innerHTML="",this.toggleEl=i("a",{href:"#",html:t.properties.label}),$(this.toggleEl).on("click",this._onToggle.bind(this)),this.$el.append(this.toggleEl),this.footnoteView=this._createView(t).render(),this.footnoteView.$el.addClass("footnote"),this.node.properties.generated&&this.$el.addClass("sm-generated"),this.$el.append(this.footnoteView.el)},this._onToggle=function(t){t.preventDefault(),this.$el.toggleClass("sm-expanded")},this._createView=function(t){return this.viewFactory.createView(t)},this._getFootnote=function(){return this.node.document.get(this.node.target)}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../../substance/application":160,"../annotation/annotation_view":10}],66:[function(t,e,n){e.exports={Model:t("./footnote_reference.js"),View:t("./footnote_reference_view.js")}},{"./footnote_reference.js":64,"./footnote_reference_view.js":65}],67:[function(t,e,n){var o=t("../../../substance/document"),t=function(t){o.Node.call(this,t)};t.type={id:"formula",parent:"content",properties:{source_id:"string",inline:"boolean",label:"string",format:["array","string"],data:["array","string"]}},t.description={name:"Formula",remarks:["Can either be expressed in MathML format or using an image url"],properties:{label:"Formula label (4)",data:"Formula data, either MathML or image url",format:"Can either be `mathml` or `image`"}},t.example={type:"formula",id:"formula_eqn1",label:"(1)",content:"<mml:mrow>...</mml:mrow>",format:"mathml"},(t.Prototype=function(){this.inline=!1}).prototype=o.Node.prototype,(t.prototype=new t.Prototype).constuctor=t,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173}],68:[function(t,e,n){"use strict";var o=t("../node").View,t=function(t,e){o.call(this,t,e)};(t.Prototype=function(){var a={latex:"math/tex",mathml:"math/mml"},c={image:0,mathml:1,latex:2};this.render=function(){this.node.inline&&this.$el.addClass("inline");var t=[];for(o=0;o<this.node.data.length;o++)t.push({format:this.node.format[o],data:this.node.data[o]});if(t.sort(function(t,e){return c[t.format]-c[e.format]}),0<t.length)for(var e=!1,n=!1,o=0;o<t.length;o++){var i,r=t[o].format,s=t[o].data;switch(r){case"mathml":n||(this.$el.append($(s)),n=!0,e&&(this.$preview.hide(),e=!0));break;case"latex":n||(i=a[r],this.node.inline||(i+="; mode=display"),i=$("<script>").attr("type",i).html(s),this.$el.append(i),n=!0);break;case"image":e||((i=$("<div>").addClass("MathJax_Preview")).append($("<img>").attr("src",s)),this.$el.append(i),this.$preview=i,e=!0);break;default:console.error("Unknown formula format:",r)}}return this.node.label&&this.$el.append($('<div class="label">').html(this.node.label)),this}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../node":91}],69:[function(t,e,n){"use strict";e.exports={Model:t("./formula"),View:t("./formula_view")}},{"./formula":67,"./formula_view":68}],70:[function(t,e,n){"use strict";var o=t("../../../substance/document").Node,i=t("../text/text_node"),t=function(t,e){i.call(this,t,e)};t.type={id:"heading",parent:"content",properties:{source_id:"string",content:"string",label:"string",level:"number"}},t.example={type:"heading",id:"heading_1",content:"Introduction",level:1},t.description={name:"Heading",remarks:["Denotes a section or sub section in your article."],properties:{content:"Heading title",label:"Heading label",level:"Heading level. Ranges from 1..4"}},(t.Prototype=function(){this.splitInto="paragraph",this.includeInToc=function(){return!0},this.getLevel=function(){return this.level}}).prototype=i.prototype,(t.prototype=new t.Prototype).constructor=t,o.defineProperties(t),e.exports=t},{"../../../substance/document":173,"../text/text_node":116}],71:[function(t,e,n){"use strict";var o=t("../node").View,i=t("../../../substance/application").$$,t=function(t,e){o.call(this,t,e),this.$el.addClass("level-"+this.node.level)};(t.Prototype=function(){this.render=function(){o.prototype.render.call(this);var t,e=this.createTextPropertyView([this.node.id,"content"],{classes:"title"});return this.node.label&&(t=i(".label",{text:this.node.label}),this.content.appendChild(t)),this.content.appendChild(e.render().el),this},this.renderTocItem=function(){var t=i("div");this.node.label&&(e=i(".label",{text:this.node.label}),t.appendChild(e));var e=i("span");return this.renderAnnotatedText([this.node.id,"content"],e),t.appendChild(e),t}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../../substance/application":160,"../node":91}],72:[function(t,e,n){"use strict";e.exports={Model:t("./heading"),View:t("./heading_view")}},{"./heading":70,"./heading_view":71}],73:[function(t,e,n){t("underscore");var o=t("../../../substance/document"),t=function(t,e){o.Node.call(this,t,e)};t.type={id:"html_table",parent:"content",properties:{source_id:"string",label:"string",content:"string",footers:["array","string"],caption:"caption"}},t.config={zoomable:!0},t.description={name:"HTMLTable",remarks:["A table figure which is expressed in HTML notation"],properties:{source_id:"string",label:"Label shown in the resource header.",title:"Full table title",content:"HTML data",footers:"HTMLTable footers expressed as an array strings",caption:"References a caption node, that has all the content"}},t.example={id:"html_table_1",type:"html_table",label:"HTMLTable 1.",title:"Lorem ipsum table",content:"<table>...</table>",footers:[],caption:"caption_1"},(t.Prototype=function(){this.getCaption=function(){if(this.properties.caption)return this.document.get(this.properties.caption)},this.getHeader=function(){return this.properties.label}}).prototype=o.Node.prototype,(t.prototype=new t.Prototype).constructor=t,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,underscore:185}],74:[function(t,e,n){"use strict";var o=t("underscore"),i=t("../node").View,r=t("../../../substance/application").$$,s=t("../../resource_view"),t=function(t,e,n){i.call(this,t,e),s.call(this,n)};(t.Prototype=function(){o.extend(this,s.prototype),this.isZoomable=!0,this.renderBody=function(){var t=r(".table-wrapper",{html:this.node.content});this.content.appendChild(t);var e=r(".footers",{children:o.map(this.node.footers,function(t){return r(".footer",{html:"<b>"+t.label+"</b> "+t.content})})});this.node.caption&&(t=this.createView(this.node.caption),this.content.appendChild(t.render().el)),this.content.appendChild(e)}}).prototype=i.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../../substance/application":160,"../../resource_view":126,"../node":91,underscore:185}],75:[function(t,e,n){"use strict";e.exports={Model:t("./html_table"),View:t("./html_table_view")}},{"./html_table":73,"./html_table_view":74}],76:[function(t,e,n){"use strict";t("../../../substance/document").Node;var o=t("../web_resource").Model,t=function(t,e){o.call(this,t,e)};t.type={id:"image",parent:"webresource",properties:{source_id:"string"}},t.example={type:"image",id:"image_1",url:"http://substance.io/image_1.png"},t.description={name:"Image",remarks:["Represents a web-resource for an image."],properties:{}},(t.Prototype=function(){}).prototype=o.prototype,(t.prototype=new t.Prototype).constructor=t,e.exports=t},{"../../../substance/document":173,"../web_resource":124}],77:[function(t,e,n){"use strict";var o=t("../node").View,t=function(t,e){o.call(this,t,e)};(t.Prototype=function(){var o=Array.prototype.indexOf;this.render=function(){var t=document.createElement("div");t.className="content";var e=document.createElement("div");e.className="image-char",this._imgChar=e;var n=document.createElement("img");return n.src=this.node.url,n.alt="alt text",n.title="alt text",e.appendChild(n),t.appendChild(e),this.el.appendChild(t),this._imgPos=o.call(e.childNodes,n),this},this.delete=function(t,e){for(var n=this.$(".content")[0],o=n.childNodes,i=e-1;0<=i;i--)n.removeChild(o[t+i])},this.getCharPosition=function(t,e){if(t===this._imgChar)return e>this._imgPos?1:0;console.log("Errhhh..")},this.getDOMPosition=function(t){var e=this.$(".content")[0],n=document.createRange();return 0===t?n.setStartBefore(e.childNodes[0]):n.setStartAfter(e.childNodes[0]),n}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../node":91}],78:[function(t,e,n){"use strict";e.exports={Model:t("./image"),View:t("./image_view")}},{"./image":76,"./image_view":77}],79:[function(t,e,n){"use strict";e.exports={node:t("./node"),composite:t("./composite"),annotation:t("./annotation"),emphasis:t("./emphasis"),strong:t("./strong"),subscript:t("./subscript"),superscript:t("./superscript"),underline:t("./underline"),code:t("./code"),author_callout:t("./author_callout"),custom_annotation:t("./custom_annotation"),"inline-formula":t("./inline_formula"),resource_reference:t("./resource_reference"),contributor_reference:t("./contributor_reference"),figure_reference:t("./figure_reference"),citation_reference:t("./citation_reference"),definition_reference:t("./definition_reference"),cross_reference:t("./cross_reference"),footnote_reference:t("./footnote_reference"),publication_info:t("./publication_info"),link:t("./link"),inline_image:t("./inline_image"),document:t("./document"),text:t("./text"),paragraph:t("./paragraph"),heading:t("./heading"),box:t("./box"),cover:t("./cover"),figure:t("./figure"),caption:t("./caption"),image:t("./image"),webresource:t("./web_resource"),html_table:t("./html_table"),supplement:t("./supplement"),video:t("./video"),contributor:t("./contributor"),definition:t("./definition"),citation:t("./citation"),formula:t("./formula"),list:t("./list"),codeblock:t("./codeblock"),affiliation:t("./_affiliation"),footnote:t("./footnote"),quote:t("./quote")}},{"./_affiliation":8,"./annotation":11,"./author_callout":14,"./box":17,"./caption":20,"./citation":23,"./citation_reference":25,"./code":27,"./codeblock":30,"./composite":32,"./contributor":35,"./contributor_reference":37,"./cover":40,"./cross_reference":43,"./custom_annotation":46,"./definition":49,"./definition_reference":51,"./document":53,"./emphasis":55,"./figure":58,"./figure_reference":60,"./footnote":63,"./footnote_reference":66,"./formula":69,"./heading":72,"./html_table":75,"./image":78,"./inline_formula":80,"./inline_image":83,"./link":85,"./list":88,"./node":91,"./paragraph":94,"./publication_info":97,"./quote":100,"./resource_reference":103,"./strong":106,"./subscript":108,"./superscript":110,"./supplement":112,"./text":115,"./underline":119,"./video":121,"./web_resource":124}],80:[function(t,e,n){e.exports={Model:t("./inline_formula.js"),View:t("./inline_formula_view.js")}},{"./inline_formula.js":81,"./inline_formula_view.js":82}],81:[function(t,e,n){var o=t("../../../substance/document"),i=t("../annotation/annotation"),t=function(t,e){i.call(this,t,e)};t.type={id:"inline-formula",parent:"annotation",properties:{target:"formula"}},(t.Prototype=function(){}).prototype=i.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=i.NEVER,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,"../annotation/annotation":9}],82:[function(t,e,n){"use strict";var o=t("../resource_reference").View,t=function(t,e){o.call(this,t,e),$(this.el).removeClass("resource-reference")};(t.Prototype=function(){this.createElement=function(){return document.createElement("span")},this.render=function(){var t=this.node.document.get(this.node.target),t=this.viewFactory.createView(t);return this.el.innerHTML=t.render().el.innerHTML,this}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../resource_reference":103}],83:[function(t,e,n){e.exports={Model:t("./inline_image.js"),View:t("../annotation/annotation_view.js")}},{"../annotation/annotation_view.js":10,"./inline_image.js":84}],84:[function(t,e,n){var o=t("../../../substance/document"),i=t("../annotation/annotation"),t=function(t,e){i.call(this,t,e)};t.type={id:"inline-image",parent:"annotation",properties:{target:"image"}},(t.Prototype=function(){}).prototype=i.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=i.NEVER,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,"../annotation/annotation":9}],85:[function(t,e,n){e.exports={Model:t("./link.js"),View:t("./link_view.js")}},{"./link.js":86,"./link_view.js":87}],86:[function(t,e,n){var o=t("../../../substance/document"),i=t("../annotation/annotation"),t=function(t,e){i.call(this,t,e)};t.type={id:"link",parent:"annotation",properties:{url:"string"}},(t.Prototype=function(){}).prototype=i.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=i.NEVER,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,"../annotation/annotation":9}],87:[function(t,e,n){var o=t("../annotation").View,t=function(t){o.call(this,t)};(t.Prototype=function(){this.createElement=function(){var t=document.createElement("a");return t.setAttribute("href",this.node.url),t},this.setClasses=function(){this.$el.addClass("link")}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../annotation":11}],88:[function(t,e,n){"use strict";e.exports={Model:t("./list"),View:t("./list_view")}},{"./list":89,"./list_view":90}],89:[function(t,e,n){"use strict";var o=t("underscore"),i=t("../../../substance/document"),t=i.Node,r=i.Composite,i=function(t,e){r.call(this,t,e)};i.type={id:"list",parent:"content",properties:{source_id:"string",items:["array","paragraph"],ordered:"boolean"}},i.description={name:"List",remarks:["Lists can either be numbered or bullet lists"],properties:{ordered:"Specifies wheter the list is ordered or not",items:"An array of paragraph references"}},i.example={type:"list",id:"list_1","items ":["paragraph_listitem_1","paragraph_listitem_2"]},(i.Prototype=function(){this.getLength=function(){return this.properties.items.length},this.getChildrenIds=function(){return o.clone(this.items)},this.getItems=function(){return o.map(this.properties.items,function(t){return this.document.get(t)},this)},this.getChangePosition=function(t){if("items"===t.path[1])if("update"===t.type){var e=t.diff;if(e.isInsert())return t.diff.pos+1;if(e.isDelete())return t.diff.pos;if(e.isMove())return t.diff.target}else if("set"===t.type)return this.properties.items.length-1;return-1},this.isMutable=function(){return!0},this.insertChild=function(t,e,n){t.update([this.id,"items"],["+",e,n])},this.deleteChild=function(t,e){var n=this.items.indexOf(e);t.update([this.id,"items"],["-",n,e]),t.delete(e)},this.canJoin=function(t){return"list"===t.type},this.isBreakable=function(){return!0},this.break=function(t,e,n){var o=this.properties.items.indexOf(e);if(o<0)throw new Error("Unknown child "+e);n=t.get(e).break(t,n);return t.update([this.id,"items"],["+",o+1,n.id]),n}}).prototype=r.prototype,(i.prototype=new i.Prototype).constructor=i,t.defineProperties(i.prototype,["items","ordered"]),e.exports=i},{"../../../substance/document":173,underscore:185}],90:[function(t,e,n){"use strict";var o=t("../composite/composite_view"),s=t("./list"),t=function(t,e){o.call(this,t,e)};t.whoami="SubstanceListView",(t.Prototype=function(){this.render=function(){this.el.innerHTML="";var t=this.node.ordered?"OL":"UL";for(this.content=document.createElement(t),this.content.classList.add("content"),n=0;n<this.childrenViews.length;n++)this.childrenViews[n].dispose();for(var e=this.node.getNodes(),n=0;n<e.length;n++){var o,i=this.node.document.get(e[n]),r=this.viewFactory.createView(i);i instanceof s?o=r.render().el:(o=document.createElement("LI")).appendChild(r.render().el),this.content.appendChild(o),this.childrenViews.push(r)}return this.el.appendChild(this.content),this},this.onNodeUpdate=function(t){t.path[0]===this.node.id&&"items"===t.path[1]&&this.render()}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../composite/composite_view":31,"./list":89}],91:[function(t,e,n){"use strict";e.exports={Model:t("./node"),View:t("./node_view")}},{"./node":92,"./node_view":93}],92:[function(t,e,n){"use strict";t=t("../../../substance/document").Node;t.description={name:"Node",remarks:["Abstract node type."],properties:{source_id:"Useful for document conversion where the original id of an element should be remembered."}},e.exports=t},{"../../../substance/document":173}],93:[function(t,e,n){"use strict";var o=t("../../../substance/application").View,i=t("../text/text_property_view"),t=function(t,e,n){if(o.call(this,n),this.node=t,!(this.viewFactory=e))throw new Error('Illegal argument. Argument "viewFactory" is mandatory.');this.$el.addClass("content-node").addClass(t.type.replace("_","-")),this.el.dataset.id=this.node.id};(t.Prototype=function(){this.render=function(){return this.content=document.createElement("DIV"),this.content.classList.add("content"),this.focusHandle=document.createElement("DIV"),this.focusHandle.classList.add("focus-handle"),this.el.appendChild(this.content),this.el.appendChild(this.focusHandle),this},this.dispose=function(){this.stopListening()},this.createView=function(t){t=this.node.document.get(t);return this.viewFactory.createView(t)},this.createTextView=function(t){return console.error("FIXME: NodeView.createTextView() is deprecated. Use NodeView.createTextPropertyView() instead."),this.viewFactory.createView(this.node,t,"text")},this.createTextPropertyView=function(t,e){return new i(this.node.document,t,this.viewFactory,e)},this.renderAnnotatedText=function(t,e){return i.renderAnnotatedText(this.node.document,t,e,this.viewFactory)}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../../substance/application":160,"../text/text_property_view":117}],94:[function(t,e,n){"use strict";e.exports={Model:t("./paragraph"),View:t("./paragraph_view")}},{"./paragraph":95,"./paragraph_view":96}],95:[function(t,e,n){"use strict";var o=t("underscore"),i=t("../../../substance/document"),t=i.Node,r=i.Composite,i=function(t,e){r.call(this,t,e)};i.type={id:"paragraph",parent:"content",properties:{children:["array","content"]}},i.description={name:"Paragraph",remarks:["A Paragraph can have inline elements such as images."],properties:{children:"An array of content node references"}},i.example={type:"paragraph",id:"paragraph_1","children ":["text_1","image_1","text_2"]},(i.Prototype=function(){this.getLength=function(){return this.properties.children.length},this.getChildrenIds=function(){return o.clone(this.properties.children)},this.getChildren=function(){return o.map(this.properties.children,function(t){return this.document.get(t)},this)}}).prototype=r.prototype,(i.prototype=new i.Prototype).constructor=i,t.defineProperties(i.prototype,["children"]),e.exports=i},{"../../../substance/document":173,underscore:185}],96:[function(t,e,n){"use strict";var o=t("../composite/composite_view"),t=function(t,e){o.call(this,t,e)};(t.Prototype=function(){}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../composite/composite_view":31}],97:[function(t,e,n){"use strict";e.exports={Model:t("./publication_info"),View:t("./publication_info_view")}},{"./publication_info":98,"./publication_info_view":99}],98:[function(t,e,n){"use strict";var o=t("../../../substance/document"),t=function(t,e){o.Node.call(this,t,e)};t.type={id:"publication_info",parent:"content",properties:{history:["array","object"],published_on:"string",journal:"string",provider:"string",article_type:"string",keywords:["array","string"],research_organisms:["array","string"],subjects:["array","string"],links:["array","objects"],doi:"string",related_article:"string",article_info:"paragraph",subject_link:"string",article_type_link:"string"}},t.description={name:"PublicationInfo",description:"PublicationInfo Node",remarks:["Summarizes the article's meta information. Meant to be customized by publishers"],properties:{received_on:"Submission received",accepted_on:"Paper accepted on",published_on:"Paper published on",history:"History of the submission cycle",journal:"The Journal",provider:"Who is hosting this article",article_type:"Research Article vs. Insight, vs. Correction etc.",keywords:"Article's keywords",research_organisms:"Research Organisms",subjects:"Article Subjects",doi:"Article DOI",related_article:"DOI of related article if there is any"}},t.example={id:"publication_info",published_on:"2012-11-13",history:[{type:"received",date:"2012-06-20"},{type:"accepted",date:"2012-09-05"}],journal:"eLife",provider:"eLife",article_type:"Research Article",keywords:["innate immunity","histones","lipid droplet","anti-bacterial"],research_organisms:["B. subtilis","D. melanogaster","E. coli","Mouse"],subjects:["Immunology","Microbiology and infectious disease"],doi:"http://dx.doi.org/10.7554/eLife.00003"},(t.Prototype=function(){this.getArticleInfo=function(){return this.document.get("articleinfo")},this.getSubjectLinks=function(){return this.subjects.map(function(t){return{name:t,url:this.subject_link+"/"+t.replace(/ /g,"-").toLowerCase()}}.bind(this))},this.getArticleTypeLink=function(){return{name:this.article_type,url:this.article_type_link+"/"+this.article_type.replace(/ /g,"-").toLowerCase()}}}).prototype=o.Node.prototype,(t.prototype=new t.Prototype).constructor=t,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173}],99:[function(t,e,n){"use strict";var r=t("../node").View,s=t("../../../substance/application").$$,i=t("../../article_util"),a={received:"received",accepted:"accepted",revised:"revised",corrected:"corrected","rev-recd":"revised","rev-request":"returned for modification",published:"published",default:"updated"},t=function(t,e){r.call(this,t,e)};(t.Prototype=function(){this.render=function(){r.prototype.render.call(this);var t,e,n,o=s(".meta-data");this.node.article_type&&(t=s(".article-type.container",{children:[s("div.label",{text:"Article Type"}),s("div.value",{text:this.node.article_type})]}),o.appendChild(t)),this.node.subjects&&0<this.node.subjects.length&&(e=s(".subject.container",{children:[s("div.label",{text:"Subject"}),s("div.value",{text:this.node.subjects.join(", ")})]}),o.appendChild(e)),this.node.research_organisms&&0<this.node.research_organisms.length&&(e=s(".subject.container",{children:[s("div.label",{text:"Organism"}),s("div.value",{text:this.node.research_organisms.join(", ")})]}),o.appendChild(e)),this.node.keywords&&0<this.node.keywords.length&&(n=s(".keywords.container",{children:[s("div.label",{text:"Keywords"}),s("div.value",{text:this.node.keywords.join(", ")})]}),o.appendChild(n)),this.node.doi&&(n=s(".doi.container",{children:[s("div.label",{text:"DOI"}),s("div.value",{children:[s("a",{href:"http://dx.doi.org/"+this.node.doi,text:this.node.doi,target:"_blank"})]})]}),o.appendChild(n)),this.node.related_article&&(i=s(".related-article.container",{children:[s("div.label",{text:"Related Article"}),s("div.value",{children:[s("a",{href:this.node.related_article,text:this.node.related_article})]})]}),o.appendChild(i));var i=this.describePublicationHistory();o.appendChild(i),this.content.appendChild(o);o=this.node.getArticleInfo(),o=this.viewFactory.createView(o).render().el;return this.content.appendChild(o),this},this.describePublicationHistory=function(){var t,e=s(".dates"),n=[];if(this.node.history&&0<this.node.history.length&&(n=n.concat(this.node.history)),this.node.published_on&&n.push({type:"published",date:this.node.published_on}),0<n.length){for(e.appendChild(document.createTextNode("The article was ")),t=0;t<n.length;t++){0<t&&(e.appendChild(document.createTextNode(", ")),t===n.length-1&&e.appendChild(document.createTextNode("and ")));var o=n[t];e.appendChild(document.createTextNode((a[o.type]||a.default)+" on ")),e.appendChild(s("b",{text:i.formatDate(o.date)}))}e.appendChild(document.createTextNode("."))}return e},this.dispose=function(){r.prototype.dispose.call(this)}}).prototype=r.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../../substance/application":160,"../../article_util":5,"../node":91}],100:[function(t,e,n){"use strict";e.exports={Model:t("./quote"),View:t("./quote_view")}},{"./quote":101,"./quote_view":102}],101:[function(t,e,n){"use strict";var o=t("../../../substance/document"),i=o.Composite,t=function(t,e){i.call(this,t,e)};t.type={id:"quote",parent:"content",properties:{source_id:"string",label:"string",children:["array","paragraph"]}},t.description={name:"Quote",remarks:["A quote type."],properties:{label:"string",children:"0..n Paragraph nodes"}},t.example={id:"quote_1",type:"quote",label:"Quote 1",children:["paragraph_1","paragraph_2"]},(t.Prototype=function(){this.getChildrenIds=function(){return this.properties.children}}).prototype=i.prototype,(t.prototype=new t.Prototype).constructor=t,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173}],102:[function(t,e,n){"use strict";var o=t("../node").View,i=t("../composite").View,r=t("../../../substance/application").$$,t=function(t,e){i.call(this,t,e)};(t.Prototype=function(){this.render=function(){var t;return o.prototype.render.call(this),this.node.label&&(t=r(".label",{text:this.node.label}),this.content.appendChild(t)),this.renderChildren(),this.el.appendChild(this.content),this}}).prototype=i.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../../substance/application":160,"../composite":32,"../node":91}],103:[function(t,e,n){e.exports={Model:t("./resource_reference.js"),View:t("./resource_reference_view.js")}},{"./resource_reference.js":104,"./resource_reference_view.js":105}],104:[function(t,e,n){var o=t("../../../substance/document"),i=t("../annotation/annotation"),t=function(t,e){i.call(this,t,e)};t.type={id:"resource_reference",parent:"annotation",properties:{target:"node"}},(t.Prototype=function(){}).prototype=i.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=i.NEVER,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,"../annotation/annotation":9}],105:[function(t,e,n){"use strict";var o=t("../annotation/annotation_view"),t=function(t,e){o.call(this,t,e),this.$el.addClass("resource-reference")};(t.Prototype=function(){this.createElement=function(){var t=document.createElement("a");return t.setAttribute("href",""),t}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../annotation/annotation_view":10}],106:[function(t,e,n){e.exports={Model:t("./strong.js"),View:t("../annotation/annotation_view.js")}},{"../annotation/annotation_view.js":10,"./strong.js":107}],107:[function(t,e,n){var o=t("../annotation/annotation"),t=function(t,e){o.call(this,t,e)};t.type={id:"strong",parent:"annotation",properties:{}},(t.Prototype=function(){}).prototype=o.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=o.DONT_CARE,e.exports=t},{"../annotation/annotation":9}],108:[function(t,e,n){e.exports={Model:t("./subscript.js"),View:t("../annotation/annotation_view.js")}},{"../annotation/annotation_view.js":10,"./subscript.js":109}],109:[function(t,e,n){var o=t("../annotation/annotation"),t=function(t,e){o.call(this,t,e)};t.type={id:"subscript",parent:"annotation",properties:{}},(t.Prototype=function(){}).prototype=o.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=o.DONT_CARE,e.exports=t},{"../annotation/annotation":9}],110:[function(t,e,n){e.exports={Model:t("./superscript.js"),View:t("../annotation/annotation_view.js")}},{"../annotation/annotation_view.js":10,"./superscript.js":111}],111:[function(t,e,n){var o=t("../annotation/annotation"),t=function(t,e){o.call(this,t,e)};t.type={id:"superscript",parent:"annotation",properties:{}},(t.Prototype=function(){}).prototype=o.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=o.DONT_CARE,e.exports=t},{"../annotation/annotation":9}],112:[function(t,e,n){"use strict";e.exports={Model:t("./supplement"),View:t("./supplement_view")}},{"./supplement":113,"./supplement_view":114}],113:[function(t,e,n){t("underscore");var o=t("../../../substance/document"),t=function(t,e){o.Composite.call(this,t,e)};t.type={id:"supplement",parent:"content",properties:{source_id:"string",label:"string",url:"string",caption:"caption"}},t.description={name:"Supplement",remarks:["A Supplement entity."],properties:{source_id:"Supplement id as it occurs in the source NLM file",label:"Supplement label",caption:"References a caption node, that has all the content",url:"URL of downloadable file"}},t.example={id:"supplement_1",source_id:"SD1-data",type:"supplement",label:"Supplementary file 1.",url:"http://myserver.com/myfile.pdf",caption:"caption_supplement_1"},(t.Prototype=function(){this.getChildrenIds=function(){var t=[];return this.properties.caption&&t.push(this.properties.caption),t},this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):null},this.getHeader=function(){return this.properties.label}}).prototype=o.Composite.prototype,(t.prototype=new t.Prototype).constructor=t,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173,underscore:185}],114:[function(t,e,n){"use strict";var o=t("underscore"),i=t("../composite").View,r=t("../../../substance/application").$$,s=t("../../resource_view"),t=function(t,e,n){i.call(this,t,e),s.call(this,n)};(t.Prototype=function(){o.extend(this,s.prototype),this.renderBody=function(){this.renderChildren();var t=r("div.file",{children:[r("a",{href:this.node.url,html:'<i class="fa fa-download"/> Download'})]});this.content.appendChild(t)}}).prototype=i.prototype,(t.prototype=new t.Prototype).constructor=t,e.exports=t},{"../../../substance/application":160,"../../resource_view":126,"../composite":32,underscore:185}],115:[function(t,e,n){"use strict";e.exports={Model:t("./text_node"),View:t("./text_view")}},{"./text_node":116,"./text_view":118}],116:[function(t,e,n){"use strict";t=t("../../../substance/document");e.exports=t.TextNode},{"../../../substance/document":173}],117:[function(t,e,n){"use strict";function o(t,e,n,o){(o=o||{}).elementType=o.elementType||"span",i.call(this,o),this.path=e,this.document=t,this.viewFactory=n,this.options=o||{},this.property=t.resolve(this.path),this.$el.addClass("text"),this.options.classes&&this.$el.addClass(this.options.classes)}var u=t("../../../substance/util").Fragmenter,i=t("../../../substance/application").View;(o.Prototype=function(){this.render=function(){return this.el.innerHTML="",o.renderAnnotatedText(this.document,this.path,this.el,this.viewFactory),this},this.dispose=function(){this.stopListening()},this.renderWithAnnotations=function(t){var n=this,e=this.property.get(),o=document.createDocumentFragment(),i=this.document,r=[],s=new u;s.onText=function(t,e){t.appendChild(document.createTextNode(e))},s.onEnter=function(t,e){t=i.get(t.id),t=n.viewFactory.createView(t);return e.appendChild(t.el),r.push(t),t.el},s.start(o,e,t);for(var a=0;a<r.length;a++)r[a].render();this.el.innerHTML="",this.el.appendChild(o)}}).prototype=i.prototype,o.prototype=new o.Prototype,o.renderAnnotatedText=function(n,t,e,o){var i=window.document.createDocumentFragment(),r=n.get(t),s=n.getIndex("annotations").get(t),a=[],t=new u;t.onText=function(t,e){t.appendChild(window.document.createTextNode(e))},t.onEnter=function(t,e){t=n.get(t.id),t=o.createView(t);return e.appendChild(t.el),a.push(t),t.el},t.start(i,r,s);for(var c=0;c<a.length;c++)a[c].render();e.appendChild(i)},e.exports=o},{"../../../substance/application":160,"../../../substance/util":182}],118:[function(t,e,n){"use strict";var c=t("../../../substance/util").Fragmenter,o=t("../node/node_view"),i=t("../../../substance/application").$$,t=function(t,e,n){o.call(this,t,e),n=this.options=n||{},this.path=n.path||[t.id,"content"],this.property=t.document.resolve(this.path),this.$el.addClass("text"),n.classes&&this.$el.addClass(n.classes),n.path&&this.$el.removeClass("content-node"),this._annotations={}};(t.Prototype=function(){this.render=function(){return o.prototype.render.call(this),this.renderContent(),this},this.dispose=function(){o.prototype.dispose.call(this)},this.renderContent=function(){this.content.innerHTML="",this._annotations=this.node.document.getIndex("annotations").get(this.path),this.renderWithAnnotations(this._annotations)},this.createAnnotationElement=function(t){if(this.options.createAnnotationElement)return this.options.createAnnotationElement.call(this,t);t="link"===t.type?i("a.annotation."+t.type,{id:t.id,href:this.node.document.get(t.id).url}):i("span.annotation."+t.type,{id:t.id});return t},this.renderWithAnnotations=function(t){var n=this,e=this.property.get(),o=document.createDocumentFragment(),i=this.node.document,r=[],s=new c;s.onText=function(t,e){t.appendChild(document.createTextNode(e))},s.onEnter=function(t,e){t=i.get(t.id),t=n.viewFactory.createView(t);return e.appendChild(t.el),r.push(t),t.el},s.start(o,e,t);for(var a=0;a<r.length;a++)r[a].render();this.content.innerHTML="",this.content.appendChild(o)}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../../substance/application":160,"../../../substance/util":182,"../node/node_view":93}],119:[function(t,e,n){e.exports={Model:t("./underline.js"),View:t("../annotation/annotation_view.js")}},{"../annotation/annotation_view.js":10,"./underline.js":120}],120:[function(t,e,n){var o=t("../annotation/annotation"),t=function(t,e){o.call(this,t,e)};t.type={id:"underline",parent:"annotation",properties:{}},(t.Prototype=function(){}).prototype=o.prototype,((t.prototype=new t.Prototype).constructor=t).fragmentation=o.DONT_CARE,e.exports=t},{"../annotation/annotation":9}],121:[function(t,e,n){"use strict";e.exports={Model:t("./video"),View:t("./video_view")}},{"./video":122,"./video_view":123}],122:[function(t,e,n){var o=t("../../../substance/document"),t=function(t,e){o.Node.call(this,t,e)};t.type={id:"video",parent:"content",properties:{source_id:"string",label:"string",url:"string",url_webm:"string",url_ogv:"string",caption:"caption",poster:"string"}},t.config={zoomable:!0},t.description={name:"Video",remarks:["A video type intended to refer to video resources.","MP4, WebM and OGV formats are supported."],properties:{label:"Label shown in the resource header.",url:"URL to mp4 version of the video.",url_webm:"URL to WebM version of the video.",url_ogv:"URL to OGV version of the video.",poster:"Video poster image.",caption:"References a caption node, that has all the content"}},t.example={id:"video_1",type:"video",label:"Video 1.",url:"https://cdn.elifesciences.org/video/eLifeLensIntro2.mp4",url_webm:"https://cdn.elifesciences.org/video/eLifeLensIntro2.webm",url_ogv:"https://cdn.elifesciences.org/video/eLifeLensIntro2.ogv",poster:"https://cdn.elifesciences.org/video/eLifeLensIntro2.png",caption:"caption_25"},(t.Prototype=function(){this.getHeader=function(){return this.properties.label},this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):""}}).prototype=o.Node.prototype,(t.prototype=new t.Prototype).constructor=t,o.Node.defineProperties(t),e.exports=t},{"../../../substance/document":173}],123:[function(t,e,n){"use strict";var o=t("underscore"),i=t("../../../substance/application").$$,r=t("../node").View,s=t("../../resource_view"),t=function(t,e,n){r.call(this,t,e),s.call(this,n)};(t.Prototype=function(){o.extend(this,s.prototype),this.isZoomable=!0,this.renderBody=function(){var t=this.node,e=[i("source",{src:t.url,type:"video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;"})];t.url_ogv&&e.push(i("source",{src:t.url_ogv,type:"video/ogg; codecs=&quot;theora, vorbis&quot;"})),t.url_webm&&e.push(i("source",{src:t.url_webm,type:"video/webm"}));e=i(".video-wrapper",{children:[i("video",{controls:"controls",poster:t.poster,preload:"none",children:e})]});this.content.appendChild(e),t.title&&this.content.appendChild(i(".title",{text:t.title})),this.node.caption&&(e=this.createView(this.node.caption),this.content.appendChild(e.render().el),this.captionView=e),t.doi&&this.content.appendChild(i(".doi",{children:[i("b",{text:"DOI: "}),i("a",{href:t.doi,target:"_new",text:t.doi})]}))}}).prototype=r.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../../substance/application":160,"../../resource_view":126,"../node":91,underscore:185}],124:[function(t,e,n){"use strict";e.exports={Model:t("./web_resource"),View:t("../node").View}},{"../node":91,"./web_resource":125}],125:[function(t,e,n){"use strict";var o=t("../../../substance/document").Node,t=function(t,e){o.call(this,t,e)};t.type={id:"webresource",parent:"content",properties:{source_id:"string",url:"string"}},t.description={name:"WebResource",description:"A resource which can be accessed via URL",remarks:["This element is a parent for several other nodes such as Image."],properties:{url:"URL to a resource"}},t.example={type:"webresource",id:"webresource_3",url:"http://elife.elifesciences.org/content/elife/1/e00311/F3.medium.gif"},(t.Prototype=function(){}).prototype=o.prototype,(t.prototype=new t.Prototype).constructor=t,o.defineProperties(t.prototype,["url"]),e.exports=t},{"../../../substance/document":173}],126:[function(t,e,n){"use strict";var o=t("underscore"),i=t("./nodes/node").View,r=t("../substance/application").$$,s={header:!1,zoom:!1},t=function(t){this.options=o.extend({},s,t)};t.Prototype=function(){this.isResourceView=!0,this.render=function(){return i.prototype.render.call(this),this.renderHeader(),this.renderBody(),this},this.renderHeader=function(){var t,e;this.node;this.options.header&&((t=r(".resource-header")).appendChild(this.renderLabel()),e=r(".toggles"),this.options.zoom&&e.appendChild(r("a.toggle.toggle-fullscreen",{href:"#",html:'<i class="fa fa-expand"></i> Fullscreen'})),e.appendChild(r("a.toggle-res.toggle.action-toggle-resource",{href:"#",html:'<i class="fa fa-eye"></i> Focus'})),t.appendChild(e),this.headerEl=t,this.el.insertBefore(t,this.content))},this.renderLabel=function(){return r("div.name",{html:this.getHeader()})},this.renderBody=function(){},this.getHeader=function(){return this.node.getHeader()}},t.prototype=new t.Prototype,e.exports=t},{"../substance/application":160,"./nodes/node":91,underscore:185}],127:[function(t,e,n){function o(t,e){this.nodeTypes=t,this.options=e||{}}o.Prototype=function(){this.getNodeViewClass=function(t,e){e=e||t.type;var n=this.nodeTypes[e];if(!n)throw new Error("No node registered for type "+e+".");n=n.View;if(!n)throw new Error('No view registered for type "'+t.type+'".');return n},this.createView=function(t,e,n){return new(this.getNodeViewClass(t,n))(t,this,e)}},o.prototype=new o.Prototype,e.exports=o},{}],128:[function(t,e,n){"use strict";var s=t("../substance/util"),u=t("underscore"),o=t("./lens_converter"),t=function(t){o.call(this,t)};(t.Prototype=function(){var n=o.prototype;"video"in n._refTypeMapping||(n._refTypeMapping.video="figure_reference"),this.test=function(t,e){return"eLife Sciences Publications, Ltd"===t.querySelector("publisher-name").textContent},this.__ignoreCustomMetaNames=["elife-xml-version"],this.enhanceArticle=function(n,t){var o,i=[],r=n.doc,t=t.querySelectorAll("sub-article");u.each(t,function(t){var e=t.querySelector("title-group article-title").textContent;o={id:n.nextId("heading"),type:"heading",level:1,content:e},r.create(o),i.push(o),o=t.querySelector("body"),i=i.concat(this.bodyNodes(n,s.dom.getChildren(o)))}.bind(this)),0<i.length&&this.show(n,i)},this.enhanceFigure=function(t,e,n){n=n.querySelector("graphic").getAttribute("xlink:href");e.url=this.resolveURL(t,n)},this.resolveURL=function(t,e){if(e.match(/http:\/\//))return e;var n=this.getBaseURL(t);return n?[n,e].join(""):(e.match(/\.tif$/g)?e=e.replace(/\.tif$/g,".jpg"):e.match(/\.gif$/g)||(e+=".jpg"),["https://cdn.elifesciences.org/articles/",t.doc.id,"/",e].join(""))},this.enhanceSupplement=function(t,e){var n=this.getBaseURL(t);if(n)return[n,e.url].join("");e.url=["https://cdn.elifesciences.org/articles/",t.doc.id,"/",e.url].join("")},this.enhancePublicationInfo=function(t){var e,n=t.xmlDoc.querySelector("article"),o=n.querySelector("article-meta"),i=t.doc.get("publication_info"),r=o.querySelectorAll("kwd-group[kwd-group-type=research-organism] kwd"),s=o.querySelectorAll("kwd-group[kwd-group-type=author-keywords] kwd"),a=o.querySelectorAll("subj-group[subj-group-type=heading] subject"),c=o.querySelector("subj-group[subj-group-type=display-channel] subject"),o=n.querySelector("self-uri[content-type=pdf]");o&&(e=["https://cdn.elifesciences.org/articles/",t.doc.id,"/",o?o.getAttribute("xlink:href"):"#"].join(""));n=null;o&&(n=o.getAttribute("xlink:href").match(/\w*-\w*-v(\d*).pdf$/));o=n?n[1]:1,n=[];e&&n.push({url:e,name:"PDF",type:"pdf"}),n.push({url:"https://cdn.elifesciences.org/articles/"+t.doc.id+"/elife-"+t.doc.id+"-v"+o+".xml",name:"Source XML",type:"xml"}),n.push({url:"",name:"Lens JSON",type:"json"}),i.research_organisms=u.pluck(r,"textContent"),i.keywords=u.pluck(s,"textContent"),i.subjects=u.pluck(a,"textContent"),i.article_type=c?c.textContent:"",i.links=n,i.subject_link="https://elifesciences.org/category",i.article_type_link="https://elifesciences.org/category",i.related_article&&(i.related_article="http://dx.doi.org/"+i.related_article)},this.enhanceSupplement=function(t,e){var n=this.getBaseURL(t);if(n)return[n,e.url].join("");e.url=["https://cdn.elifesciences.org/articles/",t.doc.id,"/",e.url].join("")},this.enhanceTable=function(t,e,n){this.mapCitations(t),e.content=this.enhanceHTML(e.content)},this.mapCitations=function(t){this.citationCitationReferenceMap=[];var e=[],n=t.doc;u.each(n.nodes,function(t){"citation"==t.type&&(e[t.source_id]=t.id)}.bind(this));t=t.annotations;u.each(t,function(t){"citation_reference"==t.type&&(this.citationCitationReferenceMap[t.target]=t.id)}.bind(this))},this.enhanceHTML=function(o){var i,t;return o=(o=(o=(o=o.replace(/<(\/)?bold>/g,"<$1strong>")).replace(/<(\/)?italic>/g,"<$1em>")).replace(/<td style=\"([^"]+)\"([^>]*)>/g,'<td class="$1"$2>')).replace(/<named-content content-type="([^"]+)"([^>]*)>([^<]*)<\/named-content>/g,'<span class="$1"$2>$3</span>'),this.citationCitationReferenceMap&&(i=/<xref ref-type="bibr" rid="([^"]+)">([^<]*)<\/xref>/g,t=o.match(i),u.each(t,function(t){var e=t.replace(i,"$1"),n=t.replace(i,"$2"),n='<a href="" data-id="'+this.citationCitationReferenceMap[e]+'" class="annotation citation_reference resource-reference">'+n+"</a>";o=o.replace(t,n)}.bind(this))),o},this.enhanceVideo=function(t,e,n){var o=n.getAttribute("id");n.getAttribute("xlink:href").split(".")[0];"undefined"!=typeof video_data&&o in video_data&&(e.url=video_data[o].mp4_href,e.url_ogv=video_data[o].ogv_href,e.url_webm=video_data[o].webm_href,e.poster=video_data[o].jpg_href)},this.resolveURL=function(t,e){if(e.match(/http:\/\//))return e;var n=this.getBaseURL(t);return n?[n,e].join(""):(e.match(/\.tif$/g)?e=e.replace(/\.tif$/g,".jpg"):e.match(/\.gif$/g)||(e+=".jpg"),["https://cdn.elifesciences.org/articles/",t.doc.id,"/",e].join(""))};var i=/author-callout-style/;this.enhanceAnnotationData=function(t,e,n,o){"named-content"===o&&(n=n.getAttribute("content-type"),i.test(n)&&(e.type="author_callout",e.style=n))},this.back=function(e,t){t=t.querySelectorAll("app-group");t&&0<t.length&&u.each(t,function(t){this.appGroup(e,t)}.bind(this))},this.showNode=function(t,e){e.type,n.showNode.apply(this,arguments)}}).prototype=o.prototype,(t.prototype=new t.Prototype).constructor=t,e.exports=t},{"../substance/util":182,"./lens_converter":130,underscore:185}],129:[function(t,e,n){"use strict";t=t("./lens_converter");e.exports=t},{"./lens_converter":130}],130:[function(t,e,n){"use strict";var d=t("underscore"),f=t("../substance/util"),o=f.errors.define("ImporterError"),i=t("../article"),r=function(t){this.options=t||r.DefaultOptions};r.Prototype=function(){this._annotationTypes={bold:"strong",italic:"emphasis",monospace:"code",sub:"subscript",sup:"superscript",sc:"custom_annotation",roman:"custom_annotation","sans-serif":"custom_annotation","styled-content":"custom_annotation",underline:"underline","ext-link":"link",xref:"",email:"link","named-content":"","inline-formula":"inline-formula",uri:"link"},this._inlineNodeTypes={fn:!0},this._refTypeMapping={bibr:"citation_reference",fig:"figure_reference",table:"figure_reference","supplementary-material":"figure_reference",other:"figure_reference",list:"definition_reference",fn:"footnote_reference"},this._contribTypeMapping={author:"Author","author non-byline":"Author",autahor:"Author",auther:"Author",editor:"Editor","guest-editor":"Guest Editor","group-author":"Group Author",collab:"Collaborator","reviewed-by":"Reviewer","nominated-by":"Nominator",corresp:"Corresponding Author",other:"Other","assoc-editor":"Associate Editor","associate editor":"Associate Editor","series-editor":"Series Editor",contributor:"Contributor",chairman:"Chairman","monographs-editor":"Monographs Editor","contrib-author":"Contributing Author",organizer:"Organizer",chair:"Chair",discussant:"Discussant",presenter:"Presenter","guest-issue-editor":"Guest Issue Editor",participant:"Participant",translator:"Translator"},this.isAnnotation=function(t){return void 0!==this._annotationTypes[t]},this.isInlineNode=function(t){return void 0!==this._inlineNodeTypes[t]},this.isParagraphish=function(t){for(var e=0;e<t.childNodes.length;e++){var n=t.childNodes[e];if(n.nodeType!==Node.TEXT_NODE&&!this.isAnnotation(n.tagName.toLowerCase()))return!1}return!0},this.test=function(t,e){return!0},this.getName=function(t){if(!t)return"N/A";var e=[],n=t.querySelector("surname"),o=t.querySelector("given-names"),t=t.querySelector("suffix");return o&&e.push(o.textContent),n&&e.push(n.textContent),t&&""!==t.textContent.trim()?[e.join(" "),t.textContent].join(", "):e.join(" ")},this.toHtml=function(t){if(!t)return"";var e=document.createElement("DIV");return e.appendChild(t.cloneNode(!0)),e.innerHTML},this.mmlToHtmlString=function(t){return this.toHtml(t).replace(/<(\/)?mml:([^>]+)>/g,"<$1$2>")},this.selectDirectChildren=function(t,e){for(var n=[],o=t.querySelectorAll(e),i=0;i<o.length;i++){var r=o[i];r.parentElement===t&&n.push(r)}return n},this.import=function(t){var e;e=d.isString(t)?(new DOMParser).parseFromString(t,"text/xml"):t,this.sanitizeXML(e);t=this.createDocument();window.doc=t;t=this.createState(e,t);return this.document(t,e)},this.sanitizeXML=function(t){},this.createState=function(t,e){return new r.State(this,t,e)},this.createDocument=function(){return new i},this.show=function(e,t){d.each(t,function(t){this.showNode(e,t)},this)},this.extractDate=function(t){if(!t)return null;var e=t.querySelector("year"),n=t.querySelector("month"),t=t.querySelector("day"),e=[e.textContent];return n&&e.push(n.textContent),t&&e.push(t.textContent),e.join("-")},this.extractPublicationInfo=function(t,e){for(var n=t.doc,o=e.querySelector("article-meta"),i=o.querySelector("pub-date"),r=o.querySelectorAll("history date"),s=e.querySelector("journal-title"),a=e.querySelector("article-id[pub-id-type=doi]"),c=e.querySelector("related-article"),o=this.extractArticleInfo(t,e),e=this.extractFundingInfo(t,e),u={id:"publication_info",type:"publication_info",published_on:this.extractDate(i),journal:s?s.textContent:"",related_article:c?c.getAttribute("xlink:href"):"",doi:a?a.textContent:"",article_info:o.id,funding_info:e,article_type:"",keywords:[],links:[],subjects:[],supplements:[],history:[],research_organisms:[],provider:""},l=0;l<r.length;l++){var p=r[l],p={type:p.getAttribute("date-type"),date:this.extractDate(p)};u.history.push(p)}n.create(u),n.show("info",u.id,0),this.enhancePublicationInfo(t,u)},this.extractArticleInfo=function(t,e){var n={id:"articleinfo",type:"paragraph"},o=t.doc,i=[];return i=(i=(i=(i=(i=(i=i.concat(this.extractEditor(t,e))).concat(this.extractDatasets(t,e))).concat(this.extractCustomMetaGroup(t,e))).concat(this.extractAcknowledgements(t,e))).concat(this.extractCopyrightAndLicense(t,e))).concat(this.extractNotes(t,e)),n.children=i,o.create(n),n},this.extractFundingInfo=function(t,e){var n=[],o=e.querySelectorAll("funding-statement");if(0<o.length)for(var i=0;i<o.length;i++)n.push(this.annotatedText(t,o[i],["publication_info","funding_info",i]));return n},this.extractEditor=function(t,e){var n,o=[],i=t.doc,r=e.querySelector("contrib[contrib-type=editor]");return r&&(n=[],(e=this.getName(r.querySelector("name")))&&n.push(e),(e=r.querySelector("institution"))&&n.push(e.textContent),(r=r.querySelector("country"))&&n.push(r.textContent),r={type:"heading",id:t.nextId("heading"),level:3,content:"Reviewing Editor"},i.create(r),o.push(r.id),n={type:"text",id:t.nextId("text"),content:n.join(", ")},i.create(n),o.push(n.id)),o},this.extractDatasets=function(t,e){for(var n=[],o=t.doc,i=e.querySelectorAll("sec"),r=0;r<i.length;r++){var s=i[r];if("datasets"===s.getAttribute("sec-type")){var a={type:"heading",id:t.nextId("heading"),level:3,content:"Major Datasets"};o.create(a),n.push(a.id);for(var c=this.datasets(t,f.dom.getChildren(s)),u=0;u<c.length;u++)c[u]&&n.push(c[u])}}return n};var n=function(t,e){return e?t.split(" ").map(function(t){return n(t)}).join(" "):t.charAt(0).toUpperCase()+t.slice(1)};this.capitalized=function(t,e){return n(t,e)},this.extractAcknowledgements=function(n,t){var o=[],i=n.doc,t=t.querySelectorAll("ack");return t&&0<t.length&&d.each(t,function(t){var e=t.querySelector("title"),e={type:"heading",id:n.nextId("heading"),level:3,content:e?this.capitalized(e.textContent.toLowerCase(),"all"):"Acknowledgements"};i.create(e),o.push(e.id);t=this.bodyNodes(n,f.dom.getChildren(t),{ignore:["title"]});d.each(t,function(t){o.push(t.id)})},this),o},this.extractNotes=function(t,e){return[]},this.__ignoreCustomMetaNames=[],this.extractCustomMetaGroup=function(t,e){var n=[],o=t.doc,i=e.querySelectorAll("article-meta custom-meta");if(0===i.length)return n;for(var r=0;r<i.length;r++){var s=i[r],a=s.querySelector("meta-name"),c=s.querySelector("meta-value");d.include(this.__ignoreCustomMetaNames,a.textContent)||((s={type:"heading",id:t.nextId("heading"),level:3,content:""}).content=this.annotatedText(t,a,[s.id,"content"]),o.create(s),c=this.paragraphGroup(t,c),n.push(s.id),n=n.concat(d.pluck(c,"id")))}return n},this.extractCopyrightAndLicense=function(t,e){var n=[],o=t.doc,i=e.querySelector("permissions");if(i){e={type:"heading",id:t.nextId("heading"),level:3,content:"Copyright & License"};o.create(e),n.push(e.id);var r,e=i.querySelector("copyright-statement");e&&(r=this.paragraphGroup(t,e))&&r.length&&(n=n.concat(d.map(r,function(t){return t.id})),"."!==e.textContent.trim().slice(-1)&&(e=d.last(d.last(r).children),o.nodes[e].content+=". "));i=i.querySelector("license");if(i)for(var s=i.firstElementChild;s;s=s.nextElementSibling){var a=f.dom.getNodeType(s);"p"!==a&&"license-p"!==a||(r=this.paragraphGroup(t,s))&&r.length&&(n=n.concat(d.pluck(r,"id")))}}return n},this.extractCover=function(o,t){var i=o.doc,e=i.get("document"),r={id:"cover",type:"cover",title:e.title,authors:[],abstract:e.abstract};d.each(e.authors,function(t){var e=i.get(t),n={id:"text_"+t+"_reference",type:"text",content:e.name};i.create(n),r.authors.push(n.id);t={id:o.nextId("contributor_reference"),type:"contributor_reference",path:["text_"+t+"_reference","content"],range:[0,e.name.length],target:t};i.create(t)},this),this.enhanceCover(o,r,t),i.create(r),i.show("content",r.id,0)},this.contribGroup=function(t,e){for(var n=e.querySelectorAll("contrib"),o=0;o<n.length;o++)this.contributor(t,n[o]);var i=t.doc,e=e.querySelector("on-behalf-of");e&&(i.on_behalf_of=e.textContent.trim())},this.affiliation=function(t,e){var n,o=t.doc,i=e.querySelector("institution[content-type=dept]");n=i?e.querySelector("institution:not([content-type=dept])"):(i=e.querySelector("addr-line named-content[content-type=department]"),e.querySelector("institution"));var r=e.querySelector("country"),s=e.querySelector("label"),a=e.querySelector("addr-line named-content[content-type=city]"),c=e.getAttribute("specific-use"),c={id:t.nextId("affiliation"),type:"affiliation",source_id:e.getAttribute("id"),label:s?s.textContent:null,department:i?i.textContent:null,city:a?a.textContent:null,institution:n?n.textContent:null,country:r?r.textContent:null,specific_use:c||null};o.create(c)},this.contributor=function(n,t){var e=n.doc,o=n.nextId("contributor"),i={id:o,source_id:t.getAttribute("id"),type:"contributor",name:"",affiliations:[],fundings:[],bio:[],image:"",deceased:!1,emails:[],contribution:"",members:[]},r=t.getAttribute("contrib-type");i.contributor_type=this._contribTypeMapping[r];r=t.querySelector("role");r&&(i.role=r.textContent);r=t.querySelector("bio");r&&d.each(f.dom.getChildren(r),function(t){var e=t.querySelector("graphic");e?(e=e.getAttribute("xlink:href"),i.image=e):0<(t=this.paragraphGroup(n,t)).length&&(i.bio=[t[0].id])},this),"yes"===t.getAttribute("deceased")&&(i.deceased=!0);r=t.querySelector("uri[content-type=orcid]");r&&(i.orcid=r.getAttribute("xlink:href"));r=t.querySelector("name");r?i.name=this.getName(r):(r=t.querySelector("collab"),i.name=r?r.textContent:"N/A"),this.extractContributorProperties(n,t,i),0===i.affiliations.length&&(i.affiliations=n.affiliations),1<i.competing_interests.length&&(i.competing_interests=d.filter(i.competing_interests,function(t){return t.indexOf("no competing")<0})),"author"===t.getAttribute("contrib-type")&&e.nodes.document.authors.push(o),e.create(i),e.show("info",i.id)},this._getEqualContribs=function(t,e,n){var o=[],n=t.xmlDoc.querySelectorAll("xref[rid="+n+"]");return d.each(n,function(t){t=t.parentNode;t!==e&&o.push(this.getName(t.querySelector("name")))},this),o},this.extractContributorProperties=function(a,c,u){var l=a.doc,p=[],h=[],t=c.querySelectorAll("xref");d.each(t,function(t){if("aff"===t.getAttribute("ref-type")){var e=t.getAttribute("rid"),n=l.getNodeBySourceId(e);n&&(u.affiliations.push(n.id),a.used[e]=!0)}else if("other"===t.getAttribute("ref-type")){console.log("FIXME: please add documentation about using 'other' as indicator for extracting an awardGroup.");n=a.xmlDoc.getElementById(t.getAttribute("rid"));n&&((e=n.querySelector("funding-source"))&&(o=(o=n.querySelector("award-id"))?", "+o.textContent:"",e=(e.querySelector("institution")||e.childNodes[0]).textContent,u.fundings.push([e,o].join(""))))}else if("corresp"===t.getAttribute("ref-type")){var o=t.getAttribute("rid"),o=a.xmlDoc.getElementById(o);o&&((i=o.querySelector("email"))&&u.emails.push(i.textContent))}else if("fn"===t.getAttribute("ref-type")){var i=t.getAttribute("rid"),r=a.xmlDoc.getElementById(i),s=!0;if(r){switch(r.getAttribute("fn-type")){case"con":0<=r.getAttribute("id").indexOf("equal-contrib")?p=this._getEqualContribs(a,c,r.getAttribute("id")):u.contribution=r.textContent;break;case"conflict":h.push(r.textContent.trim());break;case"present-address":u.present_address=r.querySelector("p").textContent;break;case"equal":console.log("FIXME: isn't fnElem.getAttribute(id) === fnId?"),p=this._getEqualContribs(a,c,r.getAttribute("id"));break;case"other":console.log("FIXME: isn't fnElem.getAttribute(id) === fnId?"),0<=r.getAttribute("id").indexOf("equal-contrib")?p=this._getEqualContribs(a,c,r.getAttribute("id")):s=!1;break;default:s=!1}s&&(a.used[i]=!0)}}else console.log("Skipping contrib's xref",t.textContent)},this),1<h.length&&(h=d.filter(h,function(t){return t.indexOf("no competing")<0})),u.competing_interests=h;t=c.querySelector("xref[ref-type=other]");t&&(t=t.getAttribute("rid"),t=a.xmlDoc.querySelectorAll("#"+t+" contrib"),u.members=d.map(t,function(t){return this.getName(t.querySelector("name"))},this)),u.equal_contrib=p,u.competing_interests=h},this.document=function(t,e){var n=t.doc,e=e.querySelector("article");if(!e)throw new o("Expected to find an 'article' element.");return this.article(t,e),this.postProcess(t),d.each(n.containers,function(t){t.rebuild()}),n},this.postProcess=function(t){this.postProcessAnnotations(t)},this.postProcessAnnotations=function(t){for(var e=0;e<t.annotations.length;e++){var n,o=t.annotations[e];!o.target||(n=t.doc.getNodeBySourceId(o.target))&&(o.target=n.id),t.doc.create(t.annotations[e])}},this.article=function(t,e){var n=t.doc,o=e.querySelector("article-id");n.id=o?o.textContent:f.uuid(),this.extractDefinitions(t,e),this.extractAffilitations(t,e),this.extractContributors(t,e),this.extractCitations(t,e),this.extractCover(t,e),this.extractArticleMeta(t,e),this.extractPublicationInfo(t,e);o=e.querySelector("body");o&&this.body(t,o),this.extractFigures(t,e),this.extractFootNotes(t,e);o=e.querySelector("back");o&&this.back(t,o),this.enhanceArticle(t,e)},this.extractDefinitions=function(n){var t=n.xmlDoc.querySelectorAll("def-item");d.each(t,function(t){var e=t.querySelector("term"),t=t.querySelector("def"),t={id:t.id||t.getAttribute("hwp:id")||n.nextId("definition"),type:"definition",title:e.textContent,description:t.textContent};n.doc.create(t),n.doc.show("definitions",t.id)})},this.extractArticleMeta=function(t,e){var n=e.querySelector("article-meta");if(!n)throw new o("Expected element: 'article-meta'");e=n.querySelectorAll("article-id");this.articleIds(t,e);e=n.querySelector("title-group");e&&this.titleGroup(t,e);e=n.querySelectorAll("pub-date");this.pubDates(t,e),this.abstracts(t,n)},this.extractAffilitations=function(t,e){for(var n=e.querySelectorAll("aff"),o=0;o<n.length;o++)this.affiliation(t,n[o])},this.extractContributors=function(t,e){e=e.querySelector("article-meta contrib-group");e&&this.contribGroup(t,e)},this.extractFigures=function(t,e){for(var n=e.querySelectorAll("fig, table-wrap, supplementary-material, media[mimetype=video]"),o=[],i=0;i<n.length;i++){var r,s,a=n[i];a._converted||(s=null,"fig"===(r=f.dom.getNodeType(a))?s=this.figure(t,a):"table-wrap"===r?s=this.tableWrap(t,a):"media"===r?s=this.video(t,a):"supplementary-material"===r&&(s=this.supplement(t,a)),s&&o.push(s))}this.show(t,o)},this.extractFootNotes=function(t,e){for(var n=e.querySelectorAll("fn"),o=0;o<n.length;o++){var i=n[o];i.__converted__||this.footnote(t,i)}},this.extractCitations=function(t,e){e=e.querySelector("ref-list");e&&this.refList(t,e)},this.articleIds=function(t,e){t=t.doc;0<e.length?t.id=e[0].textContent:t.id=f.uuid()},this.titleGroup=function(t,e){var n=t.doc,e=e.querySelector("article-title");e&&(n.title=this.annotatedText(t,e,["document","title"],{ignore:["xref"]}))},this.pubDates=function(t,e){var n=t.doc;0<e.length&&(e=this.pubDate(t,e[0]),n.created_at=e.date)},this.pubDate=function(t,e){var n=-1,o=-1,i=-1;return d.each(f.dom.getChildren(e),function(t){var e=f.dom.getNodeType(t),t=t.textContent;"day"===e?n=parseInt(t,10):"month"===e?o=parseInt(t,10):"year"===e&&(i=parseInt(t,10))},this),{date:new Date(i,o,n)}},this.abstracts=function(e,t){t=t.querySelectorAll("abstract");d.each(t,function(t){this.abstract(e,t)},this)},this.abstract=function(t,e){var n=t.doc,o=[],i=e.querySelector("title"),i={id:t.nextId("heading"),type:"heading",level:1,content:i?i.textContent:"Abstract"};n.create(i),o.push(i),0<(o=o.concat(this.bodyNodes(t,f.dom.getChildren(e),{ignore:["title","object-id"]}))).length&&this.show(t,o)},this.body=function(t,e){t.doc;e=this.bodyNodes(t,f.dom.getChildren(e));0<e.length&&this.show(t,e)},this._ignoredBodyNodes={fig:!0,"table-wrap":!0},this._bodyNodes={},this.bodyNodes=function(t,e,n){for(var o=[],i=0;i<e.length;i++){var r,s=e[i],a=f.dom.getNodeType(s);this._bodyNodes[a]?(r=this._bodyNodes[a].call(this,t,s),d.isArray(r)?o=o.concat(r):r&&o.push(r)):this._ignoredBodyNodes[a]||n&&n.ignore&&0<=n.ignore.indexOf(a)?(r=this.ignoredNode(t,s,a))&&o.push(r):console.error("Node not supported as block-level element: "+a+"\n"+s.outerHTML)}return o},this._bodyNodes.p=function(t,e){return this.paragraphGroup(t,e)},this._bodyNodes.sec=function(t,e){return this.section(t,e)},this._bodyNodes.list=function(t,e){return this.list(t,e)},this._bodyNodes["disp-formula"]=function(t,e){return this.formula(t,e)},this._bodyNodes.caption=function(t,e){return this.caption(t,e)},this._bodyNodes["boxed-text"]=function(t,e){return this.boxedText(t,e)},this._bodyNodes["disp-quote"]=function(t,e){return this.quoteText(t,e)},this._bodyNodes.attrib=function(t,e){return this.paragraphGroup(t,e)},this._bodyNodes.comment=function(t,e){return this.comment(t,e)},this.ignoredNode=function(){},this.comment=function(){return null},this.boxedText=function(t,e){var n=t.doc,o=this.bodyNodes(t,f.dom.getChildren(e)),i=t.nextId("box"),t=this.selectDirectChildren(e,"label")[0],o={type:"box",id:i,source_id:e.getAttribute("id"),label:t?t.textContent:"",children:d.pluck(o,"id")};return n.create(o),o},this.quoteText=function(t,e){var n=t.doc,o=this.bodyNodes(t,f.dom.getChildren(e)),o={type:"quote",id:t.nextId("quote"),source_id:e.getAttribute("id"),label:"",children:d.pluck(o,"id")};return n.create(o),o},this.datasets=function(t,e){for(var n=[],o=0;o<e.length;o++){var i,r=e[o];"p"===f.dom.getNodeType(r)&&((i=r.querySelector("related-object"))?n=n.concat(this.indivdata(t,i)):0<(r=this.paragraphGroup(t,r)).length&&n.push(r[0].id))}return n},this.indivdata=function(t,e){var n=t.doc,o={type:"paragraph",id:t.nextId("paragraph"),children:[]},i={type:"text",id:t.nextId("text"),content:""};o.children.push(i.id);for(var r=f.dom.getChildren(e),s=0;s<r.length;s++){var a=r[s];if("name"===f.dom.getNodeType(a))for(var c=f.dom.getChildren(a),u=0;u<c.length;u++){var l,p=c[u],h=(0===u||(l={type:"text",id:t.nextId("text"),content:", "},n.create(l),o.children.push(l.id)),this.paragraphGroup(t,p));o.children.push(h[0].children[0])}else(h=this.paragraphGroup(t,a))&&h[0]&&h[0].children&&o.children.push(h[0].children[0])}return n.create(o),n.create(i),o.id},this.section=function(t,e){t.sectionLevel++;var n=t.doc,o=f.dom.getChildren(e),i=[],r=this.selectDirectChildren(e,"label")[0],s=this.selectDirectChildren(e,"title")[0];return s||console.error("FIXME: every section should have a title",this.toHtml(e)),0<(i=i.concat(this.bodyNodes(t,o,{ignore:["title","label"]}))).length&&s?(o={id:o=t.nextId("heading"),source_id:e.getAttribute("id"),type:"heading",level:t.sectionLevel,content:s?this.annotatedText(t,s,[o,"content"]):""},r&&(o.label=r.textContent),0<o.content.length&&(n.create(o),i.unshift(o))):0===i.length&&console.info("NOTE: skipping section without content:",s?s.innerHTML:"no title"),t.sectionLevel--,i},this.ignoredParagraphElements={comment:!0,"supplementary-material":!0,fig:!0,"fig-group":!0,"table-wrap":!0,media:!0},this.acceptedParagraphElements={"boxed-text":{handler:"boxedText"},"disp-quote":{handler:"quoteText"},list:{handler:"list"},"disp-formula":{handler:"formula"}},this.inlineParagraphElements={"inline-graphic":!0,"inline-formula":!0,fn:!0},this.segmentParagraphElements=function(t){for(var e=[],n="",o=new f.dom.ChildNodeIterator(t);o.hasNext();){var i=o.next(),r=f.dom.getNodeType(i);this.ignoredParagraphElements[r]||(this.acceptedParagraphElements[r]?(e.push(d.extend({node:i},this.acceptedParagraphElements[r])),n=r):("paragraph"!==n&&(e.push({handler:"paragraph",nodes:[]}),n="paragraph"),d.last(e).nodes.push(i)))}return e},this.paragraphGroup=function(t,e){for(var n=[],o=this.segmentParagraphElements(e),i=0;i<o.length;i++){var r,s=o[i];"paragraph"===s.handler?(r=this.paragraph(t,s.nodes))&&(r.source_id=e.getAttribute("id")):r=this[s.handler](t,s.node),r&&n.push(r)}return n},this.paragraph=function(t,e){var n=t.doc;t.skipWS=!0;for(var o={id:t.nextId("paragraph"),type:"paragraph",children:null},i=[],r=new f.dom.ChildNodeIterator(e);r.hasNext();){var s,a,c=r.next(),u=f.dom.getNodeType(c);"text"===u||this.isAnnotation(u)||this.isInlineNode(u)?(a={id:t.nextId("text"),type:"text",content:null},t.stack.push({path:[a.id,"content"]}),0<(s=this._annotatedText(t,r.back(),{offset:0,breakOnUnknown:!1})).length&&(a.content=s,n.create(a),i.push(a)),t.stack.pop()):"inline-graphic"===u?(a=c.getAttribute("xlink:href"),a={id:t.nextId("image"),type:"image",url:this.resolveURL(t,a)},n.create(a),i.push(a)):"inline-formula"!==u||(c=this.formula(t,c,"inline"))&&i.push(c)}return 0===i.length?null:(o.children=d.map(i,function(t){return t.id}),n.create(o),o)},this.list=function(t,e){var n=t.doc,o={id:t.nextId("list"),source_id:e.getAttribute("id"),type:"list",items:[],ordered:!1};"ordered"===e.getAttribute("list-type")&&(o.ordered=!0);for(var i=e.querySelectorAll("list-item"),r=0;r<i.length;r++){var s=i[r];if(s.parentNode===e)for(var a=this.bodyNodes(t,f.dom.getChildren(s)),c=0;c<a.length;c++)o.items.push(a[c].id)}return n.create(o),o},this.figure=function(t,e){var n=t.doc,o={type:"figure",id:t.nextId("figure"),source_id:e.getAttribute("id"),label:"Figure",url:"",caption:null},i=e.querySelector("label");i&&(o.label=this.annotatedText(t,i,[o.id,"label"]));i=e.querySelector("caption");!i||(r=this.caption(t,i))&&(o.caption=r.id);var r=e.querySelector("attrib");r&&(o.attrib=r.textContent);r=e.getAttribute("position");return r&&(o.position=r||""),this.enhanceFigure(t,o,e),n.create(o),e._converted=!0,o},this.supplement=function(t,e){var n=t.doc,o=e.querySelector("label"),i=e.querySelector("media"),r=i?i.getAttribute("xlink:href"):null,i=(i=e.querySelector("object-id[pub-id-type='doi']"))?"http://dx.doi.org/"+i.textContent:"",o={id:t.nextId("supplement"),source_id:e.getAttribute("id"),type:"supplement",label:o?o.textContent:"",url:r,caption:null},r=e.querySelector("caption");return!r||(r=this.caption(t,r))&&(o.caption=r.id),this.enhanceSupplement(t,o,e),n.create(o),o},this.caption=function(e,n){var t=e.doc,o={id:e.nextId("caption"),source_id:n.getAttribute("id"),type:"caption",title:"",children:[]},i=n.querySelector("title");!i||(s=this.paragraph(e,i))&&(o.title=s.id);var r=[],s=n.querySelectorAll("p");return d.each(s,function(t){t.parentNode!==n||(t=this.paragraph(e,t))&&r.push(t.id)},this),o.children=r,t.create(o),o},this.video=function(t,e){var n=t.doc,o=e.querySelector("label").textContent,i={id:t.nextId("video"),source_id:e.getAttribute("id"),type:"video",label:o,title:"",caption:null,poster:""},o=e.querySelector("caption");return!o||(o=this.caption(t,o))&&(i.caption=o.id),this.enhanceVideo(t,i,e),n.create(i),i},this.tableWrap=function(t,e){var n=t.doc,o=e.querySelector("label"),i={id:t.nextId("html_table"),source_id:e.getAttribute("id"),type:"html_table",title:"",label:o?o.textContent:"Table",content:"",caption:null,footers:[]},r=e.querySelectorAll("table");if(r)for(var s=0;s<r.length;s++)i.content+=this.toHtml(r[s]);return this.extractTableCaption(t,i,e),this.enhanceTable(t,i,e),n.create(i),i},this.extractTableCaption=function(t,e,n){var o=n.querySelector("caption");o?(o=this.caption(t,o))&&(e.caption=o.id):console.error("caption node not found for",n)},this._getFormulaData=function(t){for(var e=[],n=t.firstElementChild;n;n=n.nextElementSibling){var o=f.dom.getNodeType(n);switch(o){case"graphic":case"inline-graphic":e.push({format:"image",data:n.getAttribute("xlink:href")});break;case"svg":e.push({format:"svg",data:this.toHtml(n)});break;case"mml:math":case"math":e.push({format:"mathml",data:this.mmlToHtmlString(n)});break;case"tex-math":e.push({format:"latex",data:n.textContent});break;case"label":break;default:console.error("Unsupported formula element of type "+o)}}return e},this.formula=function(t,e,n){var o=t.doc,i={id:t.nextId("formula"),source_id:e.getAttribute("id"),type:"formula",label:"",inline:!!n,data:[],format:[]},t=e.querySelector("label");t&&(i.label=t.textContent);for(var r=this._getFormulaData(e,n),s=0;s<r.length;s++)i.format.push(r[s].format),i.data.push(r[s].data);return o.create(i),i},this.footnote=function(t,e){var n=t.doc,o={type:"footnote",id:t.nextId("fn"),source_id:e.getAttribute("id"),label:"",children:[]},i=e.children,r=0;for("label"===i[r].tagName.toLowerCase()&&(o.label=this.annotatedText(t,i[r],[o.id,"label"]),r++),o.children=[];r<i.length;r++){var s=this.paragraphGroup(t,i[r]);Array.prototype.push.apply(o.children,d.pluck(s,"id"))}return n.create(o),e.__converted__=!0,o},this.citationTypes={"mixed-citation":!0,"element-citation":!0},this.refList=function(t,e){for(var n=e.querySelectorAll("ref"),o=0;o<n.length;o++)this.ref(t,n[o])},this.ref=function(t,e){for(var n=f.dom.getChildren(e),o=0;o<n.length;o++){var i=n[o],r=f.dom.getNodeType(i);this.citationTypes[r]?this.citation(t,e,i):"label"===r||console.error("Not supported in 'ref': ",r)}},this.citation=function(t,e,n){var o,i=t.doc,r=t.nextId("article_citation"),s=n.querySelector("person-group");if(s){o={id:r,source_id:e.getAttribute("id"),type:"citation",title:"N/A",label:"",authors:[],doi:"",source:"",volume:"",fpage:"",lpage:"",citation_urls:[]};for(var a=s.querySelectorAll("name"),c=0;c<a.length;c++)o.authors.push(this.getName(a[c]));var u=s.querySelectorAll("collab");for(c=0;c<u.length;c++)o.authors.push(u[c].textContent);var l=n.querySelector("source");l&&(o.source=l.textContent);s=n.querySelector("article-title");s?o.title=this.annotatedText(t,s,[r,"title"]):(s=n.querySelector("comment"))?o.title=this.annotatedText(t,s,[r,"title"]):l?o.title=this.annotatedText(t,l,[r,"title"]):console.error("FIXME: this citation has no title",n);l=n.querySelector("volume");l&&(o.volume=l.textContent);l=n.querySelector("publisher-loc");l&&(o.publisher_location=l.textContent);l=n.querySelector("publisher-name");l&&(o.publisher_name=l.textContent);l=n.querySelector("fpage");l&&(o.fpage=l.textContent);l=n.querySelector("lpage");l&&(o.lpage=l.textContent);l=n.querySelector("year");l&&(o.year=l.textContent);e=e.querySelector("label");e&&(o.label=e.textContent);e=n.querySelector("pub-id[pub-id-type='doi'], ext-link[ext-link-type='doi']");return e&&(o.doi="http://dx.doi.org/"+e.textContent),i.create(o),i.show("citations",r),o}console.error("FIXME: there is one of those 'mixed-citation' without any structure. Skipping ...",n)},this.back=function(e,t){var n=t.querySelectorAll("app-group");n&&0<n.length?d.each(n,function(t){this.appGroup(e,t)}.bind(this)):this.appGroup(e,t)},this.appGroup=function(e,t){var n=t.querySelectorAll("app"),o=e.doc,t=t.querySelector("title");t||console.error("FIXME: every app should have a title",this.toHtml(t));t=e.nextId("heading"),t=o.create({type:"heading",id:t,level:1,content:"Appendices"});this.show(e,[t]),d.each(n,function(t){e.sectionLevel=2,this.app(e,t)}.bind(this))},this.app=function(t,e){var n=t.doc,o=[],i=e.querySelector("title");i||console.error("FIXME: every app should have a title",this.toHtml(i));var r=t.nextId("heading"),r={type:"heading",id:r,level:2,content:i?this.annotatedText(t,i,[r,"content"]):""},r=n.create(r);o.push(r);e=this.bodyNodes(t,f.dom.getChildren(e),{ignore:["title","label","ref-list"]});d.each(e,function(t){o.push(t)}),this.show(t,o)},this.createAnnotation=function(t,e,n,o){var i;n!==o&&(i=e.tagName.toLowerCase(),o={type:"annotation",path:d.last(t.stack).path,range:[n,o]},this.addAnnotationData(t,o,e,i),this.enhanceAnnotationData(t,o,e,i),o.id=t.nextId(o.type),t.annotations.push(o))},this.addAnnotationData=function(t,e,n,o){var i;e.type=this._annotationTypes[o]||"annotation","xref"===o?this.addAnnotationDataForXref(t,e,n):"ext-link"===o||"uri"===o?(e.url=n.getAttribute("xlink:href"),i=n.getAttribute("ext-link-type")||"","uri"!==o&&"uri"!==i.toLowerCase()||/^\w+:\/\//.exec(e.url)||/^\//.exec(e.url)?"doi"===i.toLowerCase()&&(e.url=["http://dx.doi.org/",e.url].join("")):e.url="http://"+e.url):"email"===o?e.url="mailto:"+n.textContent.trim():"inline-graphic"===o?e.url=n.getAttribute("xlink:href"):"inline-formula"===o?(n=this.formula(t,n,"inline"),e.target=n.id):"custom_annotation"===e.type&&(e.name=o)},this.addAnnotationDataForXref=function(t,e,n){var o=n.getAttribute("ref-type"),n=n.getAttribute("rid");e.type=this._refTypeMapping[o]||"cross_reference",n&&(e.target=n)},this.createInlineNode=function(t,e,n){n={type:"inline-node",path:d.last(t.stack).path,range:[n,n+1]};this.addInlineNodeData(t,n,e),this.enhanceInlineNodeData(t,n,e),n.id=t.nextId(n.type),t.annotations.push(n)},this.addInlineNodeData=function(t,e,n){"fn"===n.tagName.toLowerCase()&&(n=this.footnote(t,n),e.type="footnote_reference",e.target=n.id,e.generated=!0)},this.enhanceInlineNodeData=function(t,e,n,o){},this.annotatedText=function(t,e,n,o){o=o||{},t.stack.push({path:n,ignore:o.ignore});e=new f.dom.ChildNodeIterator(e),o=this._annotatedText(t,e,o);return t.stack.pop(),o},this._annotatedText=function(t,e,n){for(var o="",i=void 0===n.offset?0:n.offset,r=!!n.nested,s=!!n.breakOnUnknown;e.hasNext();){var a=e.next();if(a.nodeType===Node.TEXT_NODE){var c=t.acceptText(a.textContent);o+=c,i+=c.length}else{var u,l=f.dom.getNodeType(a);if(this.isAnnotation(l))t.top().ignore.indexOf(l)<0&&(c=i,o+=u=this._annotationTextHandler[l]?this._annotationTextHandler[l].call(this,t,a,l,i):this._getAnnotationText(t,a,l,i),i+=u.length,t.ignoreAnnotations||this.createAnnotation(t,a,c,i));else if(this.isInlineNode(l))o+=" ",this.createInlineNode(t,a,i);else if(s){if(!r){e.back();break}console.error("Node not supported in annoted text: "+l+"\n"+a.outerHTML)}else t.top().ignore.indexOf(l)<0&&(o+=u=this._getAnnotationText(t,a,l,i),i+=u.length)}}return o},this._annotationTextHandler={},this._getAnnotationText=function(t,e,n,o){e=new f.dom.ChildNodeIterator(e);return this._annotatedText(t,e,{offset:o,nested:!0})},this._annotationTextHandler["ext-link"]=function(t,e,n,o){o=this._getAnnotationText(t,e,o);return"ext-link"===n&&e.getAttribute("xlink:href")===o.trim()&&(o=this.shortenLinkLabel(t,o)),o},this._annotationTextHandler["inline-formula"]=function(t){return t.acceptText("{{inline-formula}}")},this.shortenLinkLabel=function(t,e){var n,o,i;return 50<e.length&&(e=(i=/((?:\w+:\/\/)?[\/]?[^\/]+[\/]?)(.*)/.exec(e))?(n=i[1]||"",o=i[2]||"",40<n.length?n.substring(0,40)+"..."+o.substring(o.length-10-3):(i=Math.max(50-n.length-3,7),n+"..."+o.substring(o.length-i))):e.substring(0,40)+"..."+e.substring(e.length-10-3)),e},this.getBaseURL=function(t){return t.xmlDoc.querySelector("article").getAttribute("xml:base")||t.options.baseURL},this.enhanceArticle=function(t,e){},this.enhanceCover=function(t,e,n){},this.enhanceFigure=function(t,e,n){n=n.querySelector("graphic").getAttribute("xlink:href");e.url=this.resolveURL(t,n)},this.enhancePublicationInfo=function(t,e,n){},this.enhanceSupplement=function(t,e,n){},this.enhanceTable=function(t,e,n){},this.enhanceVideo=function(t,e,n){var o,n=n.getAttribute("xlink:href");n.match(/http:/)?(o=n.lastIndexOf("."),o=n.substring(0,o),e.url=o+".mp4",e.url_ogv=o+".ogv",e.url_webm=o+".webm",e.poster=o+".png"):(t=this.getBaseURL(t),o=n.split(".")[0],e.url=t+o+".mp4",e.url_ogv=t+o+".ogv",e.url_webm=t+o+".webm",e.poster=t+o+".png")},this.resolveURL=function(t,e){return e.match(/http:/)?e:[t.options.baseURL,e].join("")},this.viewMapping={box:"content",supplement:"figures",figure:"figures",html_table:"figures",video:"figures"},this.enhanceAnnotationData=function(t,e,n,o){},this.showNode=function(t,e){var n=this.viewMapping[e.type]||"content";t.doc.show(n,e.id)}},r.State=function(t,e,n){var o=this;this.xmlDoc=e,this.doc=n,this.options=t.options,this.annotations=[],this.stack=[],this.sectionLevel=0,this.affiliations=[];var i={};this.nextId=function(t){return i[t]=i[t]||0,i[t]++,t+"_"+i[t]},this.used={};var r=/^\s+/g,s=/^\s*/g,a=/\s+$/g,c=/\s+/g,u=/[\t\n\r]+/g;this.lastChar="",this.skipWS=!1,this.acceptText=function(t){return this.options.TRIM_WHITESPACES&&(t=t.replace(u,""),t=" "===this.lastChar||this.skipWS?t.replace(s,""):t.replace(r," "),this.skipWS=!1,t=t.replace(a," "),this.options.REMOVE_INNER_WS&&(t=t.replace(c," ")),this.lastChar=t[t.length-1]||this.lastChar),t},this.top=function(){var t=d.last(o.stack);return(t=t||{}).ignore=t.ignore||[],t}},r.prototype=new r.Prototype,(r.prototype.constructor=r).DefaultOptions={TRIM_WHITESPACES:!0,REMOVE_INNER_WS:!0},e.exports=r},{"../article":6,"../substance/util":182,underscore:185}],131:[function(t,e,n){var o=t("./panels/container_panel"),i=new o({type:"resource",name:"figures",container:"figures",title:"Figures",icon:"fa-picture-o",references:["figure_reference"],zoom:!0}),r=new o({type:"resource",name:"citations",container:"citations",title:"References",icon:"fa-link",references:["citation_reference"]}),t=new o({type:"resource",name:"definitions",container:"definitions",title:"Glossary",icon:"fa-book",references:["definition_reference"]}),o=new o({type:"resource",name:"info",container:"info",title:"Info",icon:"fa-info",references:["contributor_reference"]});e.exports=[i,r,t,o]},{"./panels/container_panel":138}],132:[function(t,e,n){var o=t("./workflows/toggle_resource_reference"),i=t("./workflows/follow_crossrefs"),t=t("./workflows/jump_to_top"),t=[new o,new i,new t];e.exports=t},{"./workflows/follow_crossrefs":154,"./workflows/jump_to_top":155,"./workflows/toggle_resource_reference":156}],133:[function(t,e,n){e.exports=t("./lens")},{"./lens":134}],134:[function(t,e,n){"use strict";function o(t){(t=t||{}).routes=t.routes||this.getRoutes(),t.panels=t.panels||this.getPanels(),t.workflows=t.workflows||this.getWorkflows(),t.converters=this.getConverters(t.converterOptions),s.call(this,t),this.controller=t.controller||this.createController(t)}var i=t("./lens_controller"),r=t("../converter"),s=t("../substance/application"),a=t("../article"),c=t("./panels/resource_panel_viewfactory"),u=t("./reader_controller"),l=t("./reader_view"),p=t("./panels/panel"),h=t("./panels/panel_controller"),d=t("./panels/panel_view"),f=t("./panels/container_panel"),g=t("./panels/container_panel_controller"),y=t("./panels/container_panel_view"),m=t("./workflows/workflow"),v=t("./default_panels"),b=t("./default_workflows");(o.Prototype=function(){this.start=function(){s.prototype.start.call(this)},this.render=function(){this.view=this.controller.createView(),this.$el.html(this.view.render().el)},this.getRoutes=function(){return o.getDefaultRoutes()},this.getPanels=function(){return o.getDefaultPanels()},this.getWorkflows=function(){return o.getDefaultWorkflows()},this.getConverters=function(t){return[o.getDefaultConverter(t)]},this.createController=function(t){return new i(t)}}).prototype=s.prototype,((o.prototype=new o.Prototype).constructor=o).DEFAULT_ROUTES=[{route:":context/:focussedNode/:fullscreen",name:"document-focussed-fullscreen",command:"openReader"},{route:":context/:focussedNode",name:"document-focussed",command:"openReader"},{route:":context",name:"document-context",command:"openReader"},{route:"url/:url",name:"document",command:"openReader"},{route:"",name:"document",command:"openReader"}],o.getDefaultRoutes=function(){return o.DEFAULT_ROUTES},o.getDefaultPanels=function(){return v.slice(0)},o.getDefaultWorkflows=function(){return b.slice(0)},o.getDefaultConverter=function(t){return new r(t)},o.Article=a,o.ReaderController=u,o.ReaderView=l,o.Controller=i,o.LensController=i,o.Panel=p,o.PanelController=h,o.PanelView=d,o.ContainerPanel=f,o.ContainerPanelController=g,o.ContainerPanelView=y,o.ResourcePanelViewFactory=c,o.Workflow=m,e.exports=o},{"../article":6,"../converter":129,"../substance/application":160,"./default_panels":131,"./default_workflows":132,"./lens_controller":135,"./panels/container_panel":138,"./panels/container_panel_controller":139,"./panels/container_panel_view":140,"./panels/panel":147,"./panels/panel_controller":148,"./panels/panel_view":149,"./panels/resource_panel_viewfactory":150,"./reader_controller":152,"./reader_view":153,"./workflows/workflow":157}],135:[function(t,e,n){"use strict";var o=t("underscore"),i=t("../substance/util"),r=t("../substance/application").Controller,s=t("./lens_view"),a=t("./reader_controller"),c=t("../article"),u=t("../converter"),t=function(t){r.call(this),this.config=t,this.Article=t.articleClass||c,this.converter=t.converter,this.converters=t.converters,this.converterOptions=o.extend({},u.DefaultOptions,t.converterOptions),this.on("open:reader",this.openReader)};(t.Prototype=function(){this.createView=function(){var t=new s(this);return this.view=t},this.importXML=function(t){t=(new DOMParser).parseFromString(t,"text/xml"),t=this.convertDocument(t);this.createReader(t,{panel:"toc"})},this.updatePath=function(t){var e=[];e.push(t.panel),t.focussedNode&&e.push(t.focussedNode),t.fullscreen&&e.push("fullscreen"),window.app.router.navigate(e.join("/"),{trigger:!1,replace:!1})},this.createReader=function(t,e){var n=this;this.reader=new a(t,e,this.config),this.reader.on("state-changed",function(){n.updatePath(n.reader.state)}),this.modifyState({context:"reader"})},this.convertDocument=function(t){for(var e,n=0;!e&&n<this.converters.length;){var o=this.converters[n];o.test(t,this.config.document_url)&&(e=o.import(t)),n+=1}if(!e)throw new Error("No suitable converter found for this document",t);return e},this.openReader=function(t,e,n){var o=this,i={panel:t||"toc",focussedNode:e,fullscreen:!!n};this.reader?this.reader.modifyState(i):"lens_article.xml"===this.config.document_url?(n=this.Article.describe(),o.createReader(n,i)):(this.trigger("loading:started","Loading article"),$.get(this.config.document_url).done(function(t){t=$.isXMLDoc(t)?o.convertDocument(t):("string"==typeof t&&(t=$.parseJSON(t)),o.Article.fromSnapshot(t));"toc"===i.panel&&t.getHeadings().length<=2&&(i.panel="info"),o.createReader(t,i)}).fail(function(t){o.view.startLoading("Error during loading. Please try again."),console.error(t)}))}}).prototype=r.prototype,t.prototype=new t.Prototype,o.extend(t.prototype,i.Events),e.exports=t},{"../article":6,"../converter":129,"../substance/application":160,"../substance/util":182,"./lens_view":137,"./reader_controller":152,underscore:185}],136:[function(t,e,n){var o=t("underscore"),i=t("../substance/application").View,t=function(t,e){i.call(this,e),this.docCtrl=t,this.options=e,this.document=t.getDocument(),this.options.viewFactory?this.viewFactory=this.options.viewFactory:this.viewFactory=new this.document.constructor.ViewFactory(this.document.nodeTypes),this.$el.addClass("surface"),this.$nodes=$("<div>").addClass("nodes"),this.$el.append(this.$nodes)};(t.Prototype=function(){this.render=function(){return this.$nodes.html(this.build()),this},this.findNodeView=function(t){return this.el.querySelector("*[data-id="+t+"]")},this.build=function(){var n=document.createDocumentFragment();o.each(this.nodes,function(t){t.dispose()}),this.nodes={};var t=this.docCtrl.container.getTopLevelNodes();return o.each(t,function(t){var e=this.renderNodeView(t);this.nodes[t.id]=e,n.appendChild(e.el)},this),n},this.renderNodeView=function(t){t=this.viewFactory.createView(t,{topLevel:!0});return t.render(),t}}).prototype=i.prototype,(t.prototype=new t.Prototype).constructor=t,e.exports=t},{"../substance/application":160,underscore:185}],137:[function(t,e,n){"use strict";var o=t("underscore"),i=t("../substance/application").View,r=t("../substance/application").$$,t=function(t){i.call(this),this.controller=t,this.$el.attr({id:"container"}),this.listenTo(this.controller,"state-changed",this.onStateChanged),this.listenTo(this.controller,"loading:started",this.startLoading),$(document).on("dragover",function(){return!1}),$(document).on("ondragend",function(){return!1}),$(document).on("drop",this.handleDroppedFile.bind(this))};(t.Prototype=function(){this.handleDroppedFile=function(){var e=this.controller,t=event.dataTransfer.files[0],n=new FileReader;return n.onload=function(t){e.importXML(t.target.result)},n.readAsText(t),!1},this.onStateChanged=function(){var t=this.controller.state;"reader"===t.context?this.openReader():console.log("Unknown application state: "+t)},this.startLoading=function(t){t=t||"Loading article",$(".spinner-wrapper .message").html(t),$("body").addClass("loading")},this.stopLoading=function(){$("body").removeClass("loading")},this.openReader=function(){var t=this.controller.reader.createView(),e=this;e.replaceMainView("reader",t),e.startLoading("Typesetting"),this.$("#main").css({opacity:0}),o.delay(function(){e.stopLoading(),e.$("#main").css({opacity:1})},1e3)},this.replaceMainView=function(t,e){$("body").removeClass().addClass("current-view "+t),this.mainView&&this.mainView!==e&&this.mainView.dispose(),this.mainView=e,this.$("#main").html(e.render().el)},this.render=function(){return this.el.innerHTML="",this.el.appendChild(r(".browser-not-supported",{text:"Sorry, your browser is not supported.",style:"display: none;"})),this.el.appendChild(r(".spinner-wrapper",{children:[r(".spinner"),r(".message",{html:"Loading article"})]})),this.el.appendChild(r("#main")),this},this.dispose=function(){this.stopListening(),this.mainView&&this.mainView.dispose()}}).prototype=i.prototype,t.prototype=new t.Prototype,e.exports=t},{"../substance/application":160,underscore:185}],138:[function(t,e,n){"use strict";var o=t("./panel"),i=t("./container_panel_controller"),t=function(t){o.call(this,t)};(t.Prototype=function(){this.createController=function(t){return new i(t,this.config)}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"./container_panel_controller":139,"./panel":147}],139:[function(t,e,n){"use strict";var o=t("../../substance/document"),i=t("./panel_controller"),r=t("./resource_panel_viewfactory"),s=t("./container_panel_view"),t=function(t,e){i.call(this,t,e),this.docCtrl=new o.Controller(t,{view:e.container})};(t.Prototype=function(){this.createView=function(){var t=this.getDocument();return t="resource"===this.config.type?this.config.createViewFactory?this.config.createViewFactory(t,this.config):new r(t.nodeTypes,this.config):new t.constructor.ViewFactory(t.nodeTypes,this.config),this.viewFactory=t,new s(this,t,this.config)},this.getContainer=function(){return this.docCtrl.getContainer()}}).prototype=i.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../substance/document":173,"./container_panel_view":140,"./panel_controller":148,"./resource_panel_viewfactory":150}],140:[function(t,e,n){"use strict";var o=t("underscore"),i=t("./surface_scrollbar"),r=t("../lens_surface"),s=t("./panel_view"),a=t("../../substance/util/getRelativeBoundingRect"),t=function(t,e,n){s.call(this,t,n),this.surface=new r(t.docCtrl,{editable:!1,viewFactory:e}),this.docCtrl=t.docCtrl,this.scrollbar=new i(this.surface),this._onScroll=o.bind(this.onScroll,this),this.surface.$el.on("scroll",this._onScroll),this.surface.$el.addClass("resource-view").addClass(n.container),this.el.appendChild(this.surface.el),this.el.appendChild(this.scrollbar.el),this.$activeResource=null};(t.Prototype=function(){this.render=function(){return this.getContainer().hasContent(this.config.type)?(this.surface.render(),this.scrollbar.render()):(this.hideToggle(),this.hide()),this},this.getContainer=function(){return this.docCtrl.container},this.onScroll=function(){this.scrollbar.onScroll()},this.hasScrollbar=function(){return!0},this.scrollTo=function(t){var e,n,o,i=this.findNodeView(t);i?(o=this.surface.$el.height(),n=(e=this.surface.$el.scrollTop())+o,(o=a([i],this.surface.$nodes[0])).height,o=(i=o.top)+o.height,e<=i&&o<=n||(this.surface.$el.scrollTop(i),this.scrollbar.update())):console.info("ContainerPanelView.scrollTo(): Unknown resource '%s'",t)},this.findNodeView=function(t){return this.surface.findNodeView(t)},this.addHighlight=function(t,e){s.prototype.addHighlight.call(this,t,e);var n=this.getDocument().get(t);n&&this.scrollbar.addHighlight(t,e+" "+n.type)},this.removeHighlights=function(){s.prototype.removeHighlights.call(this),this.scrollbar.removeHighlights(),this.scrollbar.update()},this.update=function(){this.scrollbar.update()},this.hide=function(){this.hidden||s.prototype.hide.call(this)},this.show=function(){this.scrollbar.update(),s.prototype.show.call(this)}}).prototype=s.prototype,(t.prototype=new t.Prototype).constructor=t,e.exports=t},{"../../substance/util/getRelativeBoundingRect":180,"../lens_surface":136,"./panel_view":149,"./surface_scrollbar":151,underscore:185}],141:[function(t,e,n){"use strict";var o=t("../container_panel"),i=t("./content_panel_controller"),t=function(){o.call(this,{name:"content",type:"document",container:"content",label:"Contents",title:"Contents",icon:"fa-align-left"})};(t.Prototype=function(){this.createController=function(t){return new i(t,this.config)}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../container_panel":138,"./content_panel_controller":142}],142:[function(t,e,n){"use strict";var o=t("../container_panel_controller"),i=t("./content_panel_view"),t=function(t,e){o.call(this,t,e)};(t.Prototype=function(){this.createView=function(){var t;return this.view||(t=new(t=this.getDocument()).constructor.ViewFactory(t.nodeTypes,this.config),this.view=new i(this,t,this.config)),this.view}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../container_panel_controller":139,"./content_panel_view":143}],143:[function(t,e,n){"use strict";var c=t("underscore"),o=t("../container_panel_view"),i=t("./toc_panel_view"),t=function(t,e,n){o.call(this,t,e,n),this.tocView=new i(t,e,c.extend({},n,{type:"resource",name:"toc"})),this.tocNodeElements={},this._onTocItemSelected=c.bind(this.onTocItemSelected,this),this.resources=t.getDocument().addIndex("referenceByTarget",{types:["resource_reference"],property:"target"}),this.tocView.toc.on("toc-item-selected",this._onTocItemSelected),this.$el.addClass("document")};(t.Prototype=function(){this.dispose=function(){this.tocView.toc.off("toc-item-selected",this._onTocItemSelected),this.stopListening()},this.getTocView=function(){return this.tocView},this.onScroll=function(){var t=this.surface.$el.scrollTop();this.scrollbar.update(),this.markActiveHeading(t)},this.onTocItemSelected=function(t){t=this.findNodeView(t);t&&t.scrollIntoView()},this.markActiveHeading=function(t){var e=$(".nodes").height(),n=this.getDocument().getTocNodes(),o=function(t){return this.tocNodeElements[t]||(this.tocNodeElements[t]=this.findNodeView(t))}.bind(this);if(0!==n.length){o(n[0].id);var i=n[0].id;if(t+this.$el.height()>=e)i=c.last(n).id;else for(var r=n.length-1;1<=r;r--){var s=n[r],a=o(s.id);if(a){if($(a).offset().top-1<=0){i=a.dataset.id;break}}else console.error("Could not find element for node %s",s.id)}this.tocView.setActiveNode(i)}},this.markReferencesTo=function(t){t=this.resources.get(t);c.each(t,function(t){$(this.findNodeView(t.id)).addClass("active")},this)},this.removeHighlights=function(){o.prototype.removeHighlights.call(this),this.$el.find(".content-node.active").removeClass("active"),this.$el.find(".annotation.active").removeClass("active")}}).prototype=o.prototype,(t.prototype=new t.Prototype).constructor=t,e.exports=t},{"../container_panel_view":140,"./toc_panel_view":145,underscore:185}],144:[function(t,e,n){e.exports=t("./content_panel")},{"./content_panel":141}],145:[function(t,e,n){"use strict";var o=t("./toc_view"),i=t("../panel_view"),t=function(t,e,n){i.call(this,t,n),this.toc=new o(t.getDocument(),e)};(t.Prototype=function(){this.render=function(){return this.el.appendChild(this.toc.render().el),this},this.setActiveNode=function(t){this.toc.setActiveNode(t)},this.onToggle=function(t){this.trigger("toggle","toc"),t.preventDefault(),t.stopPropagation()}}).prototype=i.prototype,(t.prototype=new t.Prototype).constructor=t,e.exports=t},{"../panel_view":149,"./toc_view":146}],146:[function(t,e,n){"use strict";var o=t("../../../substance/application").View,r=(t("../../../substance/application").$$,t("../../../substance/data").Graph.Index,t("underscore")),t=function(t,e){o.call(this),this.doc=t,this.viewFactory=e,this.$el.addClass("toc")};(t.Prototype=function(){this.render=function(){var i=-1,t=this.doc.getTocNodes();return t.length<2||r.each(t,function(t){var e=this.viewFactory.createView(t),n=t.getLevel();-1===n?n=i+1:i=n;var o=e.renderTocItem(),e=$(o);o.id="toc_"+t.id,e.addClass("heading-ref"),e.addClass("level-"+n),e.click(r.bind(this.onClick,this,t.id)),this.el.appendChild(o)},this),this},this.setActiveNode=function(t){this.$(".heading-ref.active").removeClass("active"),this.$("#toc_"+t).addClass("active")},this.onClick=function(t){this.trigger("toc-item-selected",t)}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../../substance/application":160,"../../../substance/data":166,underscore:185}],147:[function(t,e,n){"use strict";function o(t){this.config=t,this.config.label=t.title}o.Prototype=function(){this.createController=function(t){throw new Error("this method is abstract")},this.getName=function(){return this.config.name},this.getConfig=function(){return this.config}},(o.prototype=new o.Prototype).constructor=o,e.exports=o},{}],148:[function(t,e,n){"use strict";var o=t("../../substance/application").Controller,t=(t("underscore"),t("../../substance/util"),function(t,e){this.document=t,this.config=e});(t.Prototype=function(){o.prototype;this.createView=function(){throw new Error("this is an abstract method")},this.getConfig=function(){return this.config},this.getName=function(){return this.config.name},this.getDocument=function(){return this.document}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../substance/application":160,"../../substance/util":182,underscore:185}],149:[function(t,e,n){var o=t("underscore"),t=t("../../substance/application"),i=t.$$,r=t.View,t=function(t,e){r.call(this),this.controller=t,this.config=e,this.doc=t.getDocument(),this.name=e.name,this.toggleEl=i("a.context-toggle."+this.name,{href:"#",title:this.config.title,html:'<i class="fa '+this.config.icon+'"></i> '+this.config.title}),this.$toggleEl=$(this.toggleEl),this.$el.addClass("panel").addClass(this.name),"resource"===this.config.type&&this.$el.addClass("resource-view"),this._onToggle=o.bind(this.onToggle,this),this._onToggleResource=o.bind(this.onToggleResource,this),this._onToggleResourceReference=o.bind(this.onToggleResourceReference,this),this._onToggleFullscreen=o.bind(this.onToggleFullscreen,this),this.$toggleEl.click(this._onToggle),this.$el.on("click",".action-toggle-resource",this._onToggleResource),this.$el.on("click",".toggle-fullscreen",this._onToggleFullscreen),this.$el.on("click",".annotation.resource-reference",this._onToggleResourceReference),this.highlightedNodes=[]};(t.Prototype=function(){this.dispose=function(){this.$toggleEl.off("click",this._onClick),this.$el.off("scroll",this._onScroll),this.$el.off("click",".a.action-toggle-resource",this._onToggleResource),this.$el.off("click",".a.toggle-fullscreen",this._onToggleFullscreen),this.$el.off("click",".annotation.reference",this._onToggleResourceReference),this.stopListening()},this.onToggle=function(t){this.trigger("toggle",this.name),t.preventDefault(),t.stopPropagation()},this.getToggleControl=function(){return this.toggleEl},this.hasScrollbar=function(){return!1},this.show=function(){this.$el.removeClass("hidden"),this.hidden=!1},this.hide=function(){this.hidden||(this.$el.addClass("hidden"),this.$toggleEl.removeClass("active"),this.hidden=!0)},this.isHidden=function(){return this.hidden},this.activate=function(){this.show(),$("#main .article")[0].dataset.context=this.name,this.$toggleEl.addClass("active")},this.addHighlight=function(t,e){t=this.findNodeView(t);t&&((t=$(t)).addClass(e),this.highlightedNodes.push({$el:t,cssClass:e}))},this.removeHighlights=function(){for(var t=0;t<this.highlightedNodes.length;t++){var e=this.highlightedNodes[t];e.$el.removeClass(e.cssClass)}this.highlightedNodes=[]},this.showToggle=function(){this.$toggleEl.removeClass("hidden")},this.hideToggle=function(){this.$toggleEl.addClass("hidden")},this.getDocument=function(){return this.doc},this.findNodeView=function(t){return this.el.querySelector("*[data-id="+t+"]")},this.onToggleResource=function(t){t.preventDefault(),t.stopPropagation();var e=$(t.currentTarget).parents(".content-node")[0],t=e.dataset.id;this.trigger("toggle-resource",this.name,t,e)},this.onToggleResourceReference=function(t){t.preventDefault(),t.stopPropagation();var e=t.currentTarget,t=t.currentTarget.dataset.id;this.trigger("toggle-resource-reference",this.name,t,e)},this.onToggleFullscreen=function(t){t.preventDefault(),t.stopPropagation();var e=$(t.currentTarget).parents(".content-node")[0],t=e.dataset.id;this.trigger("toggle-fullscreen",this.name,t,e)}}).prototype=r.prototype,(t.prototype=new t.Prototype).constructor=t,e.exports=t},{"../../substance/application":160,underscore:185}],150:[function(t,e,n){var o=t("../../article").ViewFactory,i=function(t,e){o.call(this,t),this.options=e||{},void 0===this.options.header&&(this.options.header=!0),void 0===this.options.zoom&&(this.options.zoom=i.enableZoom)};i.Prototype=function(){this.createView=function(t,e,n){e=e||{};n=this.getNodeViewClass(t,n);return e.topLevel&&n.prototype.isResourceView&&this.options.header&&(e.header=!0,n.prototype.isZoomable&&this.options.zoom&&(e.zoom=!0)),new n(t,this,e)}},i.Prototype.prototype=o.prototype,i.prototype=new i.Prototype,i.enableZoom=!1,e.exports=i},{"../../article":6}],151:[function(t,e,n){"use strict";function o(t){i.call(this),this.surface=t,this.$nodes=this.surface.$nodes,this.$el.addClass("surface-scrollbar"),this.$el.addClass(t.docCtrl.getContainer().id),this.overlays=[],s.bindAll(this,"mouseDown","mouseUp","mouseMove","updateVisibleArea"),this.$el.mousedown(this.mouseDown),$(window).mousemove(this.mouseMove),$(window).mouseup(this.mouseUp)}var i=t("../../substance/application").View,r=t("../../substance/application").$$,s=t("underscore");(o.Prototype=function(){this.render=function(){var t=this.$nodes.height(),e=this.surface.$el.height();return this.factor=t/e,this.visibleArea=r(".visible-area"),this.scrollTop=this.surface.$el.scrollTop(),this.el.innerHTML="",this.el.appendChild(this.visibleArea),this.updateVisibleArea(),this},this.updateVisibleArea=function(){$(this.visibleArea).css({top:this.scrollTop/this.factor,height:this.surface.$el.height()/this.factor})},this.addOverlay=function(t){var e=$("<div>").addClass("node overlay");return this.overlays.push({el:t,$overlay:e}),this.$el.append(e),e},this.updateOverlay=function(t,e){var n=$(t),t=n.outerHeight(!0)/this.factor,n=(n.offset().top-this.surfaceTop)/this.factor;t<o.OverlayMinHeight&&(n-=.5*(t=o.OverlayMinHeight)),e.css({height:t,top:n})},this.addHighlight=function(t,e){var n=this.surface.findNodeView(t);if(n){t=this.addOverlay(n);return this.updateOverlay(n,t),t.addClass(e),t[0]}},this.addHighlights=function(t,e){for(var n=[],o=0;o<t.length;o++){var i=this.addHighlight(t[o],e);n.push(i)}return this.update(),n},this.removeHighlights=function(){for(var t=0;t<this.overlays.length;t++)this.overlays[t].$overlay.remove()},this.update=function(){var t=this.$nodes.height(),e=this.surface.$el.height();e<t?$(this.el).removeClass("hidden"):$(this.el).addClass("hidden"),this.factor=t/e,this.surfaceTop=this.$nodes.offset().top,this.scrollTop=this.surface.$el.scrollTop(),this.updateVisibleArea();for(var n=0;n<this.overlays.length;n++){var o=this.overlays[n];this.updateOverlay(o.el,o.$overlay)}},this.mouseDown=function(t){this._mouseDown=!0;var e=t.pageY;return t.target!==this.visibleArea?(this.offset=$(this.visibleArea).height()/2,this.mouseMove(t)):this.offset=e-$(this.visibleArea).position().top,!1},this.mouseUp=function(){this._mouseDown=!1},this.mouseMove=function(t){this._mouseDown&&(t=(t.pageY-this.offset)*this.factor,this.scrollTop=this.surface.$el.scrollTop(t),this.updateVisibleArea())},this.onScroll=function(){this.surface&&(this.scrollTop=this.surface.$el.scrollTop(),this.updateVisibleArea())}}).prototype=i.prototype,o.prototype=new o.Prototype,o.OverlayMinHeight=5,e.exports=o},{"../../substance/application":160,underscore:185}],152:[function(t,e,n){"use strict";var o=t("underscore"),i=t("../substance/application").Controller,r=t("./reader_view"),s=t("./panels/content"),t=function(e,t,n){this.__document=e,this.options=n||{},this.panels=n.panels,this.contentPanel=new s(e),this.panelCtrls={},this.panelCtrls.content=this.contentPanel.createController(e),o.each(this.panels,function(t){this.panelCtrls[t.getName()]=t.createController(e)},this),this.workflows=n.workflows||[],this.state=t,this.currentPanel="toc"};(t.Prototype=function(){this.createView=function(){return this.view||(this.view=new r(this)),this.view},this.switchPanel=function(t){this.currentPanel=t,this.modifyState({panel:t,focussedNode:null,fullscreen:!1})},this.getDocument=function(){return this.__document}}).prototype=i.prototype,t.prototype=new t.Prototype,e.exports=t},{"../substance/application":160,"./panels/content":144,"./reader_view":153,underscore:185}],153:[function(t,e,n){"use strict";var c=t("underscore"),i=t("../substance/application").View,r=t("../substance/data").Graph.Index,s=t("../substance/application").$$,t=function(o){i.call(this),this.readerCtrl=o,this.doc=this.readerCtrl.getDocument(),this.$el.addClass("article"),this.$el.addClass(this.doc.schema.id),this.bodyScroll={},this.contentView=o.panelCtrls.content.createView(),this.tocView=this.contentView.getTocView(),this.panelViews={},this.panelForRef={},c.each(o.panels,function(t){var e=t.getName(),n=o.panelCtrls[e];this.panelViews[e]=n.createView(),c.each(t.config.references,function(t){this.panelForRef[t]=e},this)},this),this.panelViews.toc=this.tocView,this.resources=new r(this.readerCtrl.getDocument(),{types:["resource_reference"],property:"target"}),this.lastWorkflow=null,this.lastPanel="toc",this._onTogglePanel=c.bind(this.switchPanel,this),this.listenTo(this.readerCtrl,"state-changed",this.updateState),this.listenTo(this.tocView,"toggle",this._onTogglePanel),c.each(this.panelViews,function(t){this.listenTo(t,"toggle",this._onTogglePanel),this.listenTo(t,"toggle-resource",this.onToggleResource),this.listenTo(t,"toggle-resource-reference",this.onToggleResourceReference),this.listenTo(t,"toggle-fullscreen",this.onToggleFullscreen)},this),this.listenTo(this.contentView,"toggle",this._onTogglePanel),this.listenTo(this.contentView,"toggle-resource",this.onToggleResource),this.listenTo(this.contentView,"toggle-resource-reference",this.onToggleResourceReference),this.listenTo(this.contentView,"toggle-fullscreen",this.onToggleFullscreen),c.each(this.readerCtrl.workflows,function(t){t.attach(this.readerCtrl,this)},this),$(window).resize(c.debounce(c.bind(function(){this.contentView.scrollbar.update();var t=this.panelViews[this.readerCtrl.state.panel];t&&t.hasScrollbar()&&t.scrollbar.update()},this),1))};(t.Prototype=function(){this.render=function(){var t=document.createDocumentFragment();t.appendChild(this.contentView.render().el);var e=s(".scrollbar-cover");this.contentView.el.appendChild(e);var n=s(".context-toggles");n.appendChild(this.tocView.getToggleControl()),this.tocView.on("toggle",this._onClickPanel),c.each(this.readerCtrl.panels,function(t){var e=this.panelViews[t.getName()],t=e.getToggleControl();n.appendChild(t),e.on("toggle",this._onClickPanel)},this);var o=s(".resources");o.appendChild(this.tocView.render().el),c.each(this.readerCtrl.panels,function(t){t=this.panelViews[t.getName()];o.appendChild(t.render().el)},this);e=s(".menu-bar");return e.appendChild(n),o.appendChild(e),t.appendChild(o),this.el.appendChild(t),c.delay(c.bind(function(){this.updateState();var t=this;window.MathJax&&(window.MathJax.Hub.Queue(["Typeset",window.MathJax.Hub]),window.MathJax.Hub.Queue(function(){t.updateState()}))},this),1),this},this.dispose=function(){c.each(this.workflows,function(t){t.detach()}),this.contentView.dispose(),c.each(this.panelViews,function(t){t.off("toggle",this._onClickPanel),t.dispose()},this),this.resources.dispose(),this.stopListening()},this.getState=function(){return this.readerCtrl.state},this.switchPanel=function(t){this.readerCtrl.switchPanel(t),this.lastPanel=t},this.updateState=function(){var t,e,n=this,o=this.readerCtrl.state,i={focussedNode:o.focussedNode?this.doc.get(o.focussedNode):null},r="content"===o.panel?this.contentView:this.panelViews[o.panel];if(c.each(this.panelViews,function(t){t.isHidden()||t.hide()}),this.contentView.removeHighlights(),c.each(this.panelViews,function(t){t.removeHighlights()}),o.focussedNode&&(e=["focussed","highlighted"],o.fullscreen&&e.push("fullscreen"),this.contentView.addHighlight(o.focussedNode,e.concat("main-occurrence").join(" ")),r.addHighlight(o.focussedNode,e.join(" ")),r.scrollTo(o.focussedNode)),this.lastWorkflow&&(t=this.lastWorkflow.handleStateUpdate(o,i)),!t)for(var s=0;s<this.readerCtrl.workflows.length;s++){var a=this.readerCtrl.workflows[s];if(a!==this.lastWorkflow&&a.handlesStateUpdate&&(t=a.handleStateUpdate(o,i))){this.lastWorkflow=a;break}}t||("content"!==o.panel?(e=this.panelViews[o.panel],this.showPanel(o.panel),o.focussedNode&&(r=this.resources.get(o.focussedNode),c.each(r,function(t){this.contentView.addHighlight(t.id,"highlighted ")},this),e.hasScrollbar()&&e.scrollTo(o.focussedNode))):this.showPanel("toc")),n.updateScrollbars(),c.delay(function(){n.updateScrollbars()},2e3)},this.updateScrollbars=function(){this.readerCtrl.state;this.contentView.scrollbar.update(),c.each(this.panelViews,function(t){t.hasScrollbar()&&t.scrollbar.update()})},this.showPanel=function(t){this.panelViews[t]?(this.panelViews[t].activate(),this.el.dataset.context=t):"content"===t&&(this.panelViews.toc.activate(),this.el.dataset.context=t)},this.getPanelView=function(t){return this.panelViews[t]},this.onToggleResource=function(t,e,n){n.classList.contains("highlighted")?this.readerCtrl.modifyState({panel:t,focussedNode:null,fullscreen:!1}):this.readerCtrl.modifyState({panel:t,focussedNode:e})},this.onToggleResourceReference=function(t,e,n){n.classList.contains("highlighted")?this.readerCtrl.modifyState({panel:this.lastPanel,focussedNode:null,fullscreen:!1}):this.readerCtrl.modifyState({panel:"content",focussedNode:e,fullscreen:!1})},this.onToggleFullscreen=function(t,e){var n=!this.readerCtrl.state.fullscreen;this.readerCtrl.modifyState({panel:t,focussedNode:e,fullscreen:n})}}).prototype=i.prototype,(t.prototype=new t.Prototype).constructor=t,e.exports=t},{"../substance/application":160,"../substance/data":166,underscore:185}],154:[function(t,e,n){"use strict";var o=t("underscore"),i=t("./workflow"),t=function(){i.apply(this,arguments),this._followCrossReference=o.bind(this.followCrossReference,this)};(t.Prototype=function(){this.registerHandlers=function(){this.readerView.$el.on("click",".annotation.cross_reference",this._followCrossReference)},this.unRegisterHandlers=function(){this.readerView.$el.off("click",".annotation.cross_reference",this._followCrossReference)},this.followCrossReference=function(t){t.preventDefault(),t.stopPropagation();t=t.currentTarget.dataset.id,t=this.readerCtrl.getDocument().get(t);this.readerView.contentView.scrollTo(t.target)}}).prototype=i.prototype,t.prototype=new t.Prototype,e.exports=t},{"./workflow":157,underscore:185}],155:[function(t,n,o){"use strict";var i=t("underscore"),r=t("./workflow"),t=function(){r.apply(this,arguments),this._gotoTop=i.bind(this.gotoTop,this)};(t.Prototype=function(){this.registerHandlers=function(){this.readerView.$el.on("click",".document .content-node.heading .top",this._gotoTop)},this.unRegisterHandlers=function(){this.readerView.$el.off("click",".document .content-node.heading .top",this._gotoTop)},this.gotoTop=function(){e.preventDefault(),e.stopPropagation(),this.readerCtrl.contentView.jumpToNode("cover")}}).prototype=r.prototype,t.prototype=new t.Prototype,n.exports=t},{"./workflow":157,underscore:185}],156:[function(t,e,n){"use strict";var r=t("underscore"),o=t("./workflow"),t=function(){o.apply(this,arguments)};(t.Prototype=function(){this.registerHandlers=function(){},this.unRegisterHandlers=function(){},this.handlesStateUpdate=!0,this.handleStateUpdate=function(t,e){if(e.focussedNode&&this.readerView.panelForRef[e.focussedNode.type]){var n=e.focussedNode,o=this.readerView.panelForRef[n.type],e=this.readerView.panelViews[o],i=this.readerView.contentView,o=n.target;e.activate();e.addHighlight(o,["highlighted"].join(" ")),e.scrollTo(o);o=this.readerView.resources.get(o);return delete o[n.id],r.each(o,function(t){i.addHighlight(t.id,"highlighted")},this),!0}return!1}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"./workflow":157,underscore:185}],157:[function(t,e,n){"use strict";function o(){this.readerController=null,this.readerView=null}o.Prototype=function(){this.attach=function(t,e){this.readerCtrl=t,this.readerView=e,this.registerHandlers()},this.detach=function(){this.unRegisterHandlers(),this.readerView=null,this.readerController=null},this.registerHandlers=function(){throw new Error("This method is abstract")},this.unRegisterHandlers=function(){throw new Error("This method is abstract")},this.handlesStateUpdate=!1,this.handleStateUpdate=function(t,e){throw new Error("This method is abstract")}},o.prototype=new o.Prototype,e.exports=o},{}],158:[function(t,e,n){"use strict";var o=t("./view"),i=t("./router"),r=(t("../../substance/util"),t("underscore")),t=function(t){o.call(this),this.config=t};(t.Prototype=function(){this.initRouter=function(){this.router=new i,r.each(this.config.routes,function(t){this.router.route(t.route,t.name,r.bind(this.controller[t.command],this.controller))},this),i.history.start()},this.start=function(){this.$el=$("body"),this.el=this.$el[0],this.render(),this.initRouter()}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"../../substance/util":182,"./router":162,"./view":163,underscore:185}],159:[function(t,e,n){"use strict";var o=t("../../substance/util"),i=t("underscore"),t=function(t){this.state={},this.context=null};(t.Prototype=function(){this.updateState=function(t,e){console.error("updateState is deprecated, use modifyState. State is now a rich object where context replaces the old state variable");var n=this.context;this.context=t,this.state=e,this.trigger("state-changed",this.context,n,e)},this.modifyState=function(t){var e=this.state.context;i.extend(this.state,t),t.context&&t.context!==e&&this.trigger("context-changed",t.context),this.trigger("state-changed",this.state.context)}}).prototype=o.Events,t.prototype=new t.Prototype,e.exports=t},{"../../substance/util":182,underscore:185}],160:[function(t,e,n){"use strict";var o=t("./application");o.View=t("./view"),o.Router=t("./router"),o.Controller=t("./controller"),o.ElementRenderer=t("./renderers/element_renderer"),o.$$=o.ElementRenderer.$$,e.exports=o},{"./application":158,"./controller":159,"./renderers/element_renderer":161,"./router":162,"./view":163}],161:[function(t,e,n){"use strict";function o(t){return this.attributes=t,this.tagName=t.tag,this.children=t.children||[],this.text=t.text||"",this.html=t.html,delete t.children,delete t.text,delete t.html,delete t.tag,this.render()}var t=t("../../../substance/util"),i=t.RegExp;o.Prototype=function(){this.render=function(){var t,e=document.createElement(this.tagName);for(t in this.html?e.innerHTML=this.html:e.textContent=this.text,this.attributes){var n=this.attributes[t];e.setAttribute(t,n)}for(var o=0;o<this.children.length;o++){var i=this.children[o];e.appendChild(i)}return this.el=e}};o.$$=function(t,e){var e=e||{},n=/^([a-zA-Z0-9]*)/.exec(t);e.tag=n&&n[1]?n[1]:"div";n=/#([a-zA-Z0-9_]*)/.exec(t);n&&n[1]&&(e.id=n[1]);n=new i(/\.([a-zA-Z0-9_-]*)/g);return e.class||(e.class=n.match(t).map(function(t){return t.match[1]}).join(" ")),new o(e)},o.Prototype.prototype=t.Events,o.prototype=new o.Prototype,e.exports=o},{"../../../substance/util":182}],162:[function(t,e,n){"use strict";function r(t){(t=t||{}).routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)}var o=t("../../substance/util"),s=t("underscore"),i=/\((.*?)\)/g,a=/(\(\?)?:\w+/g,c=/\*\w+/g,u=/[\-{}\[\]+?.,\\\^$|#\s]/g;s.extend(r.prototype,o.Events,{initialize:function(){},route:function(e,n,o){s.isRegExp(e)||(e=this._routeToRegExp(e)),s.isFunction(n)&&(o=n,n=""),o=o||this[n];var i=this;return r.history.route(e,function(t){t=i._extractParameters(e,t);o&&o.apply(i,t),i.trigger.apply(i,["route:"+n].concat(t)),i.trigger("route",n,t),r.history.trigger("route",i,n,t)}),this},navigate:function(t,e){return r.history.navigate(t,e),this},_bindRoutes:function(){if(this.routes){this.routes=s.result(this,"routes");for(var t,e=s.keys(this.routes);null!=(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(u,"\\$&").replace(i,"(?:$1)?").replace(a,function(t,e){return e?t:"([^/]+)"}).replace(c,"(.*?)"),new RegExp("^"+t+"$")},_extractParameters:function(t,e){e=t.exec(e).slice(1);return s.map(e,function(t){return t?decodeURIComponent(t):null})}});var l=r.History=function(){this.handlers=[],s.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},p=/^[#\/]|\s+$/g,h=/^\/+|\/+$/g,d=/msie [\w.]+/,f=/\/$/;l.started=!1,s.extend(l.prototype,o.Events,{interval:50,getHash:function(t){t=(t||this).location.href.match(/#(.*)$/);return t?t[1]:""},getFragment:function(t,e){return null==t&&(this._hasPushState||!this._wantsHashChange||e?(t=this.location.pathname,e=this.root.replace(f,""),t.indexOf(e)||(t=t.substr(e.length))):t=this.getHash()),t.replace(p,"")},start:function(t){if(l.started)throw new Error("Router.history has already been started");l.started=!0,this.options=s.extend({},{root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=!1!==this.options.hashChange,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var e=this.getFragment(),t=document.documentMode,t=d.exec(navigator.userAgent.toLowerCase())&&(!t||t<=7);this.root=("/"+this.root+"/").replace(h,"/"),t&&this._wantsHashChange&&(this.iframe=$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(e)),this._hasPushState?$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!t?$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=e;t=this.location,e=t.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!e?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&e&&t.hash&&(this.fragment=this.getHash().replace(p,""),this.history.replaceState({},document.title,this.root+this.fragment+t.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),l.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(t){var e=this.getFragment();if(e===this.fragment&&this.iframe&&(e=this.getFragment(this.getHash(this.iframe))),e===this.fragment)return!1;this.iframe&&this.navigate(e),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(t){var e=this.fragment=this.getFragment(t);return s.any(this.handlers,function(t){if(t.route.test(e))return t.callback(e),!0})},navigate:function(t,e){if(!l.started)return!1;if(e&&!0!==e||(e={trigger:e}),t=this.getFragment(t||""),this.fragment!==t){this.fragment=t;var n=this.root+t;if(this._hasPushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}e.trigger&&this.loadUrl(t)}},_updateHash:function(t,e,n){n?(n=t.href.replace(/(javascript:|#).*$/,""),t.replace(n+"#"+e)):t.hash="#"+e}}),r.history=new l,e.exports=r},{"../../substance/util":182,underscore:185}],163:[function(t,e,n){"use strict";var o=t("../../substance/util"),t=function(t){t=t||{};this.el=t.el||window.document.createElement(t.elementType||"div"),this.$el=$(this.el),this.dispatchDOMEvents()};(t.Prototype=function(){this.$=function(t){return this.$el.find(t)},this.render=function(){return this},this.dispatchDOMEvents=function(){var o=this;this.$el.delegate("[sbs-click]","click",function(t){console.error("FIXME: sbs-click is deprecated. Use jquery handlers with selectors instead.");var e=function(t){var e=/(\w+)\((.*)\)/.exec(t);if(!e)throw new Error("Invalid click handler '"+t+"'");return{method:e[1],args:e[2].split(",")}}($(t.currentTarget).attr("sbs-click")),n=o[e.method];if(n)return t.stopPropagation(),t.preventDefault(),n.apply(o,e.args),!1})}}).prototype=o.Events,t.prototype=new t.Prototype,e.exports=t},{"../../substance/util":182}],164:[function(t,e,n){"use strict";function i(t){return r.isArray(t)&&(t=t[0]),0<=p.indexOf(t)}var r=t("underscore"),o=t("../../substance/util"),s=o.errors,a=t("./schema"),c=t("./property"),u=t("./graph_index"),l=s.define("GraphError"),p=["object","array","string","number","boolean","date"],s=function(t,e){if(e=e||{},this.schema=new a(t),this.schema.id&&e.seed&&e.seed.schema&&!r.isEqual(e.seed.schema,[this.schema.id,this.schema.version]))throw new l(["Graph does not conform to schema. Expected: ",this.schema.id+"@"+this.schema.version," Actual: ",e.seed.schema[0]+"@"+e.seed.schema[1]].join(""));this.nodes={},this.indexes={},this.__seed__=e.seed,this.init()};s.Prototype=function(){r.extend(this,o.Events),this.create=function(t){this.nodes[t.id]=t,this._updateIndexes({type:"create",path:[t.id],val:t})},this.delete=function(t){var e=this.nodes[t];delete this.nodes[t],this._updateIndexes({type:"delete",path:[t],val:e})},this.set=function(t,e){var n=this.resolve(t);if(!n)throw new l("Could not resolve property with path "+JSON.stringify(t));var o=n.get();n.set(e),this._updateIndexes({type:"set",path:t,val:e,original:o})},this.get=function(t){if(!r.isArray(t)&&!r.isString(t))throw new l("Invalid argument path. Must be String or Array");return 1<arguments.length&&(t=r.toArray(arguments)),r.isString(t)?this.nodes[t]:this.resolve(t).get()},this.query=function(t){var e=this.resolve(t),n=e.type,t=e.baseType,e=e.get();return"array"===t?this._queryArray.call(this,e,n):i(t)?e:this.get(e)},this.toJSON=function(){return{id:this.id,schema:[this.schema.id,this.schema.version],nodes:o.deepclone(this.nodes)}},this.contains=function(t){return!!this.nodes[t]},this.resolve=function(t){return new c(this,t)},this.reset=function(){this.init(),this.trigger("graph:reset")},this.init=function(){this.__is_initializing__=!0,this.__seed__?this.nodes=o.clone(this.__seed__.nodes):this.nodes={},r.each(this.indexes,function(t){t.reset()}),delete this.__is_initializing__},this.addIndex=function(t,e){if(this.indexes[t])throw new l("Index with name "+t+"already exists.");e=new u(this,e);return this.indexes[t]=e},this.removeIndex=function(t){delete this.indexes[t]},this._updateIndexes=function(e){r.each(this.indexes,function(t){e?t.onGraphChange(e):t.rebuild()},this)},this._queryArray=function(t,e){if(!r.isArray(e))throw new l("Illegal argument: array types must be specified as ['array'(, 'array')*, <type>]");var n,o;if("array"===e[1])for(n=[],o=0;o<t.length;o++)n.push(this._queryArray(t[o],e.slice(1)));else if(i(e[1]))n=t;else for(n=[],o=0;o<t.length;o++)n.push(this.get(t[o]));return n}},s.DEFAULT_MODE=s.STRICT_INDEXING=2,s.prototype=new s.Prototype,s.Schema=a,s.Property=c,s.Index=u,e.exports=s},{"../../substance/util":182,"./graph_index":165,"./property":167,"./schema":168,underscore:185}],165:[function(t,e,n){var r=t("underscore"),t=t("../../substance/util"),s=function(t,e){e=e||{},this.graph=t,this.nodes={},this.scopes={},e.filter?this.filter=e.filter:e.types&&(this.filter=s.typeFilter(t.schema,e.types)),e.property&&(this.property=e.property),this.createIndex()};s.Prototype=function(){function i(t){var e=this;if(null!==t)for(var n=0;n<t.length;n++){var o=t[n];e.scopes[o]=e.scopes[o]||{nodes:{},scopes:{}},e=e.scopes[o]}return e}function n(t){return this.property?(t=t[this.property]||null,r.isString(t)&&(t=[t]),t):null}var o=function(t){var n=r.extend({},t.nodes);return r.each(t.scopes,function(t,e){"nodes"!==e&&r.extend(n,o(t))}),n};this.onGraphChange=function(t){this.applyOp(t)},this._add=function(t){var e;this.filter&&!this.filter(t)||(e=n.call(this,t),i.call(this,e).nodes[t.id]=t.id)},this._remove=function(t){var e;this.filter&&!this.filter(t)||(e=n.call(this,t),delete i.call(this,e).nodes[t.id])},this._update=function(t,e,n,o){this.property!==e||this.filter&&!this.filter(t)||(e=o,r.isString(e)&&(e=[e]),delete(o=i.call(this,e)).nodes[t.id],e=n,o.nodes[t.id]=t.id)},this.applyOp=function(t){var e,n,o;"create"===t.type?this._add(t.val):"delete"===t.type?this._remove(t.val):void 0!==(n=(e=this.graph.resolve(this,t.path)).get())&&("set"===t.type?o=t.original:console.error("Operational updates are not supported in this implementation"),this._update(e.node,e.key,n,o))},this.createIndex=function(){this.reset();var t=this.graph.nodes;r.each(t,function(t){var e;this.filter&&!this.filter(t)||(e=n.call(this,t),i.call(this,e).nodes[t.id]=t.id)},this)},this.get=function(t){0===arguments.length?t=null:r.isString(t)&&(t=[t]);var e=i.call(this,t),e=o(e),n=new s.Result;return r.each(e,function(t){n[t]=this.graph.get(t)},this),n},this.reset=function(){this.nodes={},this.scopes={}},this.dispose=function(){this.stopListening()},this.rebuild=function(){this.reset(),this.createIndex()}},s.prototype=r.extend(new s.Prototype,t.Events.Listener),s.typeFilter=function(o,i){return function(t){for(var e=o.typeChain(t.type),n=0;n<i.length;n++)if(0<=e.indexOf(i[n]))return!0;return!1}},s.Result=function(){},s.Result.prototype.asList=function(){var t,e=[];for(t in this)e.push(this[t])},s.Result.prototype.getLength=function(){return Object.keys(this).length},e.exports=s},{"../../substance/util":182,underscore:185}],166:[function(t,e,n){"use strict";var o={VERSION:"0.8.0"};o.Graph=t("./graph"),e.exports=o},{"./graph":164}],167:[function(t,e,n){"use strict";var o=t("underscore"),t=function(t,e){if(!e)throw new Error("Illegal argument: path is null/undefined.");this.graph=t,this.schema=t.schema,o.extend(this,this.resolve(e))};t.Prototype=function(){this.resolve=function(t){for(var e,n=this.graph,o=n,i="graph",r=0;r<t.length;r++)if("graph"===i||void 0!==this.schema.types[i]){if(void 0===(o=this.graph.get(t[r])))return;n=o,i=this.schema.properties(o.type),a=n,e=void 0}else{if(void 0===o)return;e=t[r];var s=t[r],i=i[s],a=o[e];r<t.length-1&&(o=o[s])}return{node:n,parent:o,type:i,key:e,value:a}},this.get=function(){return void 0!==this.key?this.parent[this.key]:this.node},this.set=function(t){if(void 0===this.key)throw new Error("'set' is only supported for node properties.");this.parent[this.key]=this.schema.parseValue(this.baseType,t)}},t.prototype=new t.Prototype,Object.defineProperties(t.prototype,{baseType:{get:function(){return o.isArray(this.type)?this.type[0]:this.type}},path:{get:function(){return[this.node.id,this.key]}}}),e.exports=t},{underscore:185}],168:[function(t,e,n){"use strict";var o=t("underscore"),i=t("../../substance/util"),t=function(t){o.extend(this,t)};t.Prototype=function(){this.defaultValue=function(t){return"object"===t?{}:"array"===t?[]:"string"===t?"":"number"===t?0:"boolean"!==t&&("date"===t?new Date:null)},this.parseValue=function(t,e){if(null===e)return e;if(o.isString(e)){if("object"===t)return JSON.parse(e);if("array"===t)return JSON.parse(e);if("string"===t)return e;if("number"===t)return parseInt(e,10);if("boolean"!==t)return"date"===t?new Date(e):e;if("true"===e)return!0;if("false"===e)return!1;throw new Error("Can not parse boolean value from: "+e)}if("array"===t){if(!o.isArray(e))throw new Error("Illegal value type: expected array.");e=i.deepclone(e)}else if("string"===t){if(!o.isString(e))throw new Error("Illegal value type: expected string.")}else if("object"===t){if(!o.isObject(e))throw new Error("Illegal value type: expected object.");e=i.deepclone(e)}else if("number"===t){if(!o.isNumber(e))throw new Error("Illegal value type: expected number.")}else if("boolean"===t){if(!o.isBoolean(e))throw new Error("Illegal value type: expected boolean.")}else{if("date"!==t)throw new Error("Unsupported value type: "+t);e=new Date(e)}return e},this.type=function(t){return this.types[t]},this.typeChain=function(t){var e=this.types[t];if(!e)throw new Error("Type "+t+" not found in schema");e=e.parent?this.typeChain(e.parent):[];return e.push(t),e},this.isInstanceOf=function(t,e){t=this.typeChain(t);return!!(t&&0<=t.indexOf(e))},this.baseType=function(t){return this.typeChain(t)[0]},this.properties=function(t){var e=(t=o.isObject(t)?t:this.type(t)).parent?this.properties(t.parent):{};return o.extend(e,t.properties),e},this.propertyType=function(t,e){var n=this.properties(t)[e];if(!n)throw new Error("Property not found for"+t+"."+e);return o.isArray(n)?n:[n]},this.propertyBaseType=function(t,e){return this.propertyType(t,e)[0]}},t.prototype=new t.Prototype,e.exports=t},{"../../substance/util":182,underscore:185}],169:[function(t,e,n){var o=t("./node"),t=function(t,e){o.call(this,t,e)};t.type={id:"composite",parent:"content",properties:{}},t.description={name:"Composite",remarks:["A file reference to an external resource."],properties:{}},t.example={no_example:"yet"},(t.Prototype=function(){this.getLength=function(){throw new Error("Composite.getLength() is abstract.")},this.getNodes=function(){return this.getChildrenIds()},this.getChildrenIds=function(){throw new Error("Composite.getChildrenIds() is abstract.")},this.isMutable=function(){return!1},this.insertOperation=function(){return null},this.deleteOperation=function(){return null},this.insertChild=function(){throw new Error("This composite is immutable.")},this.deleteChild=function(){throw new Error("This composite is immutable.")},this.getChangePosition=function(t){return 0}}).prototype=o.prototype,t.prototype=new t.Prototype,e.exports=t},{"./node":174}],170:[function(t,e,n){"use strict";var i=t("underscore"),o=t("../../substance/util"),a=t("./composite"),t=function(t,e){this.document=t,this.view=e,this.treeView=[],this.listView=[],this.__parents={},this.__composites={},this.rebuild()};t.Prototype=function(){this.rebuild=function(){this.treeView.splice(0,this.treeView.length),this.listView.splice(0,this.listView.length),this.treeView=i.clone(this.view.nodes);for(var t=0;t<this.view.length;t++)this.treeView.push(this.view[t]);this.__parents={},this.__composites={},function(t,e){var n,o,i=[];for(s=this.treeView.length-1;0<=s;s--)i.unshift({id:this.treeView[s],parent:null});for(;0<i.length;){if(n=i.shift(),(o=this.document.get(n.id))instanceof a)for(var r=o.getNodes(),s=r.length-1;0<=s;s--)i.unshift({id:r[s],parent:o.id});t.call(e,o,n.parent)}}.call(this,function(t,e){if(t instanceof a)this.__parents[t.id]=e,this.__composites[e]=e;else{if(this.listView.push(t.id),this.__parents[t.id])throw new Error("Nodes must be unique in one view.");this.__parents[t.id]=e,this.__composites[e]=e}},this)},this.getTopLevelNodes=function(){return i.map(this.treeView,function(t){return this.document.get(t)},this)},this.getNodes=function(t){var e=this.listView;if(t)return i.clone(e);for(var n=[],o=0;o<e.length;o++)n.push(this.document.get(e[o]));return n},this.getPosition=function(t){return this.listView.indexOf(t)},this.getNodeFromPosition=function(t){t=this.listView[t];return void 0!==t?this.document.get(t):null},this.getParent=function(t){return this.__parents[t]},this.getRoot=function(t){for(var e=t;e;)t=e,e=this.getParent(t);return t},this.update=function(t){t=t.path;t[0]!==this.view.id&&void 0===this.__composites[t[0]]||this.rebuild()},this.getLength=function(){return this.listView.length},this.hasContent=function(t){return 0<this.listView.length||"resource"===t&&0<this.treeView.length},this.hasSuccessor=function(t){return t<this.getLength()-1},this.hasPredecessor=function(t){return 0<t},this.getPredecessor=function(t){t=this.getPosition(t);return t<=0?null:this.getNodeFromPosition(t-1)},this.getSuccessor=function(t){t=this.getPosition(t);return t>=this.getLength()-1?null:this.getNodeFromPosition(t+1)},this.firstChild=function(t){if(t instanceof a){var e=this.document.get(t.getNodes()[0]);return this.firstChild(e)}return t},this.lastChild=function(t){if(t instanceof a){var e=this.document.get(i.last(t.getNodes()));return this.lastChild(e)}return t},this.before=function(t){t=this.firstChild(t);return[this.getPosition(t.id),0]},this.after=function(t){t=this.lastChild(t);return[this.getPosition(t.id),t.getLength()]}},t.prototype=i.extend(new t.Prototype,o.Events.Listener),Object.defineProperties(t.prototype,{id:{get:function(){return this.view.id}},type:{get:function(){return this.view.type}},nodes:{get:function(){return this.view.nodes},set:function(t){this.view.nodes=t}}}),e.exports=t},{"../../substance/util":182,"./composite":169,underscore:185}],171:[function(t,e,n){"use strict";var o=t("underscore"),i=t("../../substance/util"),t=function(t,e){e=e||{},this.view=e.view||"content",this.__document=t,this.container=t.get(this.view)};t.Prototype=function(){this.getNodes=function(t){return this.container.getNodes(t)},this.getContainer=function(){return this.container},this.getPosition=function(t,e){return this.container.getPosition(t,e)},this.getNodeFromPosition=function(t){return this.container.getNodeFromPosition(t)},this.getAnnotations=function(t){return(t=t||{}).view=this.view,this.annotator.getAnnotations(t)},this.get=function(){return this.__document.get.apply(this.__document,arguments)},this.on=function(){return this.__document.on.apply(this.__document,arguments)},this.off=function(){return this.__document.off.apply(this.__document,arguments)},this.getDocument=function(){return this.__document}},t.prototype=o.extend(new t.Prototype,i.Events.Listener),Object.defineProperties(t.prototype,{id:{get:function(){return this.__document.id},set:function(){throw"immutable property"}},nodeTypes:{get:function(){return this.__document.nodeTypes},set:function(){throw"immutable property"}},title:{get:function(){return this.__document.get("document").title},set:function(){throw"immutable property"}},updated_at:{get:function(){return this.__document.get("document").updated_at},set:function(){throw"immutable property"}},creator:{get:function(){return this.__document.get("document").creator},set:function(){throw"immutable property"}}}),e.exports=t},{"../../substance/util":182,underscore:185}],172:[function(t,e,n){"use strict";function o(t){a.Graph.call(this,t.schema,t),this.containers={},this.addIndex("annotations",{types:["annotation"],property:"path"})}var s=t("underscore"),i=t("../../substance/util"),r=i.errors,a=t("../../substance/data"),c=t("./container"),u=r.define("DocumentError");o.schema={indexes:{},types:{content:{properties:{}},view:{properties:{nodes:["array","content"]}}}},(o.Prototype=function(){var n=i.prototype(this);this.getIndex=function(t){return this.indexes[t]},this.getSchema=function(){return this.schema},this.create=function(t){return n.create.call(this,t),this.get(t.id)},this.get=function(t){var e=n.get.call(this,t);if(!e)return e;if("view"===e.type)return this.containers[e.id]||(this.containers[e.id]=new c(this,e)),this.containers[e.id];t=this.nodeTypes[e.type],t=void 0!==t?t.Model:null;return!t||e instanceof t||(e=new t(e,this),this.nodes[e.id]=e),e},this.toJSON=function(){var t=n.toJSON.call(this);return t.id=this.id,t},this.hide=function(t,e){var n=this.get(t);if(!n)throw new u("Invalid view id: "+t);s.isString(e)&&(e=[e]);var o=[];if(s.each(e,function(t){t=n.nodes.indexOf(t);0<=t&&o.push(t)},this),0!==o.length){o=o.sort().reverse(),o=s.uniq(o);for(var i=this.nodes[t],r=0;r<o.length;r++)i.nodes.splice(o[r],1)}},this.show=function(t,e,n){void 0===n&&(n=-1);var o=this.get(t);if(!o)throw new u("Invalid view id: "+t);t=o.nodes.length;(n=Math.min(n,t))<0&&(n=Math.max(0,t+n+1)),o.nodes.splice(n,0,e)},this.fromSnapshot=function(t,e){return o.fromSnapshot(t,e)},this.uuid=function(t){return t+"_"+i.uuid()}}).prototype=a.Graph.prototype,o.prototype=new o.Prototype,o.fromSnapshot=function(t,e){return(e=e||{}).seed=t,new o(e)},o.DocumentError=u,e.exports=o},{"../../substance/data":166,"../../substance/util":182,"./container":170,underscore:185}],173:[function(t,e,n){"use strict";t("underscore");var o=t("./document");o.Container=t("./container"),o.Controller=t("./controller"),o.Node=t("./node"),o.Composite=t("./composite"),o.TextNode=t("./text_node"),e.exports=o},{"./composite":169,"./container":170,"./controller":171,"./document":172,"./node":174,"./text_node":175,underscore:185}],174:[function(t,e,n){"use strict";var i=t("underscore"),t=function(t,e){this.document=e,this.properties=t};t.type={parent:"content",properties:{}},t.properties={abstract:!0,immutable:!0,mergeableWith:[],preventEmpty:!0,allowedAnnotations:[]},t.Prototype=function(){this.toJSON=function(){return i.clone(this.properties)},this.getLength=function(){throw new Error("Node.getLength() is abstract.")},this.getChangePosition=function(t){throw new Error("Node.getCharPosition() is abstract.")},this.insertOperation=function(t,e){throw new Error("Node.insertOperation() is abstract.")},this.deleteOperation=function(t,e){throw new Error("Node.deleteOperation() is abstract.")},this.canJoin=function(t){return!1},this.join=function(t){throw new Error("Node.join() is abstract.")},this.isBreakable=function(){return!1},this.break=function(t,e){throw new Error("Node.split() is abstract.")},this.getAnnotations=function(){return this.document.getIndex("annotations").get(this.properties.id)},this.includeInToc=function(){return!1}},(((t.prototype=new t.Prototype).constructor=t).defineProperties=function(t,e,n){var o=t;if(1===arguments.length){t=t;if(!(o=t.prototype)||!t.type)throw new Error("Illegal argument: expected NodeClass");e=Object.keys(t.type.properties)}i.each(e,function(e){var t={get:function(){return this.properties[e]}};n||(t.set=function(t){return this.properties[e]=t,this}),Object.defineProperty(o,e,t)})})(t.prototype,["id","type"]),e.exports=t},{underscore:185}],175:[function(t,e,n){"use strict";var o=t("./node"),t=function(t,e){o.call(this,t,e)};t.type={id:"text",parent:"content",properties:{source_id:"Text element source id",content:"string"}},t.description={name:"Text",remarks:["A simple text fragement that can be annotated. Usually text nodes are combined in a paragraph."],properties:{content:"Content"}},t.example={type:"paragraph",id:"paragraph_1",content:"Lorem ipsum dolor sit amet, adipiscing elit."},(t.Prototype=function(){this.getLength=function(){return this.properties.content.length}}).prototype=o.prototype,(t.prototype=new t.Prototype).constructor=t,o.defineProperties(t.prototype,["content"]),e.exports=t},{"./node":174}],176:[function(t,e,n){"use strict";var l=t("underscore"),u=t("./util.js"),t={};function p(t,n){var i=t.finally||function(t,e){n(t,e)},i=l.once(i),e=t.data||{},r=t.functions;if(!l.isFunction(n))return n("Illegal arguments: a callback function must be provided");var s=0,a=void 0===t.stopOnError||t.stopOnError,c=[];!function n(t){var e=r[s];if(!e)return 0<c.length?i(new Error("Multiple errors occurred.",t)):i(null,t);var o=l.once(function(t,e){if(t){if(a)return i(t,null);c.push(t)}s+=1,n(e)});try{0===e.length?(e(),o(null,t)):1===e.length?e(o):e(t,o)}catch(t){console.log("util.async caught error:",t),u.printStackTrace(t),i(t)}}(e)}function o(u){return function(t,n){var e=u.selector?u.selector(t):u.items,o=u.finally||function(t,e){n(t,e)},o=l.once(o);if(!e)return o(null,t);var i=l.isArray(e);u.before&&u.before(t);var r=[],s=u.iterator;if(i)for(var a=0;a<e.length;a++)r.push(function(n,o){return function(t,e){2===s.length?s(n,e):3===s.length?s(n,o,e):s(n,o,t,e)}}(e[a],a));else for(var c in e)r.push(function(n,o){return function(t,e){2===s.length?s(n,e):3===s.length?s(n,o,e):s(n,o,t,e)}}(e[c],c));p({functions:r,data:t,finally:o,stopOnError:u.stopOnError},n)}}t.sequential=function(t,e){l.isArray(t)&&(t={functions:t}),p(t,e)},t.iterator=function(t,e){e=1==arguments.length?t:{items:t,iterator:e};return o(e)},t.each=function(t,e){o(t)(null,e)},e.exports=t},{"./util.js":184,underscore:185}],177:[function(t,e,n){"use strict";var o=t("underscore"),t={ChildNodeIterator:function(t){o.isArray(t)?this.nodes=t:this.nodes=t.childNodes,this.length=this.nodes.length,this.pos=-1}};t.ChildNodeIterator.prototype={hasNext:function(){return this.pos<this.length-1},next:function(){return this.pos+=1,this.nodes[this.pos]},back:function(){return 0<=this.pos&&--this.pos,this}},t.getChildren=function(t){if(void 0!==t.children)return t.children;for(var e=[],n=t.firstElementChild;n;)e.push(n),n=n.nextElementSibling;return e},t.getNodeType=function(t){return t.nodeType===window.Node.TEXT_NODE?"text":t.nodeType===window.Node.COMMENT_NODE?"comment":t.tagName?t.tagName.toLowerCase():(console.error("Can't get node type for ",t),"unknown")},e.exports=t},{underscore:185}],178:[function(t,e,n){"use strict";var o=t("./util"),a={},c=function(t,e){e?(Error.call(this,t,e.fileName,e.lineNumber),e instanceof c?this.__stack=e.__stack:e.stack?this.__stack=o.parseStackTrace(e):this.__stack=o.callstack(1)):(Error.call(this,t),this.__stack=o.callstack(1)),this.message=t};c.Prototype=function(){this.name="SubstanceError",this.code=-1,this.toString=function(){return this.name+":"+this.message},this.toJSON=function(){return{name:this.name,message:this.message,code:this.code,stack:this.stack}},this.printStackTrace=function(){o.printStackTrace(this)}},c.Prototype.prototype=Error.prototype,c.prototype=new c.Prototype,Object.defineProperty(c.prototype,"stack",{get:function(){for(var t=[],e=0;e<this.__stack.length;e++){var n=this.__stack[e];t.push(n.file+":"+n.line+":"+n.col+" ("+n.func+")")}return t.join("\n")},set:function(){throw new Error("SubstanceError.stack is read-only.")}}),a.SubstanceError=c;a.define=function(t,e,n){if(!t)throw new c("Name is required.");void 0===e&&(e=-1);var o,i,r,s=(i=t,r=e,function(t){o.call(this,t),this.name=i,this.code=r}),e=function(){};return e.prototype=(o=n=n||c).prototype,s.prototype=new e,s.prototype.constructor=s,a[t]=s},e.exports=a},{"./util":184}],179:[function(t,e,n){"use strict";var l=t("underscore"),t=function(t){this.levels=t||{}};t.Prototype=function(){this.onText=function(){},this.onEnter=function(){return null},this.onExit=function(){},this.enter=function(t,e){return this.onEnter(t,e)},this.exit=function(t,e){this.onExit(t,e)},this.createText=function(t,e){this.onText(t,e)},this.start=function(t,e,n){var o=function(t){var n=[];return l.each(t,function(t){var e=this.levels[t.type]||1e3;n.push({pos:t.range[0],mode:1,level:e,id:t.id,type:t.type,node:t}),n.push({pos:t.range[1],mode:-1,level:e,id:t.id,type:t.type,node:t})},this),n}.call(this,n);o.sort(function(t,e){if(t.pos<e.pos)return-1;if(t.pos>e.pos)return 1;if(t.mode<e.mode)return-1;if(t.mode>e.mode)return 1;if(1===t.mode){if(t.level<e.level)return-1;if(t.level>e.level)return 1}if(-1===t.mode){if(t.level>e.level)return-1;if(t.level<e.level)return 1}return 0}.bind(this));for(var i=[{context:t,entry:null}],r=0,s=0;s<o.length;s++){var a=o[s];this.createText(i[i.length-1].context,e.substring(r,a.pos)),r=a.pos;var c,u=1;if(1===a.mode){for(;u<i.length&&!(a.level<i[u].entry.level);u++);i.splice(u,0,{entry:a})}else if(-1===a.mode){for(;u<i.length&&i[u].entry.id!==a.id;u++);for(c=u;c<i.length;c++)this.exit(i[c].entry,i[c-1].context);i.splice(u,1)}for(c=u;c<i.length;c++)i[c].context=this.enter(i[c].entry,i[c-1].context)}this.createText(t,e.substring(r))}},t.prototype=new t.Prototype,e.exports=t},{underscore:185}],180:[function(t,e,n){"use strict";var t=t("underscore"),o=t.map,i=t.each;function r(t){var e={left:Number.POSITIVE_INFINITY,top:Number.POSITIVE_INFINITY,right:Number.NEGATIVE_INFINITY,bottom:Number.NEGATIVE_INFINITY,width:Number.NaN,height:Number.NaN};return i(t,function(t){t.left<e.left&&(e.left=t.left),t.top<e.top&&(e.top=t.top),t.left+t.width>e.right&&(e.right=t.left+t.width),t.top+t.height>e.bottom&&(e.bottom=t.top+t.height)}),e.width=e.right-e.left,e.height=e.bottom-e.top,e}e.exports=function(t,i){void 0===t.length&&(t=[t]);var e=o(t,function(t){return e=t,o=(n=i).getBoundingClientRect(),t=r(e.getClientRects()),n=t.left-o.left,e=t.top-o.top,{left:n,top:e,right:o.width-n-t.width,bottom:o.height-e-t.height,width:t.width,height:t.height};var e,n,o}),t=r(e),e=i.getBoundingClientRect();return{left:t.left,top:t.top,right:e.width-t.left-t.width,bottom:e.height-t.top-t.height,width:t.width,height:t.height}}},{underscore:185}],181:[function(t,e,n){"use strict";var o={},i=t("underscore");o.templates={},o.renderTemplate=function(t,e){return o.templates[t](e)},"undefined"!=typeof window&&(window.console||(window.console={log:function(){}})),o.tpl=function(t,e){e=e||{};t=window.$("script[name="+t+"]").html();return i.template(t,e)},e.exports=o},{underscore:185}],182:[function(t,e,n){"use strict";var o=t("./util");o.async=t("./async"),o.errors=t("./errors"),o.html=t("./html"),o.dom=t("./dom"),o.RegExp=t("./regexp"),o.Fragmenter=t("./fragmenter"),e.exports=o},{"./async":176,"./dom":177,"./errors":178,"./fragmenter":179,"./html":181,"./regexp":183,"./util":184}],183:[function(t,e,n){"use strict";function o(t){this.index=t.index,this.match=[];for(var e=0;e<t.length;e++)this.match.push(t[e])}o.Prototype=function(){this.captures=function(){return this.match.slice(1)},this.toString=function(){return this.match[0]}},o.prototype=new o.Prototype;function i(t){this.exp=t}i.Prototype=function(){this.match=function(t){if(void 0===t)throw new Error("No string given");if(this.exp.global){var e,n=[];for(this.exp.compile(this.exp);null!==(e=this.exp.exec(t));)n.push(new o(e));return n}return this.exp.exec(t)}},i.prototype=new i.Prototype,i.Match=o,e.exports=i},{}],184:[function(o,t,e){"use strict";function i(t,e){var n,o=-1,i=t.length,r=e[0],s=e[1],a=e[2];switch(e.length){case 0:for(;++o<i;)(n=t[o]).callback.call(n.ctx);return;case 1:for(;++o<i;)(n=t[o]).callback.call(n.ctx,r);return;case 2:for(;++o<i;)(n=t[o]).callback.call(n.ctx,r,s);return;case 3:for(;++o<i;)(n=t[o]).callback.call(n.ctx,r,s,a);return;default:for(;++o<i;)(n=t[o]).callback.apply(n.ctx,e)}}function p(t,e,n,o){if(!n)return 1;if("object"!=typeof n){if(!c.test(n))return 1;for(var i=n.split(c),r=0,s=i.length;r<s;r++)t[e].apply(t,[i[r]].concat(o))}else for(var a in n)t[e].apply(t,[a,n[a]].concat(o))}var h=o("underscore"),r={uuid:function(t,e){var n,o,i="0123456789abcdefghijklmnopqrstuvwxyz".split(""),r=[];if(e=e||32,e)for(n=0;n<e;n++)r[n]=i[0|16*Math.random()];else for(r[8]=r[13]=r[18]=r[23]="-",r[14]="4",n=0;n<36;n++)r[n]||(o=0|16*Math.random(),r[n]=i[19==n?3&o|8:o]);return(t||"")+r.join("")},uuidGen:function(e){var n=1;return e=void 0!==e?e:"uuid_",function(t){return(t=t||e)+n++}}},c=/\s+/;r.Events={on:function(t,e,n){return p(this,"on",t,[e,n])&&e&&(this._events=this._events||{},(this._events[t]||(this._events[t]=[])).push({callback:e,context:n,ctx:n||this})),this},once:function(t,e,n){if(!p(this,"once",t,[e,n])||!e)return this;var o=this,i=h.once(function(){o.off(t,i),e.apply(this,arguments)});return i._callback=e,this.on(t,i,n)},off:function(t,e,n){var o,i,r,s,a,c,u,l;if(!this._events||!p(this,"off",t,[e,n]))return this;if(!t&&!e&&!n)return this._events={},this;for(a=0,c=(s=t?[t]:h.keys(this._events)).length;a<c;a++)if(t=s[a],r=this._events[t]){if(this._events[t]=o=[],e||n)for(u=0,l=r.length;u<l;u++)i=r[u],(e&&e!==i.callback&&e!==i.callback._callback||n&&n!==i.context)&&o.push(i);o.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=Array.prototype.slice.call(arguments,1);if(!p(this,"trigger",t,e))return this;var n=this._events[t],t=this._events.all;return n&&i(n,e),t&&i(t,arguments),this},triggerLater:function(){var t=this,e=arguments;window.setTimeout(function(){t.trigger.apply(t,e)},0)},stopListening:function(t,e,n){var o=this._listeners;if(!o)return this;var i,r=!e&&!n;for(i in"object"==typeof e&&(n=this),t&&((o={})[t._listenerId]=t),o)o[i].off(e,n,this),r&&delete this._listeners[i];return this}};h.each({listenTo:"on",listenToOnce:"once"},function(i,t){r.Events[t]=function(t,e,n){var o=this._listeners||(this._listeners={});return"object"==typeof e&&(n=this),(o[t._listenerId||(t._listenerId=h.uniqueId("l"))]=t)[i](e,n,this),this}}),r.Events.bind=r.Events.on,r.Events.unbind=r.Events.off,r.Events.Listener={listenTo:function(t,e,n){if(!h.isFunction(n))throw new Error("Illegal argument: expecting function as callback, was: "+n);return this._handlers=this._handlers||[],t.on(e,n,this),this._handlers.push({unbind:function(){t.off(e,n)}}),this},stopListening:function(){if(this._handlers)for(var t=0;t<this._handlers.length;t++)this._handlers[t].unbind()}},r.propagate=function(e,n){if(!h.isFunction(n))throw"Illegal argument: provided callback is not a function";return function(t){if(t)return n(t);n(null,e)}};function s(){}r.inherits=function(t,e,n){var o=e&&e.hasOwnProperty("constructor")?e.constructor:function(){t.apply(this,arguments)};return h.extend(o,t),s.prototype=t.prototype,o.prototype=new s,e&&h.extend(o.prototype,e),n&&h.extend(o,n),(o.prototype.constructor=o).__super__=t.prototype,o},r.getJSON=function(t,e){var n;"undefined"==typeof window||"undefined"!=typeof nwglobal?(n=o("fs"),n=JSON.parse(n.readFileSync(t,"utf8")),e(null,n)):window.$.getJSON(t).done(function(t){e(null,t)}).error(function(t){e(t,null)})},r.prototype=function(t){return Object.getPrototypeOf?Object.getPrototypeOf(t):t.__proto__},r.inherit=function(t,e){var n=h.isFunction(t)?new t:t,e=h.isFunction(e)?(e.prototype=n,new e):((t=function(){}).prototype=n,h.extend(new t,e));return e},r.pimpl=function(t){function e(t){this.self=t}return e.prototype=t,function(t){return new e(t=t||this)}},r.parseStackTrace=function(t){for(var e=/([^@]*)@(.*):(\d+)/,n=/\s*at ([^(]*)[(](.*):(\d+):(\d+)[)]/,o=t.stack.split("\n"),i=[],r=0;r<o.length;r++){var s,a=e.exec(o[r]);(a=a||n.exec(o[r]))?""===(s={func:a[1],file:a[2],line:a[3],col:a[4]||0}).func&&(s.func="<anonymous>"):s={func:"",file:o[r],line:"",col:""},i.push(s)}return i},r.callstack=function(t){var e;try{throw new Error}catch(t){e=t}return t=t||0,r.parseStackTrace(e).splice(t+1)},r.stacktrace=function(t){var t=0===arguments.length?r.callstack().splice(1):r.parseStackTrace(t),e=[];return h.each(t,function(t){e.push(t.file+":"+t.line+":"+t.col+" ("+t.func+")")}),e.join("\n")},r.printStackTrace=function(t,e){if(t.stack){var n;if(void 0!==t.__stack)n=t.__stack;else{if(!h.isString(t.stack))return;n=r.parseStackTrace(t)}e=e||n.length,e=Math.min(e,n.length);for(var o=0;o<e;o++){var i=n[o];console.log(i.file+":"+i.line+":"+i.col,"("+i.func+")")}}},r.diff=function(n,o){var i;return h.isArray(n)&&h.isArray(o)?0===(i=h.difference(o,n)).length?null:i:h.isObject(n)&&h.isObject(o)?(i={},h.each(Object.keys(o),function(t){var e=r.diff(n[t],o[t]);e&&(i[t]=e)}),h.isEmpty(i)?null:i):n!==o?o:void 0},r.deepclone=function(t){if(void 0!==t)return null===t?null:JSON.parse(JSON.stringify(t))},r.clone=function(t){return null==t?t:h.isFunction(t.clone)?t.clone():r.deepclone(t)},r.freeze=function(t){if(h.isObject(t)){if(Object.isFrozen(t))return t;for(var e=Object.keys(t),n=0;n<e.length;n++){var o=e[n];t[o]=r.freeze(t[o])}return Object.freeze(t)}if(h.isArray(t)){var i=t;for(n=0;n<i.length;n++)i[n]=r.freeze(i[n]);return Object.freeze(i)}return t},r.later=function(e,n){return function(){var t=arguments;window.setTimeout(function(){e.apply(n,t)},0)}},r.isEmpty=function(t){return!t.match(/\w/)},r.slug=function(t){t=(t=t.replace(/^\s+|\s+$/g,"")).toLowerCase();for(var e="/_,:;",n=0,o=e.length;n<o;n++)t=t.replace(new RegExp(e.charAt(n),"g"),"aaaaeeeeiiiioooouuuunc------".charAt(n));return t=t.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-")},r.getReadableFileSizeString=function(t){for(var e=-1;t/=1024,e++,1024<t;);return Math.max(t,.1).toFixed(1)+[" kB"," MB"," GB"," TB","PB","EB","ZB","YB"][e]},t.exports=r},{fs:3,underscore:185}],185:[function(t,i,r){(function(qe){var t,e,n,o;t=this,e=function(){var t="object"==typeof self&&self.self===self&&self||"object"==typeof qe&&qe.global===qe&&qe||Function("return this")()||{},o=Array.prototype,s=Object.prototype,p="undefined"!=typeof Symbol?Symbol.prototype:null,i=o.push,c=o.slice,h=s.toString,n=s.hasOwnProperty,e="undefined"!=typeof ArrayBuffer,r="undefined"!=typeof DataView,a=Array.isArray,u=Object.keys,l=Object.create,d=e&&ArrayBuffer.isView,f=isNaN,g=isFinite,y=!{toString:null}.propertyIsEnumerable("toString"),m=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],v=Math.pow(2,53)-1;function b(i,r){return r=null==r?i.length-1:+r,function(){for(var t=Math.max(arguments.length-r,0),e=Array(t),n=0;n<t;n++)e[n]=arguments[n+r];switch(r){case 0:return i.call(this,e);case 1:return i.call(this,arguments[0],e);case 2:return i.call(this,arguments[0],arguments[1],e)}for(var o=Array(r+1),n=0;n<r;n++)o[n]=arguments[n];return o[r]=e,i.apply(this,o)}}function w(t){var e=typeof t;return"function"==e||"object"==e&&!!t}function _(t){return void 0===t}function x(t){return!0===t||!1===t||"[object Boolean]"===h.call(t)}function C(t){var e="[object "+t+"]";return function(t){return h.call(t)===e}}var P=C("String"),N=C("Number"),T=C("Date"),S=C("RegExp"),k=C("Error"),A=C("Symbol"),V=C("ArrayBuffer"),E=C("Function"),j=t.document&&t.document.childNodes;"function"!=typeof/./&&"object"!=typeof Int8Array&&"function"!=typeof j&&(E=function(t){return"function"==typeof t||!1});var $=E,I=C("Object"),M=r&&I(new DataView(new ArrayBuffer(8))),q="undefined"!=typeof Map&&I(new Map),R=C("DataView");var L=M?function(t){return null!=t&&$(t.getInt8)&&V(t.buffer)}:R,O=a||C("Array");function D(t,e){return null!=t&&n.call(t,e)}var F=C("Arguments");!function(){F(arguments)||(F=function(t){return D(t,"callee")})}();var H=F;function U(t){return N(t)&&f(t)}function B(t){return function(){return t}}function G(e){return function(t){t=e(t);return"number"==typeof t&&0<=t&&t<=v}}function z(e){return function(t){return null==t?void 0:t[e]}}var J=z("byteLength"),W=G(J),X=/\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;var Z=e?function(t){return d?d(t)&&!L(t):W(t)&&X.test(h.call(t))}:B(!1),Y=z("length");function K(t,e){e=function(e){for(var n={},t=e.length,o=0;o<t;++o)n[e[o]]=!0;return{contains:function(t){return n[t]},push:function(t){return n[t]=!0,e.push(t)}}}(e);var n=m.length,o=t.constructor,i=$(o)&&o.prototype||s,r="constructor";for(D(t,r)&&!e.contains(r)&&e.push(r);n--;)(r=m[n])in t&&t[r]!==i[r]&&!e.contains(r)&&e.push(r)}function Q(t){if(!w(t))return[];if(u)return u(t);var e,n=[];for(e in t)D(t,e)&&n.push(e);return y&&K(t,n),n}function tt(t,e){var n=Q(e),o=n.length;if(null==t)return!o;for(var i=Object(t),r=0;r<o;r++){var s=n[r];if(e[s]!==i[s]||!(s in i))return!1}return!0}function et(t){return t instanceof et?t:this instanceof et?void(this._wrapped=t):new et(t)}function nt(t){return new Uint8Array(t.buffer||t,t.byteOffset||0,J(t))}et.VERSION="1.12.1",et.prototype.valueOf=et.prototype.toJSON=et.prototype.value=function(){return this._wrapped},et.prototype.toString=function(){return String(this._wrapped)};var ot="[object DataView]";function it(t,e,n,o){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return!1;if(t!=t)return e!=e;var i=typeof t;return("function"==i||"object"==i||"object"==typeof e)&&function t(e,n,o,i){e instanceof et&&(e=e._wrapped);n instanceof et&&(n=n._wrapped);var r=h.call(e);if(r!==h.call(n))return!1;if(M&&"[object Object]"==r&&L(e)){if(!L(n))return!1;r=ot}switch(r){case"[object RegExp]":case"[object String]":return""+e==""+n;case"[object Number]":return+e!=+e?+n!=+n:0==+e?1/+e==1/n:+e==+n;case"[object Date]":case"[object Boolean]":return+e==+n;case"[object Symbol]":return p.valueOf.call(e)===p.valueOf.call(n);case"[object ArrayBuffer]":case ot:return t(nt(e),nt(n),o,i)}var s="[object Array]"===r;if(!s&&Z(e)){var a=J(e);if(a!==J(n))return!1;if(e.buffer===n.buffer&&e.byteOffset===n.byteOffset)return!0;s=!0}if(!s){if("object"!=typeof e||"object"!=typeof n)return!1;var r=e.constructor,a=n.constructor;if(r!==a&&!($(r)&&r instanceof r&&$(a)&&a instanceof a)&&"constructor"in e&&"constructor"in n)return!1}o=o||[];i=i||[];var c=o.length;for(;c--;)if(o[c]===e)return i[c]===n;o.push(e);i.push(n);if(s){if((c=e.length)!==n.length)return!1;for(;c--;)if(!it(e[c],n[c],o,i))return!1}else{var u,l=Q(e);if(c=l.length,Q(n).length!==c)return!1;for(;c--;)if(u=l[c],!D(n,u)||!it(e[u],n[u],o,i))return!1}o.pop();i.pop();return!0}(t,e,n,o)}function rt(t){if(!w(t))return[];var e,n=[];for(e in t)n.push(e);return y&&K(t,n),n}function st(o){var i=Y(o);return function(t){if(null==t)return!1;var e=rt(t);if(Y(e))return!1;for(var n=0;n<i;n++)if(!$(t[o[n]]))return!1;return o!==pt||!$(t[at])}}var at="forEach",ct=["clear","delete"],ut=["get","has","set"],lt=ct.concat(at,ut),pt=ct.concat(ut),ht=["add"].concat(ct,at,"has"),dt=q?st(lt):C("Map"),ft=q?st(pt):C("WeakMap"),gt=q?st(ht):C("Set"),yt=C("WeakSet");function mt(t){for(var e=Q(t),n=e.length,o=Array(n),i=0;i<n;i++)o[i]=t[e[i]];return o}function vt(t){for(var e={},n=Q(t),o=0,i=n.length;o<i;o++)e[t[n[o]]]=n[o];return e}function bt(t){var e,n=[];for(e in t)$(t[e])&&n.push(e);return n.sort()}function wt(c,u){return function(t){var e=arguments.length;if(u&&(t=Object(t)),e<2||null==t)return t;for(var n=1;n<e;n++)for(var o=arguments[n],i=c(o),r=i.length,s=0;s<r;s++){var a=i[s];u&&void 0!==t[a]||(t[a]=o[a])}return t}}var _t=wt(rt),xt=wt(Q),Ct=wt(rt,!0);function Pt(t){if(!w(t))return{};if(l)return l(t);var e=function(){};e.prototype=t;t=new e;return e.prototype=null,t}function Nt(t){return w(t)?O(t)?t.slice():_t({},t):t}function Tt(t){return O(t)?t:[t]}function St(t){return et.toPath(t)}function kt(t,e){for(var n=e.length,o=0;o<n;o++){if(null==t)return;t=t[e[o]]}return n?t:void 0}function At(t,e,n){e=kt(t,St(e));return _(e)?n:e}function Vt(t){return t}function Et(e){return e=xt({},e),function(t){return tt(t,e)}}function jt(e){return e=St(e),function(t){return kt(t,e)}}function $t(i,r,t){if(void 0===r)return i;switch(null==t?3:t){case 1:return function(t){return i.call(r,t)};case 3:return function(t,e,n){return i.call(r,t,e,n)};case 4:return function(t,e,n,o){return i.call(r,t,e,n,o)}}return function(){return i.apply(r,arguments)}}function It(t,e,n){return null==t?Vt:$(t)?$t(t,e,n):(w(t)&&!O(t)?Et:jt)(t)}function Mt(t,e){return It(t,e,1/0)}function qt(t,e,n){return et.iteratee!==Mt?et.iteratee(t,e):It(t,e,n)}function Rt(){}function Lt(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))}et.toPath=Tt,et.iteratee=Mt;var Ot=Date.now||function(){return(new Date).getTime()};function Dt(e){function n(t){return e[t]}var t="(?:"+Q(e).join("|")+")",o=RegExp(t),i=RegExp(t,"g");return function(t){return t=null==t?"":""+t,o.test(t)?t.replace(i,n):t}}var Ft={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},Ht=Dt(Ft),Ut=Dt(vt(Ft)),Bt=et.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},Gt=/(.)^/,zt={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},Jt=/\\|'|\r|\n|\u2028|\u2029/g;function Wt(t){return"\\"+zt[t]}var Xt=/^\s*(\w|\$)+\s*$/;var Zt=0;function Yt(t,e,n,o,i){if(!(o instanceof e))return t.apply(n,i);n=Pt(t.prototype),i=t.apply(n,i);return w(i)?i:n}var Kt=b(function(i,r){var s=Kt.placeholder,a=function(){for(var t=0,e=r.length,n=Array(e),o=0;o<e;o++)n[o]=r[o]===s?arguments[t++]:r[o];for(;t<arguments.length;)n.push(arguments[t++]);return Yt(i,a,this,this,n)};return a});Kt.placeholder=et;var Qt=b(function(e,n,o){if(!$(e))throw new TypeError("Bind must be called on a function");var i=b(function(t){return Yt(e,i,n,this,o.concat(t))});return i}),te=G(Y);function ee(t,e,n,o){if(o=o||[],e||0===e){if(e<=0)return o.concat(t)}else e=1/0;for(var i=o.length,r=0,s=Y(t);r<s;r++){var a=t[r];if(te(a)&&(O(a)||H(a)))if(1<e)ee(a,e-1,n,o),i=o.length;else for(var c=0,u=a.length;c<u;)o[i++]=a[c++];else n||(o[i++]=a)}return o}var ne=b(function(t,e){var n=(e=ee(e,!1,!1)).length;if(n<1)throw new Error("bindAll must be passed function names");for(;n--;){var o=e[n];t[o]=Qt(t[o],t)}return t});var oe=b(function(t,e,n){return setTimeout(function(){return t.apply(null,n)},e)}),ie=Kt(oe,et,1);function re(t){return function(){return!t.apply(this,arguments)}}function se(t,e){var n;return function(){return 0<--t&&(n=e.apply(this,arguments)),t<=1&&(e=null),n}}t=Kt(se,2);function ae(t,e,n){e=qt(e,n);for(var o,i=Q(t),r=0,s=i.length;r<s;r++)if(e(t[o=i[r]],o,t))return o}function ce(r){return function(t,e,n){e=qt(e,n);for(var o=Y(t),i=0<r?0:o-1;0<=i&&i<o;i+=r)if(e(t[i],i,t))return i;return-1}}var ue=ce(1),j=ce(-1);function le(t,e,n,o){for(var i=(n=qt(n,o,1))(e),r=0,s=Y(t);r<s;){var a=Math.floor((r+s)/2);n(t[a])<i?r=a+1:s=a}return r}function pe(r,s,a){return function(t,e,n){var o=0,i=Y(t);if("number"==typeof n)0<r?o=0<=n?n:Math.max(n+i,o):i=0<=n?Math.min(n+1,i):n+i+1;else if(a&&n&&i)return t[n=a(t,e)]===e?n:-1;if(e!=e)return 0<=(n=s(c.call(t,o,i),U))?n+o:-1;for(n=0<r?o:i-1;0<=n&&n<i;n+=r)if(t[n]===e)return n;return-1}}var he=pe(1,ue,le),E=pe(-1,j);function de(t,e,n){n=(te(t)?ue:ae)(t,e,n);if(void 0!==n&&-1!==n)return t[n]}function fe(t,e,n){if(e=$t(e,n),te(t))for(i=0,r=t.length;i<r;i++)e(t[i],i,t);else for(var o=Q(t),i=0,r=o.length;i<r;i++)e(t[o[i]],o[i],t);return t}function ge(t,e,n){e=qt(e,n);for(var o=!te(t)&&Q(t),i=(o||t).length,r=Array(i),s=0;s<i;s++){var a=o?o[s]:s;r[s]=e(t[a],a,t)}return r}function ye(c){return function(t,e,n,o){var i=3<=arguments.length;return function(t,e,n,o){var i=!te(t)&&Q(t),r=(i||t).length,s=0<c?0:r-1;for(o||(n=t[i?i[s]:s],s+=c);0<=s&&s<r;s+=c){var a=i?i[s]:s;n=e(n,t[a],a,t)}return n}(t,$t(e,o,4),n,i)}}r=ye(1),I=ye(-1);function me(t,o,e){var i=[];return o=qt(o,e),fe(t,function(t,e,n){o(t,e,n)&&i.push(t)}),i}function ve(t,e,n){e=qt(e,n);for(var o=!te(t)&&Q(t),i=(o||t).length,r=0;r<i;r++){var s=o?o[r]:r;if(!e(t[s],s,t))return!1}return!0}function be(t,e,n){e=qt(e,n);for(var o=!te(t)&&Q(t),i=(o||t).length,r=0;r<i;r++){var s=o?o[r]:r;if(e(t[s],s,t))return!0}return!1}function we(t,e,n,o){return te(t)||(t=mt(t)),"number"==typeof n&&!o||(n=0),0<=he(t,e,n)}R=b(function(t,n,o){var i,r;return $(n)?r=n:(n=St(n),i=n.slice(0,-1),n=n[n.length-1]),ge(t,function(t){var e=r;if(!e){if(i&&i.length&&(t=kt(t,i)),null==t)return;e=t[n]}return null==e?e:e.apply(t,o)})});function _e(t,e){return ge(t,jt(e))}function xe(t,o,e){var n,i,r=-1/0,s=-1/0;if(null==o||"number"==typeof o&&"object"!=typeof t[0]&&null!=t)for(var a=0,c=(t=te(t)?t:mt(t)).length;a<c;a++)null!=(n=t[a])&&r<n&&(r=n);else o=qt(o,e),fe(t,function(t,e,n){i=o(t,e,n),(s<i||i===-1/0&&r===-1/0)&&(r=t,s=i)});return r}function Ce(t,e,n){if(null==e||n)return te(t)||(t=mt(t)),t[Lt(t.length-1)];var o=(te(t)?Nt:mt)(t),t=Y(o);e=Math.max(Math.min(e,t),0);for(var i=t-1,r=0;r<e;r++){var s=Lt(r,i),a=o[r];o[r]=o[s],o[s]=a}return o.slice(0,e)}function Pe(r,e){return function(n,o,t){var i=e?[[],[]]:{};return o=qt(o,t),fe(n,function(t,e){e=o(t,e,n);r(i,t,e)}),i}}var a=Pe(function(t,e,n){D(t,n)?t[n].push(e):t[n]=[e]}),e=Pe(function(t,e,n){t[n]=e}),ut=Pe(function(t,e,n){D(t,n)?t[n]++:t[n]=1}),ct=Pe(function(t,e,n){t[n?0:1].push(e)},!0),Ne=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;function Te(t,e,n){return e in n}var Se=b(function(t,e){var n={},o=e[0];if(null==t)return n;$(o)?(1<e.length&&(o=$t(o,e[1])),e=rt(t)):(o=Te,e=ee(e,!1,!1),t=Object(t));for(var i=0,r=e.length;i<r;i++){var s=e[i],a=t[s];o(a,s,t)&&(n[s]=a)}return n}),lt=b(function(t,n){var e,o=n[0];return $(o)?(o=re(o),1<n.length&&(e=n[1])):(n=ge(ee(n,!1,!1),String),o=function(t,e){return!we(n,e)}),Se(t,o,e)});function ke(t,e,n){return c.call(t,0,Math.max(0,t.length-(null==e||n?1:e)))}function Ae(t,e,n){return null==t||t.length<1?null==e||n?void 0:[]:null==e||n?t[0]:ke(t,t.length-e)}function Ve(t,e,n){return c.call(t,null==e||n?1:e)}var Ee=b(function(t,e){return e=ee(e,!0,!0),me(t,function(t){return!we(e,t)})}),q=b(function(t,e){return Ee(t,e)});function je(t,e,n,o){x(e)||(o=n,n=e,e=!1),null!=n&&(n=qt(n,o));for(var i=[],r=[],s=0,a=Y(t);s<a;s++){var c=t[s],u=n?n(c,s,t):c;e&&!n?(s&&r===u||i.push(c),r=u):n?we(r,u)||(r.push(u),i.push(c)):we(i,c)||i.push(c)}return i}ht=b(function(t){return je(ee(t,!0,!0))});function $e(t){for(var e=t&&xe(t,Y).length||0,n=Array(e),o=0;o<e;o++)n[o]=_e(t,o);return n}Ft=b($e);function Ie(t,e){return t._chain?et(e).chain():e}function Me(n){return fe(bt(n),function(t){var e=et[t]=n[t];et.prototype[t]=function(){var t=[this._wrapped];return i.apply(t,arguments),Ie(this,e.apply(et,t))}}),et}fe(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var n=o[e];et.prototype[e]=function(){var t=this._wrapped;return null!=t&&(n.apply(t,arguments),"shift"!==e&&"splice"!==e||0!==t.length||delete t[0]),Ie(this,t)}}),fe(["concat","join","slice"],function(t){var e=o[t];et.prototype[t]=function(){var t=this._wrapped;return null!=t&&(t=e.apply(t,arguments)),Ie(this,t)}});Ft=Me({__proto__:null,VERSION:"1.12.1",restArguments:b,isObject:w,isNull:function(t){return null===t},isUndefined:_,isBoolean:x,isElement:function(t){return!(!t||1!==t.nodeType)},isString:P,isNumber:N,isDate:T,isRegExp:S,isError:k,isSymbol:A,isArrayBuffer:V,isDataView:L,isArray:O,isFunction:$,isArguments:H,isFinite:function(t){return!A(t)&&g(t)&&!isNaN(parseFloat(t))},isNaN:U,isTypedArray:Z,isEmpty:function(t){if(null==t)return!0;var e=Y(t);return"number"==typeof e&&(O(t)||P(t)||H(t))?0===e:0===Y(Q(t))},isMatch:tt,isEqual:function(t,e){return it(t,e)},isMap:dt,isWeakMap:ft,isSet:gt,isWeakSet:yt,keys:Q,allKeys:rt,values:mt,pairs:function(t){for(var e=Q(t),n=e.length,o=Array(n),i=0;i<n;i++)o[i]=[e[i],t[e[i]]];return o},invert:vt,functions:bt,methods:bt,extend:_t,extendOwn:xt,assign:xt,defaults:Ct,create:function(t,e){return t=Pt(t),e&&xt(t,e),t},clone:Nt,tap:function(t,e){return e(t),t},get:At,has:function(t,e){for(var n=(e=St(e)).length,o=0;o<n;o++){var i=e[o];if(!D(t,i))return!1;t=t[i]}return!!n},mapObject:function(t,e,n){e=qt(e,n);for(var o=Q(t),i=o.length,r={},s=0;s<i;s++){var a=o[s];r[a]=e(t[a],a,t)}return r},identity:Vt,constant:B,noop:Rt,toPath:Tt,property:jt,propertyOf:function(e){return null==e?Rt:function(t){return At(e,t)}},matcher:Et,matches:Et,times:function(t,e,n){var o=Array(Math.max(0,t));e=$t(e,n,1);for(var i=0;i<t;i++)o[i]=e(i);return o},random:Lt,now:Ot,escape:Ht,unescape:Ut,templateSettings:Bt,template:function(r,t,e){!t&&e&&(t=e),t=Ct({},t,et.templateSettings);var e=RegExp([(t.escape||Gt).source,(t.interpolate||Gt).source,(t.evaluate||Gt).source].join("|")+"|$","g"),s=0,a="__p+='";r.replace(e,function(t,e,n,o,i){return a+=r.slice(s,i).replace(Jt,Wt),s=i+t.length,e?a+="'+\n((__t=("+e+"))==null?'':_.escape(__t))+\n'":n?a+="'+\n((__t=("+n+"))==null?'':__t)+\n'":o&&(a+="';\n"+o+"\n__p+='"),t}),a+="';\n";var n,o=t.variable;if(o){if(!Xt.test(o))throw new Error(o)}else a="with(obj||{}){\n"+a+"}\n",o="obj";a="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{n=new Function(o,"_",a)}catch(t){throw t.source=a,t}return(t=function(t){return n.call(this,t,et)}).source="function("+o+"){\n"+a+"}",t},result:function(t,e,n){var o=(e=St(e)).length;if(!o)return $(n)?n.call(t):n;for(var i=0;i<o;i++){var r=null==t?void 0:t[e[i]];void 0===r&&(r=n,i=o),t=$(r)?r.call(t):r}return t},uniqueId:function(t){var e=++Zt+"";return t?t+e:e},chain:function(t){return(t=et(t))._chain=!0,t},iteratee:Mt,partial:Kt,bind:Qt,bindAll:ne,memoize:function(o,i){var r=function(t){var e=r.cache,n=""+(i?i.apply(this,arguments):t);return D(e,n)||(e[n]=o.apply(this,arguments)),e[n]};return r.cache={},r},delay:oe,defer:ie,throttle:function(n,o,i){var r,s,a,c,u=0;function l(){u=!1===i.leading?0:Ot(),r=null,c=n.apply(s,a),r||(s=a=null)}function t(){var t=Ot();u||!1!==i.leading||(u=t);var e=o-(t-u);return s=this,a=arguments,e<=0||o<e?(r&&(clearTimeout(r),r=null),u=t,c=n.apply(s,a),r||(s=a=null)):r||!1===i.trailing||(r=setTimeout(l,e)),c}return i=i||{},t.cancel=function(){clearTimeout(r),u=0,r=s=a=null},t},debounce:function(e,n,o){var i,r,s,a,c,u=function(){var t=Ot()-r;t<n?i=setTimeout(u,n-t):(i=null,o||(a=e.apply(c,s)),i||(s=c=null))},t=b(function(t){return c=this,s=t,r=Ot(),i||(i=setTimeout(u,n),o&&(a=e.apply(c,s))),a});return t.cancel=function(){clearTimeout(i),i=s=c=null},t},wrap:function(t,e){return Kt(e,t)},negate:re,compose:function(){var n=arguments,o=n.length-1;return function(){for(var t=o,e=n[o].apply(this,arguments);t--;)e=n[t].call(this,e);return e}},after:function(t,e){return function(){if(--t<1)return e.apply(this,arguments)}},before:se,once:t,findKey:ae,findIndex:ue,findLastIndex:j,sortedIndex:le,indexOf:he,lastIndexOf:E,find:de,detect:de,findWhere:function(t,e){return de(t,Et(e))},each:fe,forEach:fe,map:ge,collect:ge,reduce:r,foldl:r,inject:r,reduceRight:I,foldr:I,filter:me,select:me,reject:function(t,e,n){return me(t,re(qt(e)),n)},every:ve,all:ve,some:be,any:be,contains:we,includes:we,include:we,invoke:R,pluck:_e,where:function(t,e){return me(t,Et(e))},max:xe,min:function(t,o,e){var n,i,r=1/0,s=1/0;if(null==o||"number"==typeof o&&"object"!=typeof t[0]&&null!=t)for(var a=0,c=(t=te(t)?t:mt(t)).length;a<c;a++)null!=(n=t[a])&&n<r&&(r=n);else o=qt(o,e),fe(t,function(t,e,n){((i=o(t,e,n))<s||i===1/0&&r===1/0)&&(r=t,s=i)});return r},shuffle:function(t){return Ce(t,1/0)},sample:Ce,sortBy:function(t,o,e){var i=0;return o=qt(o,e),_e(ge(t,function(t,e,n){return{value:t,index:i++,criteria:o(t,e,n)}}).sort(function(t,e){var n=t.criteria,o=e.criteria;if(n!==o){if(o<n||void 0===n)return 1;if(n<o||void 0===o)return-1}return t.index-e.index}),"value")},groupBy:a,indexBy:e,countBy:ut,partition:ct,toArray:function(t){return t?O(t)?c.call(t):P(t)?t.match(Ne):te(t)?ge(t,Vt):mt(t):[]},size:function(t){return null==t?0:(te(t)?t:Q(t)).length},pick:Se,omit:lt,first:Ae,head:Ae,take:Ae,initial:ke,last:function(t,e,n){return null==t||t.length<1?null==e||n?void 0:[]:null==e||n?t[t.length-1]:Ve(t,Math.max(0,t.length-e))},rest:Ve,tail:Ve,drop:Ve,compact:function(t){return me(t,Boolean)},flatten:function(t,e){return ee(t,e,!1)},without:q,uniq:je,unique:je,union:ht,intersection:function(t){for(var e=[],n=arguments.length,o=0,i=Y(t);o<i;o++){var r=t[o];if(!we(e,r)){for(var s=1;s<n&&we(arguments[s],r);s++);s===n&&e.push(r)}}return e},difference:Ee,unzip:$e,transpose:$e,zip:Ft,object:function(t,e){for(var n={},o=0,i=Y(t);o<i;o++)e?n[t[o]]=e[o]:n[t[o][0]]=t[o][1];return n},range:function(t,e,n){null==e&&(e=t||0,t=0),n=n||(e<t?-1:1);for(var o=Math.max(Math.ceil((e-t)/n),0),i=Array(o),r=0;r<o;r++,t+=n)i[r]=t;return i},chunk:function(t,e){if(null==e||e<1)return[];for(var n=[],o=0,i=t.length;o<i;)n.push(c.call(t,o,o+=e));return n},mixin:Me,default:et});return Ft._=Ft},"object"==typeof r&&void 0!==i?i.exports=e():"function"==typeof define&&define.amd?define("underscore",e):(t=t||self,n=t._,(o=t._=e()).noConflict=function(){return t._=n,o})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1]);